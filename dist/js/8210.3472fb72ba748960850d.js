"use strict";(self.webpackChunkdt_em_front=self.webpackChunkdt_em_front||[]).push([[8210],{12903:(e,t,n)=>{n.r(t),n.d(t,{getClusterList:()=>K,getClusterProductList:()=>A,getInstanceList:()=>U,getParentProductList:()=>O,getProductList:()=>G,getServiceGroupList:()=>F,setCurrentParentCluster:()=>B,setCurrentParentProduct:()=>R,setCurrentProduct:()=>V});var a=n(94198),r=n.n(a),o=n(78914),s=n.n(o),l=n(86902),i=n.n(l),c=n(94473),u=n.n(c),p=n(33032),d=n.n(p),f=n(51942),m=n.n(f),h=n(3649),v=n.n(h),g=n(66419),y=n.n(g),S=n(65420),Z=n.n(S),E=n(19996),P=n.n(E),C=n(41511),I=n.n(C),_=n(45360),b=n(19528),k=n(56466),N=n(78241),D=n(36808),w=n(18274),L=n(64143);function x(e,t){var n=void 0!==Z()&&P()(e)||e["@@iterator"];if(!n){if(I()(e)||(n=function(e,t){var n;if(!e)return;if("string"==typeof e)return T(e,t);var a=v()(n=Object.prototype.toString.call(e)).call(n,8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return y()(e);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return T(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var a=0,r=function(){};return{s:r,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,l=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){l=!0,o=e},f:function(){try{s||null==n.return||n.return()}finally{if(l)throw o}}}}function T(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,a=new Array(t);n<t;n++)a[n]=e[n];return a}var O=function(e){return function(t){b.t6.getParentProductList({limit:0}).then((function(n){if(0===(n=n.data).code){var a={name:n.data[0],list:n.dsta},o=-1;if(e){for(var s in n.data)n.data[s]===e&&(o=r()(s,10));a.name=o>-1?n.data[o]:n.data[0]}D.set("em_current_parent_product",a.name),t({type:k.kP.GET_PARENT_PROD_LIST,payload:a})}}))}},A=function(){return function(e){b.t6.getClusterProductList({limit:0}).then((function(t){if(0===(t=t.data).code){var n,a,r,o,l,c,p,f=D.get("em_current_parent_product")||"DTinsight",h=D.get("em_current_cluster_id"),v={};if(h){var g,y,S=u()(g=t.data).call(g,(function(e){return+e.clusterId==+h}));if(v=S||t.data[0],!S&&"kubernetes"===(null===(y=v)||void 0===y?void 0:y.clusterType)){var Z=_.Z.loading("正在跳转默认集群...",0);d()(Z,2500),L.Z.setNaviKey("menu_ops_center","sub_menu_service"),window.location.href="/opscenter/service"}}else v=t.data[0];var E,P,C,I=function(e,t,n){if(0===n)return D.set(w.E9.NAMESPACE,""),e||t[0];var a,r=!1;if(s()(a=i()(t)).call(a,(function(n){var a;s()(a=t[n]||[]).call(a,(function(t){r||t!==e||D.get(w.E9.NAMESPACE)||(r=!0,D.set(w.E9.NAMESPACE,n))}))})),r||D.get(w.E9.NAMESPACE))return e;var o=i()(t)[0];return D.set(w.E9.NAMESPACE,o),t[i()(t)[0]][0]}(f,(null===(n=v)||void 0===n?void 0:n.subdomain)||{},null===(a=v)||void 0===a?void 0:a.mode);if(null!==(r=v)&&void 0!==r&&r.clusterId)if(D.set("em_current_cluster_id",(null===(E=v)||void 0===E?void 0:E.clusterId)||-1),D.set("em_current_cluster_type",null===(P=v)||void 0===P?void 0:P.clusterType),D.set("em_current_parent_product",I),"kubernetes"===(null===(C=v)||void 0===C?void 0:C.clusterType)){var b,N=i()(null===(b=v)||void 0===b?void 0:b.subdomain);D.set("em_current_k8s_namespace",N[0])}e({type:k.kP.GET_PARENT_PROD_LIST,payload:m()({},{name:I||"选择产品",list:t.data,cluster:{id:(null===(o=v)||void 0===o?void 0:o.clusterId)||-1,name:(null===(l=v)||void 0===l?void 0:l.clusterName)||"选择集群",type:(null===(c=v)||void 0===c?void 0:c.clusterType)||"hosts",mode:(null===(p=v)||void 0===p?void 0:p.mode)||0}})})}}))}},G=function(){return function(e){N.get("/api/v2/product",{limit:0}).then((function(t){var n=[];if(0===(t=t.data).code){var a,r=x(t.data.list);try{for(r.s();!(a=r.n()).done;){var o=a.value;1===o.is_current_version&&n.push(o)}}catch(e){r.e(e)}finally{r.f()}e({type:k.kP.SET_PRODUCT_LIST,payload:n})}else _.Z.error(t.msg)}))}},V=function(e){return{type:k.kP.SET_CUR_PRODUCT,payload:e}},R=function(e){return{type:k.kP.SET_CUR_PARENT_PROD,payload:e}},F=function(){return function(e){N.get("/api/container/getCluster",{}).then((function(t){for(var n=(t=t.data).result.data||[],a=0,r=n.length;a<r;a++){for(var o=n[a].services,s=[],l=0,i=o.length;l<i;l++){var c=o[l],u=c.name.toLowerCase();"rabbitmq"!==u&&"mysql"!==u&&s.push(c)}n[a].services=s}e({type:k.kP.GET_S_G_LIST,payload:n})}))}},U=function(){return function(e){N.get("/api/container/queryContainer",{pageSize:200}).then((function(t){t=t.data,e({type:k.kP.GET_INSTANCE_LIST,payload:t.result.data})}))}},K=function(e){return function(e){b.t6.getClusterList({type:void 0,"sort-by":"id","sort-dir":"desc",limit:0,start:0}).then((function(t){if(0===(t=t.data).code){var n;e({type:k.kP.GET_PARENT_CLUSTER_LIST,payload:t.data.clusters});var a=t.data.clusters[0],r=D.get("em_current_cluster_id"),o=r&&u()(n=t.data.clusters).call(n,(function(e){return e.id===+r}))||a;e({type:k.kP.SET_CUR_PARENT_CLUSTER,payload:o}),D.set("em_current_cluster_id",o.id),D.set("em_current_cluster_type",o.type)}else _.Z.error(t.msg)}))}},B=function(e){return{type:k.kP.SET_CUR_PARENT_CLUSTER,payload:e}}},90143:(e,t,n)=>{n.d(t,{Z:()=>w});var a=n(86902),r=n.n(a),o=n(14310),s=n.n(o),l=n(20116),i=n.n(l),c=n(34074),u=n.n(c),p=n(78914),d=n.n(p),f=n(39649),m=n.n(f),h=n(20368),v=n.n(h),g=n(63978),y=n.n(g),S=n(44845),Z=n(95266),E=n(67294),P=n(97183),C=n(30258),I=n(11382),_=n(87763);n(94199);function b(e,t){var n=r()(e);if(s()){var a=s()(e);t&&(a=i()(a).call(a,(function(t){return u()(e,t).enumerable}))),n.push.apply(n,a)}return n}var k=P.Z.Sider,N=P.Z.Content,D=null;const w=function(e){var t=e.visible,n=e.title,a=e.data,r=e.extra,o=e.handleCancle,s=e.handleSubmit,l=(0,E.useState)(!1),i=(0,Z.Z)(l,2),c=i[0],p=i[1],f=939+(r?125:0),h=(0,E.useRef)(null),g={language:"yaml",folding:!0,readOnly:!0};return(0,E.useEffect)((function(){if(h.current){p(!0);var e=(0,Z.Z)(a,2),t=e[0],n=e[1];D=_.editor.createDiffEditor(h.current,function(e){for(var t=1;t<arguments.length;t++){var n,a,r=null!=arguments[t]?arguments[t]:{};t%2?d()(n=b(Object(r),!0)).call(n,(function(t){(0,S.Z)(e,t,r[t])})):m()?v()(e,m()(r)):d()(a=b(Object(r))).call(a,(function(t){y()(e,t,u()(r,t))}))}return e}({},g)),p(!1);var r=_.editor.createModel(t,"text/plain"),o=_.editor.createModel(n,"text/plain");D.setModel({original:r,modified:o})}}),[h.current]),(0,E.useEffect)((function(){if(D){var e=(0,Z.Z)(a,2),t=e[0],n=e[1],r=D.getModel(),o=r.original,s=r.modified;(null==o?void 0:o.getValue())!==t&&(null==o||o.setValue(t||"")),(null==s?void 0:s.getValue())!==n&&(null==s||s.setValue(n||""))}}),[D,a]),E.createElement(C.Z,{className:"code-diff__wrapper",title:n,width:f,visible:t,onCancel:o,onOk:s},E.createElement(P.Z,null,r&&E.createElement(k,{width:125},r),E.createElement(N,null,E.createElement("div",{className:"ace-title"},E.createElement("div",{className:"title"},"当前版本"),E.createElement("div",{className:"title"},"最新修改")),E.createElement(I.Z,{spinning:c,tip:"正在初始化..."},E.createElement("div",{ref:h,style:{height:500}})))))}},88081:(e,t,n)=>{n.d(t,{Z:()=>y});var a=n(1068),r=n.n(a),o=n(68420),s=n(27344),l=n(5281),i=n(84441),c=n(3020),u=n(3362),p=n(44845),d=n(77766),f=n.n(d),m=n(67294),h=n(28568),v=n(45360);function g(e){var t=function(){if("undefined"==typeof Reflect||!r())return!1;if(r().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(r()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,u.Z)(e);if(t){var o=(0,u.Z)(this).constructor;n=r()(a,arguments,o)}else n=a.apply(this,arguments);return(0,c.Z)(this,n)}}var y=function(e){(0,i.Z)(n,e);var t=g(n);function n(){var e,a;(0,o.Z)(this,n);for(var r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return a=t.call.apply(t,f()(e=[this]).call(e,s)),(0,p.Z)((0,l.Z)(a),"state",{fileContent:"",fileViewShow:!1}),(0,p.Z)((0,l.Z)(a),"ws",void 0),(0,p.Z)((0,l.Z)(a),"handleShowLog",(function(e){e.preventDefault(),a.setState({fileViewShow:!0},(function(){a.websocketLink()}))})),(0,p.Z)((0,l.Z)(a),"websocketLink",(function(){var e=!1,t=a.props.wsUrl;a.ws=new WebSocket(t),a.ws.onmessage=function(e){a.setState({fileContent:e.data})},a.ws.onerror=function(t){e=!0,v.Z.error("实时日志获取失败！")},a.ws.onclose=function(){a.state.fileViewShow&&!e&&a.websocketLink()}})),a}return(0,s.Z)(n,[{key:"render",value:function(){var e=this,t=this.state,n=t.fileViewShow,a=t.fileContent;return m.createElement(m.Fragment,null,m.createElement("a",{style:{fontSize:"12px",display:"inline-block",marginTop:"10px"},onClick:this.handleShowLog},"查看完整日志"),n&&m.createElement(h.Z,{title:"日志",serviceData:null,maskClosable:!0,visible:n,content:a,fileGoBottom:!0,loading:!0,onCancel:function(){e.setState({fileViewShow:!1,fileContent:""},(function(){e.ws.close()}))}}))}}]),n}(m.PureComponent)},28568:(e,t,n)=>{n.d(t,{Z:()=>N});var a=n(1068),r=n.n(a),o=n(68420),s=n(27344),l=n(5281),i=n(84441),c=n(3020),u=n(3362),p=n(44845),d=n(2991),f=n.n(d),m=n(25843),h=n.n(m),v=n(77766),g=n.n(v),y=n(67294),S=n(34041),Z=n(85733),E=n(30258),P=n(31097),C=n(4107),I=n(67908);function _(e){var t=function(){if("undefined"==typeof Reflect||!r())return!1;if(r().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(r()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,u.Z)(e);if(t){var o=(0,u.Z)(this).constructor;n=r()(a,arguments,o)}else n=a.apply(this,arguments);return(0,c.Z)(this,n)}}var b=S.Z.Option,k=Z.Z.TreeNode,N=function(e){(0,i.Z)(n,e);var t=_(n);function n(e){var a;return(0,o.Z)(this,n),a=t.call(this,e),(0,p.Z)((0,l.Z)(a),"state",{first_logfile:"",second_logfile:"",show_second_select:!1,second_logs:[],log_message:"",lineNum:"200",searchText:"",sourceText:"",query:""}),(0,p.Z)((0,l.Z)(a),"onSearch",(function(e){a.setState({query:e},(function(){a.setLogMessage(a.props.content,!1)}))})),(0,p.Z)((0,l.Z)(a),"setContent",(function(e){var t=a.setQueryKey(e),n=new RegExp(/([\S ]*ERROR[\S ]*)/,"gi");return t.replace(n,'<span style="color: red">$1</span>')})),(0,p.Z)((0,l.Z)(a),"setQueryKey",(function(e){var t=a.state.query;if(""===t)return e;var n=t.toLowerCase(),r=new RegExp("(".concat(n,")"),"gi");return e.replace(r,'<span style="color: #2391F7">$1</span>')})),(0,p.Z)((0,l.Z)(a),"setLogMessage",(function(e,t){var n=a.props.fileGoBottom,r=document.getElementById("textPre");r&&(r.innerHTML=a.setContent(e||""),(void 0===t?n:t)&&document.getElementsByClassName("log-message-box").length>0&&document.getElementsByClassName("log-message-box")[0].scrollTo(0,r.offsetHeight))})),(0,p.Z)((0,l.Z)(a),"renderServiceSelect",(function(){var e=a.props,t=e.serviceData,n=e.onSelectedService;return y.createElement(Z.Z,{showSearch:!0,style:{width:200,marginRight:10},dropdownStyle:{maxHeight:400,overflow:"auto"},placeholder:"按服务搜索",allowClear:!0,treeDefaultExpandAll:!0,onChange:n},function(e){var t=[],n=function(n){if(Object.prototype.hasOwnProperty.call(e,n)){var a=e[n];t.push(y.createElement(k,{value:n,title:n,key:n,selectable:!1},a&&f()(a).call(a,(function(e){return y.createElement(k,{isLeaf:!0,value:e.service_name,title:e.service_name_display,key:n+"-"+e.service_name})}))))}};for(var a in e)n(a);return t}(t))})),a}return(0,s.Z)(n,[{key:"componentDidMount",value:function(){this.setLogMessage(this.props.content)}},{key:"componentDidUpdate",value:function(e,t){var n=document.getElementById("textPre");this.props.content===e.content&&this.props.content&&!n.innerHTML&&this.setLogMessage(this.props.content),this.props.content!==e.content&&this.setLogMessage(this.props.content)}},{key:"render",value:function(){var e=this.props,t=e.visible,n=e.onCancel,a=e.title,r=e.maskClosable,o=e.onSelectedFile,s=e.fileList,l=e.content,i=e.selectedFile,c=e.serviceData,u=e.loading;return y.createElement(E.Z,{className:"logtail-box",destroyOnClose:!0,title:a,footer:null,width:800,visible:t,maskClosable:r,onCancel:n},y.createElement("div",{className:"logtail-box"},y.createElement("div",{className:"option-bar",style:{display:"flex"}},c&&y.createElement("span",null,this.renderServiceSelect()),s?y.createElement(S.Z,{allowClear:!0,showSearch:!0,placeholder:"选择文件",value:i,style:{width:200,marginBottom:10,marginRight:10},onChange:o},f()(s).call(s,(function(e,t){var n,a=h()(e).call(e);return y.createElement(b,{key:g()(n="".concat(a,"-")).call(n,t),value:a},y.createElement(P.Z,{title:a},a))}))):null,y.createElement(C.Z.Search,{placeholder:"输入关键词",style:{width:200,marginBottom:10},onSearch:this.onSearch})),y.createElement("div",{className:"log-message-box",style:{height:"400px",paddingTop:"10px",overflowY:"auto",backgroundColor:"#F5F5F5",border:"1px dashed #DDDDDD"}},l?y.createElement("pre",{id:"textPre",style:{paddingLeft:10,height:"auto"}}):null,""===l?y.createElement("div",{style:{lineHeight:"380px",color:"#dddddd",textAlign:"center"}},"没有记录"):null,null===l?y.createElement("div",{style:{lineHeight:"380px",color:"#dddddd",textAlign:"center"}},"请选择上方过滤条件"):null,u&&l&&y.createElement(I.Z,{className:"ml-10",type:"loading"}))))}}]),n}(y.Component)},65778:(e,t,n)=>{n.d(t,{Z:()=>T});var a=n(1068),r=n.n(a),o=n(68420),s=n(27344),l=n(5281),i=n(84441),c=n(3020),u=n(3362),p=n(44845),d=n(81643),f=n.n(d),m=n(94198),h=n.n(m),v=n(78914),g=n.n(v),y=n(3649),S=n.n(y),Z=n(2991),E=n.n(Z),P=n(25843),C=n.n(P),I=n(67294),_=n(34041),b=n(45360),k=n(31097),N=n(4107),D=n(67908),w=n(78241);function L(e){var t=function(){if("undefined"==typeof Reflect||!r())return!1;if(r().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(r()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,u.Z)(e);if(t){var o=(0,u.Z)(this).constructor;n=r()(a,arguments,o)}else n=a.apply(this,arguments);return(0,c.Z)(this,n)}}var x=_.Z.Option,T=function(e){(0,i.Z)(n,e);var t=L(n);function n(e){var a;return(0,o.Z)(this,n),a=t.call(this,e),(0,p.Z)((0,l.Z)(a),"state",{first_logfile:"",second_logfile:"",show_second_select:!1,second_logs:[],log_message:"",lineNum:"200",searchText:"",sourceText:""}),(0,p.Z)((0,l.Z)(a),"handleMenu1Click",(function(e){var t=(0,l.Z)(a),n=a.props.serviceid;f()(e).call(e,"*")>-1?w.get("/api/v2/instance/".concat(n,"/log"),{logfile:e.replace(/\s+/g,""),is_match:!1}).then((function(n){var a,r,o;0===(n=n.data).code?t.setState({first_logfile:e,second_logs:null===(a=n)||void 0===a||null===(r=a.data)||void 0===r||null===(o=r.result)||void 0===o?void 0:o.replace(/\s+/g,"").split(","),show_second_select:!0}):b.Z.error(n.msg)})):w.get("/api/v2/instance/".concat(n,"/log"),{logfile:e,is_match:!0}).then((function(n){0===(n=n.data).code?(t.setState({first_logfile:e,show_second_select:!1,sourceText:n.data.result}),a.setLogMessage(n.data.result,!0)):b.Z.error(n.msg)}))})),(0,p.Z)((0,l.Z)(a),"handleMenu2Click",(function(e){var t=(0,l.Z)(a),n=a.props.serviceid;w.get("/api/v2/instance/".concat(n,"/log"),{logfile:e,is_match:!0,tail_num:a.state.lineNum}).then((function(n){0===(n=n.data).code?(t.setState({second_logfile:e,show_second_select:!0,sourceText:n.data.result}),a.setLogMessage(n.data.result)):b.Z.error(n.msg)}))})),(0,p.Z)((0,l.Z)(a),"handleRefreshLogs",(function(){var e=a.props.serviceid,t=a.state.first_logfile;(h()(a.state.lineNum)>1e3||h()(a.state.lineNum)<0)&&b.Z.error("行数只能位于0-1000之间"),a.state.second_logfile&&(t=a.state.second_logfile),w.get("/api/v2/instance/".concat(e,"/log"),{logfile:t,is_match:!0,tail_num:a.state.lineNum}).then((function(e){0===(e=e.data).code?(a.setState({sourceText:e.data.result}),a.setLogMessage(e.data.result,!0)):b.Z.error(e.msg)}))})),(0,p.Z)((0,l.Z)(a),"handleLineNumChange",(function(e){a.setState({lineNum:e.target.value})})),(0,p.Z)((0,l.Z)(a),"handleSearchChange",(function(e){var t=e.toLowerCase();if(a.setState({searchText:e}),""!==e){var n=a.state.sourceText.toLocaleLowerCase().split(t),r=[];g()(n).call(n,(function(e){r.push(e.length)}));var o=[],s=0;g()(r).call(r,(function(t){o.push(s+t),s+=t+e.length}));for(var l="",i="",c=a.state.sourceText,u=0,p=0;p<o.length;p++)i=S()(c).call(c,o[p],o[p]+e.length),i='<span style="color: red">'.concat(i,"</span>"),l+=S()(c).call(c,u,o[p])+i,u=o[p]+e.length;a.setLogMessage(l)}else a.setLogMessage(a.state.sourceText)})),(0,p.Z)((0,l.Z)(a),"setLogMessage",(function(e,t){document.getElementById("textPre").innerHTML=e,t&&document.getElementsByClassName("log-message-box").length>0&&document.getElementsByClassName("log-message-box")[0].scrollTo(0,document.getElementById("textPre").offsetHeight),a.setState({log_message:e})})),a}return(0,s.Z)(n,[{key:"UNSAFE_componentWillReceiveProps",value:function(e){}},{key:"render",value:function(){var e=this.props.logs,t=this.state,n=t.first_logfile,a=t.second_logfile,r=t.second_logs,o=void 0===r?[]:r;return I.createElement("div",{className:"logtail-box"},I.createElement("div",{className:"option-bar",style:{display:"flex"}},I.createElement(_.Z,{style:{height:26,minWidth:150,marginBottom:10},value:n,onChange:this.handleMenu1Click},E()(e).call(e,(function(e,t){return I.createElement(x,{key:t+"",value:e},I.createElement(k.Z,{key:t+"",title:e},e))}))),I.createElement("div",{style:this.state.show_second_select?{display:"inline-block",marginLeft:8}:{display:"none"}},I.createElement(_.Z,{style:{height:26,minWidth:150,maxWidth:300,marginBottom:10},value:a,onChange:this.handleMenu2Click},E()(o).call(o,(function(e,t){return I.createElement(x,{key:t+"",value:e},I.createElement(k.Z,{key:t+"",title:C()(e).call(e)},C()(e).call(e)))})))),I.createElement(N.Z,{placeholder:"输入日志行数，“0-1000”之间",onPressEnter:this.handleRefreshLogs,style:{height:26,width:230,marginLeft:8,marginBottom:10},onChange:this.handleLineNumChange,addonAfter:I.createElement(D.Z,{style:{cursor:"pointer"},onClick:this.handleRefreshLogs,type:"reload"})}),I.createElement(N.Z.Search,{placeholder:"输入关键词",style:{height:26,width:179,marginLeft:10,marginBottom:10},onSearch:this.handleSearchChange})),I.createElement("div",{className:"log-message-box",style:{height:"400px",paddingTop:"10px",overflowY:"auto",backgroundColor:"#F5F5F5",border:"1px dashed #DDDDDD"}},I.createElement("span",null,I.createElement("pre",{id:"textPre",style:{paddingLeft:10}}))))}}]),n}(I.Component)},43138:(e,t,n)=>{n.d(t,{Z:()=>f});var a=n(1068),r=n.n(a),o=n(68420),s=n(27344),l=n(84441),i=n(3020),c=n(3362),u=n(67294),p=n(67908);function d(e){var t=function(){if("undefined"==typeof Reflect||!r())return!1;if(r().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(r()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,c.Z)(e);if(t){var o=(0,c.Z)(this).constructor;n=r()(a,arguments,o)}else n=a.apply(this,arguments);return(0,i.Z)(this,n)}}const f=function(e){(0,l.Z)(n,e);var t=d(n);function n(e){return(0,o.Z)(this,n),t.call(this,e)}return(0,s.Z)(n,[{key:"render",value:function(){var e=this.props,t=e.style,n=e.handleClickTop,a=e.handleClickUp,r=e.handleClickDown,o=e.handleClickNew;return u.createElement("div",{className:"special_pagination",style:t},u.createElement("button",{onClick:n},"TOP"),u.createElement("button",{onClick:a},u.createElement(p.Z,{type:"up"})),u.createElement("button",{onClick:r},u.createElement(p.Z,{type:"down"})),u.createElement("button",{onClick:o},"NEW"))}}]),n}(u.Component)},18274:(e,t,n)=>{n.d(t,{E9:()=>l,MD:()=>a,OY:()=>o,RI:()=>s,XN:()=>r});var a=[{text:"部署成功",value:"deployed"},{text:"部署失败",value:"deploy fail"},{text:"部署中",value:"deploying"},{text:"卸载失败",value:"undeploy fail"},{text:"卸载中",value:"undeploying"}],r=[{text:"更新成功",value:"success"},{text:"更新失败",value:"fail"},{text:"更新中",value:"update"}],o={hosts:["主机集群"],kubernetes:["Kubernetes集群（自建集群）","Kubernetes集群（导入已有集群）"]},s={hosts:{title:"主机安装会经过2个状态：管控安装-主机初始化，若某一步安装失败，请查看具体日志。",filters:[{text:"管控安装成功",value:"管控安装成功"},{text:"管控安装失败",value:"管控安装失败"},{text:"script安装成功",value:"script安装成功"},{text:"script安装失败",value:"script安装失败"},{text:"主机初始化成功",value:"主机初始化成功"},{text:"主机初始化失败",value:"主机初始化失败"}],finalStatus:3},kubernetes:{title:"Kubernetes集群主机安装会经过5个状态：管控安装-主机初始化-K8S Docker初始化-K8S Node初始化-K8S Node部署成功，若某一步安装失败，请查看具体日志",filters:[{text:"管控安装失败",value:"管控安装失败",status:-1},{text:"管控安装成功",value:"管控安装成功",status:1},{text:"主机初始化失败",value:"主机初始化失败",status:-3},{text:"主机初始化成功",value:"主机初始化成功",status:3},{text:"K8S DOCKER初始化失败",value:"K8S DOCKER初始化失败",status:-5},{text:"K8S DOCKER初始化成功",value:"K8S DOCKER初始化成功",status:5},{text:"K8S NODE初始化失败",value:"K8S NODE初始化失败",status:-6},{text:"K8S NODE初始化成功",value:"K8S NODE初始化成功",status:6},{text:"K8S NODE部署失败",value:"K8S NODE部署失败",status:-7},{text:"K8S NODE部署成功",value:"K8S NODE部署成功",status:7}],finalStatus:7}},l={NAMESPACE:"em_current_k8s_namespace"}},42238:(e,t,n)=>{n.d(t,{Y:()=>r,v:()=>a});var a={labelCol:{xs:{span:24},sm:{span:8}},wrapperCol:{xs:{span:24},sm:{span:12}}},r={labelCol:{xs:{span:24},sm:{span:6}},wrapperCol:{xs:{span:24},sm:{span:16}}}},28210:(e,t,n)=>{n.r(t),n.d(t,{default:()=>Sa});var a={};n.r(a),n.d(a,{checkDefaultImageStore:()=>st,checkDeployStatus:()=>$e,deployFinished:()=>nt,editDeployState:()=>it,editRuntimeState:()=>lt,getBaseClusterList:()=>Te,getCurrentDeployList:()=>Qe,getDeployList:()=>Je,getInstallClusterList:()=>Ke,getNamespaceList:()=>Be,getProductPackageList:()=>Ae,getProductPackageServices:()=>Oe,getProductServicesInfo:()=>Re,getProductServicesInfoForAutoDeploy:()=>Fe,getUncheckedService:()=>xe,goToStep:()=>rt,initInstallGuide:()=>tt,lastStep:()=>Ie,nextStep:()=>Ce,quitConfig:()=>at,quitGuide:()=>Ve,refreshServicesInfoForAutoDeploy:()=>Ue,resetInstallGuideConfig:()=>Ge,saveInstallInfo:()=>_e,saveInstallType:()=>be,saveParamsFieldConfigState:()=>ze,saveResourceState:()=>je,saveSelectBaseCluster:()=>De,saveSelectCluster:()=>ke,saveSelectNamespace:()=>Ne,saveSelectedService:()=>we,saveSmoothSelected:()=>qe,saveUnSelectedService:()=>Le,setDeployUUID:()=>ot,setOldHostInfo:()=>ct,setSelectedConfigService:()=>Me,setSqlErro:()=>ut,startAutoDeploy:()=>We,startDeploy:()=>Ye,stopAutoDeploy:()=>et,stopDeploy:()=>Xe,updateServiceHostList:()=>He});var r=n(1068),o=n.n(r),s=n(14310),l=n.n(s),i=n(34074),c=n.n(i),u=n(39649),p=n.n(u),d=n(20368),f=n.n(d),m=n(63978),h=n.n(m),v=n(73126),g=n(44930),y=n(68420),S=n(27344),Z=n(5281),E=n(84441),P=n(3020),C=n(3362),I=n(44845),_=n(95266),b=n(63109),k=n.n(b),N=n(51942),D=n.n(N),w=n(32366),L=n.n(w),x=n(41511),T=n.n(x),O=n(2991),A=n.n(O),G=n(47302),V=n.n(G),R=n(20116),F=n.n(R),U=n(78914),K=n.n(U),B=n(62462),M=n.n(B),H=n(77149),j=n.n(H),q=n(59340),z=n.n(q),Y=n(81643),W=n.n(Y),$=n(3649),J=n.n($),Q=n(94473),X=n.n(Q),ee=n(54103),te=n.n(ee),ne=n(86902),ae=n.n(ne),re=n(67294),oe=n(27220),se=n(26855),le=n(45360),ie=n(30258),ce=n(67908),ue=n(77268),pe=n(29027),de=n(15857),fe=n(12903),me=n(77766),he=n.n(me),ve=n(20455),ge=n.n(ve),ye=n(78580),Se=n.n(ye),Ze=n(56466),Ee=n(96486),Pe=n(19528),Ce=function(){return function(e){e({type:Ze.wO.NEXT_STEP,payload:{}})}},Ie=function(){return function(e){e({type:Ze.wO.LAST_STEP,payload:{}})}},_e=function(e){return function(t){t({type:Ze.wO.SAVE_INSTALL_INFO,payload:e})}},be=function(e){return function(t){t({type:Ze.wO.SAVE_INSTALL_TYPE,payload:e})}},ke=function(e){return function(t){t({type:Ze.wO.SAVE_SELECTED_CLUSTER,payload:e})}},Ne=function(e,t,n,a){return function(){var r=(0,g.Z)(k().mark((function r(o){var s,l;return k().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!n){r.next=8;break}return r.next=3,Pe.jy.createNamespace(e,t);case 3:if(s=r.sent,!(l=s.data).code){r.next=8;break}return ie.Z.confirm({title:"创建命名空间发生错误，是否继续使用该命名空间部署应用？",content:l.msg,icon:"close-circle",className:"modal-icon-error",okType:"danger",okText:"继续",cancelText:"取消",onOk:function(){o({type:Ze.wO.SAVE_SELECTED_NAMESPACE,payload:t.namespace}),a&&a()}}),r.abrupt("return");case 8:o({type:Ze.wO.SAVE_SELECTED_NAMESPACE,payload:t.namespace}),a&&a();case 10:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}()},De=function(e){return function(t){t({type:Ze.wO.SAVE_SELECTED_BASECLUSTER,payload:e})}},we=function(e){return function(t){t({type:Ze.wO.SAVE_SELECTED_SEERVICE,payload:e})}},Le=function(e){return function(t){t({type:Ze.wO.SAVE_UNSELECTED_SEERVICE,payload:e})}},xe=function(e){return function(t){Pe.jy.getUncheckedService(e).then((function(e){e.data.code}))}},Te=function(e,t){return function(n){Pe.jy.getBaseClusterList(e).then((function(e){if(0===(e=e.data).code){var a=e.data,r=a.candidates,o=a.targets,s=a.message,l={baseClusterInfo:{baseClusterList:r,hasDepends:a.hasDepends,dependMessage:s},baseClusterId:X()(r).call(r,(function(e){return e.clusterId===o.clusterId}))?o.relynamespace:-1};n({type:Ze.wO.UPDATE_PRODUCT_BASECLUSTER_INFO,payload:l}),t&&t(l)}else le.Z.error(e.msg)}))}},Oe=function(e,t){return function(n){var a=e.productName,r=e.productVersion,o=e.pid,s=e.clusterId,l=e.relynamespace,i=e.namespace;Pe.jy.getProductPackageServices({productName:a,productVersion:r,relynamespace:-1===l?void 0:l}).then((function(e){if(0===e.data.code){var a,r,l=[];A()(a=e.data.data).call(a,(function(e){return l.push(e.serviceName)}));var c=(0,Ee.cloneDeep)(e.data.data),u=[],p=[];for(var d in c)""===c[d].baseProduct?u.push(c[d]):p.push(c[d]);c=he()(r=[]).call(r,u,p),n({type:Ze.wO.UPDATE_PRODUCT_PACEAGE_SERVICES_LIST,payload:c}),Pe.jy.getUncheckedService({pid:o,clusterId:s,namespace:i}).then((function(e){if(0===e.data.code){var a=e.data.data||[],r=(0,Ee.difference)(l,a);n({type:Ze.wO.SAVE_SELECTED_SEERVICE,payload:r}),n({type:Ze.wO.SAVE_UNSELECTED_SEERVICE,payload:a||[]}),t&&t()}}))}else le.Z.error(e.data.msg)}))}},Ae=function(e,t){return function(n){Pe.jy.getProductPackagelist(e).then((function(e){0===e.data.code?(n({type:Ze.wO.UPDATE_PRODUCT_PACEAGE_LIST,payload:e.data.data.list}),t&&t()):le.Z.error(e.data.msg)}))}},Ge=function(e){return function(e){e({type:Ze.wO.RESET_INSTALL_CONFIG,payload:{}})}},Ve=function(){return function(e){e({type:Ze.wO.QUIT_GUIDE,payload:{}})}},Re=function(e,t,n){return function(a){Pe.jy.getProductServicesInfo(e).then((function(e){if(0===e.data.code){if(t&&t(e.data.data),(null==n?void 0:n.length)>0)for(var r=e.data.data,o=0,s=ge()(r);o<s.length;o++)for(var l=s[o],i=0,c=ae()(l);i<c.length;i++){var u=c[i];Se()(n).call(n,u)&&a({type:Ze.wO.SET_SMOOTH_SELECT_SERVICE,payload:l[u]})}a({type:Ze.wO.UPDATE_PRODUCT_SERVICES_INFO,payload:e.data.data})}else le.Z.error(e.data.msg)}))}},Fe=function(e,t){return function(n){Pe.jy.autoOrchestration(e).then((function(e){0===e.data.code?(t&&t(e.data.data),n({type:Ze.wO.UPDATE_PRODUCT_SERVICES_INFO,payload:e.data.data||[]})):le.Z.error(e.data.msg)}))}},Ue=function(e,t){return function(n){Pe.jy.refreshServicesInfoForAutoDeploy(e).then((function(e){0===e.data.code?(t&&t(e.data.data),n({type:Ze.wO.UPDATE_PRODUCT_SERVICES_INFO,payload:e.data.data||[]})):le.Z.error(e.data.msg)}))}},Ke=function(e){return function(t){Pe.jy.getInstallClusterList(e).then((function(e){if(0===(e=e.data).code){var n,a=T()(e.data.clusters)&&F()(n=e.data.clusters).call(n,(function(e){return"Running"===e.status||"Error"===e.status}));t({type:Ze.wO.UPDATE_CLUSTER_LIST,payload:a})}else le.Z.error(e.msg)}))}},Be=function(e){return function(t){Pe.jy.getNamespaceList(e).then((function(e){if(0===(e=e.data).code){var n,a=e.data||{},r=T()(a.namespaces)&&A()(n=a.namespaces).call(n,(function(e){return e.namespace}));t({type:Ze.wO.UPDATE_NAMESPACE_LIST,payload:r})}else le.Z.error(e.msg)}))}},Me=function(e){return function(t){t({type:Ze.wO.SET_SELECTED_CONFIG_SERVICE,payload:e})}},He=function(e){return function(t){Pe.jy.updateServiceHostList(e).then((function(e){0===(e=e.data).code?t({type:Ze.wO.UPDATE_SERVICE_HOST_LIST,payload:e.data.hosts}):le.Z.error(e.msg)}))}},je=function(e){return function(t){t({type:Ze.wO.SAVE_RESOURCE_STATE,payload:e})}},qe=function(e){return function(t){t({type:Ze.wO.SET_SMOOTH_SELECT_SERVICE,payload:e})}},ze=function(e){return function(t){t({type:Ze.wO.SAVE_PARAMS_FIELD_CONFIG_STATE,payload:e})}},Ye=function(e,t){return function(n){Pe.jy.startDeploy(e).then((function(e){0===(e=e.data).code?(n({type:Ze.wO.START_DEPLOY,payload:e.data.deploy_uuid}),t()):se.Z.error({message:"提示",description:e.msg,duration:0})}))}},We=function(e,t){return function(n){Pe.jy.autoDeploy(e).then((function(e){0===(e=e.data).code?(n({type:Ze.wO.START_DEPLOY,payload:e.data.deploy_uuid}),t(e.data)):se.Z.error({message:"提示",description:e.msg,duration:0})}))}},$e=function(e,t){return function(n){Pe.jy.checkDeployStatus(e).then((function(e){e=e.data.data.list,t(e)}))}},Je=function(e){return function(t){Pe.jy.getDeployTaskList(e).then((function(e){if(0===(e=e.data).code){var n=e.data.count-(e.data.list&&e.data.list.length);t({type:Ze.wO.UPDATE_DEPLOY_LIST,payload:{deployList:e.data.list,complete:e.data.complete,start:n,count:e.data.count,deployType:e.data.deploy_type}})}else le.Z.error(e.msg)}))}},Qe=function(e){return function(t){Pe.jy.getDeployTaskList(e).then((function(e){0===(e=e.data).code?t({type:Ze.wO.UPDATE_CURRENT_DEPLOY_LIST,payload:{deployList:e.data.list,complete:e.data.complete,count:e.data.count}}):le.Z.error(e.msg)}))}},Xe=function(e,t,n){return function(n){if(e){var a=t.productName,r=t.version,o=t.namespace,s=t.clusterId,l={productName:a,productVersion:r};Pe.aJ.unDeployService(l,{namespace:o,clusterId:s}).then((function(e){var t=e.data;0===t.code?n({type:Ze.wO.STOP_DEPLOY,payload:{stopDeployBySelf:!0,deployUUID:t.data.deploy_uuid}}):le.Z.error(t.msg)}))}else Pe.jy.stopDeploy(t).then((function(e){0===(e=e.data).code?n({type:Ze.wO.STOP_DEPLOY,payload:{stopDeployBySelf:!0}}):le.Z.error(e.msg)}))}},et=function(e,t,n){return function(n){if(e){var a=t.productName,r=t.version,o=t.namespace,s=t.clusterId,l={productName:a,productVersion:r};Pe.aJ.unDeployService(l,{namespace:o,clusterId:s}).then((function(e){var t=e.data;0===t.code?n({type:Ze.wO.STOP_DEPLOY,payload:{stopDeployBySelf:!0,deployUUID:t.data.deploy_uuid}}):le.Z.error(t.msg)}))}else Pe.jy.stopAutoDeploy(t).then((function(e){0===(e=e.data).code?n({type:Ze.wO.STOP_DEPLOY,payload:{stopDeployBySelf:!0}}):le.Z.error(e.msg)}))}},tt=function(e){return function(e){e({type:Ze.wO.INIT_INSTALLGUIDE,payload:{}})}},nt=function(){return function(e){e({type:Ze.wO.DEPLOY_FINISHED,payload:""})}},at=function(e){return function(t){t({type:Ze.wO.QUIT_CONFIG,payload:e})}},rt=function(e){return function(t){t({type:Ze.wO.GO_TO_STEP,payload:e})}},ot=function(e){return function(t){t({type:Ze.wO.SET_DEPLOY_UUID,payload:e})}},st=function(e,t){return function(n){Pe.jy.checkDefaultImageStore(e).then((function(e){0===(e=e.data).code?t&&t(e.data.exist):le.Z.error(e.msg)}))}},lt=function(e){return function(t){t({type:Ze.wO.EDIT_RUNTIME_STATE,payload:e})}},it=function(e){return function(t){t({type:Ze.wO.EDIT_DEPLOY_STATE,payload:e})}},ct=function(e){return{type:Ze.wO.SET_OLD_HOST_INFO,payload:e}},ut=function(e){return function(t){Pe.jy.checkMySqlAddr(e).then((function(e){0==(e=e.data).code&&t({type:Ze.wO.SET_SQL_ERRO,payload:e.data})}))}},pt=n(33032),dt=n.n(pt),ft=n(36808),mt=n(66253),ht=n(34041),vt=n(69035),gt=n(31097),yt=n(4107),St=n(42238);function Zt(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}var Et=mt.ZP.Group,Pt=ht.Z.Option,Ct=vt.Z.Item,It=function(e){(0,E.Z)(n,e);var t=Zt(n);function n(e){var a;return(0,y.Z)(this,n),a=t.call(this,e),(0,I.Z)((0,Z.Z)(a),"handleSelect",(function(e){var t=a.props,n=t.installGuideProp,r=void 0===n?{}:n,o=t.form,s=r.installType,l=r.clusterList,i=T()(l)&&X()(l).call(l,(function(t){return t.id===e}));ft.set("em_current_cluster_id",e),ft.set("em_current_cluster_type",i.type),a.props.actions.saveSelectCluster(e),a.setState({mode:i.mode}),a.props.actions.getProductPackageList({limit:0,product_type:"kubernetes"!==s?0:1}),"kubernetes"===s&&(a.props.actions.getNamespaceList({clusterId:e}),a.setState({isNewSpace:!1}),o.setFieldsValue({namespace:void 0,isNewSpace:!1}))})),(0,I.Z)((0,Z.Z)(a),"handleSearch",(function(e){var t=a.props.installGuideProp.clusterList,n=void 0===t?[]:t;a.setState({clusterName:e,clusterList:F()(n).call(n,(function(t){var n;return t.name&&-1!==W()(n=t.name).call(n,e)}))})})),(0,I.Z)((0,Z.Z)(a),"handleNamespaceChange",(function(e){if(-1===a.props.installGuideProp.clusterId)return le.Z.error("请选择集群"),void dt()((function(){a.props.form.setFieldsValue({namespace:void 0})}),0);"create_new"===e?a.setState({isNewSpace:!0},(function(){a.props.form.setFieldsValue({namespace:"",isNewSpace:!0})})):a.props.actions.saveSelectNamespace(null,{namespace:e},!1)})),(0,I.Z)((0,Z.Z)(a),"validateNamespace",(function(e,t,n){if(t&&a.state.isNewSpace){/^dtstack-[a-z0-9-]{0,54}[a-z0-9]$/.test(t)||n("请以“dtstack-”开头, 并使用小写字母、数字、中划线进行命名, 不超过63个字符")}n()})),(0,I.Z)((0,Z.Z)(a),"handleInstallTypeChange",(function(e){var t=e.target.value;a.setState({isNewSpace:!1}),a.props.actions.saveInstallType(t),a.props.actions.getInstallClusterList({limit:0,type:t}),a.props.form.setFieldsValue({clusterId:void 0,namespace:void 0,isNewSpace:!1})})),a.state={clusterList:[],clusterName:"",isNewSpace:!1,mode:0},a}return(0,S.Z)(n,[{key:"render",value:function(){var e=this.state,t=e.clusterName,n=e.isNewSpace,a=e.mode,r=this.props,o=r.installGuideProp,s=r.form,l=o.namespaceList,i=o.installType,c=s.getFieldDecorator,u=t?this.state.clusterList:o.clusterList,p=1===a;return re.createElement("div",{className:"step-content-container step-two-container"},re.createElement("div",{className:"header-box",style:{marginBottom:24}},re.createElement("p",null,re.createElement(ue.Z,{type:"primary",onClick:function(){window.open("/deploycenter/cluster/create").opener=null}},re.createElement(ce.Z,{type:"plus"}),"添加集群"),re.createElement("span",{style:{marginLeft:6}},"选择部署方式和部署集群，将在此集群上部署该产品"))),re.createElement(vt.Z,null,re.createElement(Ct,(0,v.Z)({required:!0},St.v,{label:"部署方式"}),re.createElement(Et,{value:i,onChange:this.handleInstallTypeChange},re.createElement(mt.ZP,{value:"kubernetes"},re.createElement("span",null,"Kubernetes部署",re.createElement(gt.Z,{title:"应用部署在K8S集群上，适用于容器部署模式"},re.createElement(ce.Z,{className:"ml-10",type:"info-circle"})))),re.createElement(mt.ZP,{value:"hosts"},re.createElement("span",null,"物理/虚拟机部署",re.createElement(gt.Z,{title:"应用部署在物理/虚拟机上，适用于传统部署模式"},re.createElement(ce.Z,{className:"ml-10",type:"info-circle"})))))),re.createElement(Ct,(0,v.Z)({},St.v,{label:"选择集群"}),c("clusterId",{initialValue:-1===o.clusterId?void 0:o.clusterId,rules:[{required:!0,message:"集群不可为空"}]})(re.createElement(ht.Z,{showSearch:!0,filterOption:!1,placeholder:"请选择集群",style:{width:460},onChange:this.handleSelect,onSearch:this.handleSearch},T()(u)&&A()(u).call(u,(function(e){return re.createElement(Pt,{key:e.id,value:e.id},e.name)}))))),"kubernetes"===i&&re.createElement(Ct,(0,v.Z)({},St.v,{label:"选择命名空间"}),c("namespace",{initialValue:o.namespace||void 0,rules:[{required:!0,message:"命名空间不可为空"},{validator:n?this.validateNamespace:null}]})(n?re.createElement(yt.Z,{placeholder:'请输入新建命名空间，且前缀必须以"dtstack-"开头',style:{width:460}}):re.createElement(ht.Z,{showSearch:!0,placeholder:"请选择命名空间",style:{width:460},onChange:this.handleNamespaceChange},!p&&re.createElement(Pt,{value:"create_new"},re.createElement("a",{onClick:function(e){return e.preventDefault()}},"新建命名空间")),T()(l)&&A()(l).call(l,(function(e){return re.createElement(Pt,{key:e,value:e},e)})))),p&&re.createElement("a",{className:"ml-10",target:"_blank",rel:"noopener noreferrer",href:"/deploycenter/cluster/detail/namespace"},"新建命名空间")),re.createElement(Ct,null,c("isNewSpace",{initialValue:!1})(re.createElement(yt.Z,{style:{display:"none"}})))))}}]),n}(re.Component);const _t=vt.Z.create()(It);var bt=n(71649),kt=n(9676),Nt=n(87558),Dt=n(8263),wt=n(18274),Lt=n(71230),xt=n(15746);function Tt(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}var Ot=vt.Z.Item,At=function(e){(0,E.Z)(n,e);var t=Tt(n);function n(e){return(0,y.Z)(this,n),t.call(this,e)}return(0,S.Z)(n,[{key:"render",value:function(){var e=this.props.data,t=this.props.form.getFieldDecorator,n={labelCol:{xs:{span:24},sm:{span:6}},wrapperCol:{xs:{span:24},sm:{span:18}}};return re.createElement(vt.Z,{className:"step-set-modal"},re.createElement(Ot,(0,v.Z)({},n,{label:"产品包名称"}),t("ProductName",{initialValue:e.ProductName})(re.createElement("span",null,e.ProductName))),re.createElement(Ot,(0,v.Z)({},n,{label:"产品版本号"}),t("ProductVersion",{initialValue:e.ProductVersion})(re.createElement("span",null,e.ProductVersion))),re.createElement(Ot,(0,v.Z)({},n,{label:"应用启动用户名",style:{display:"flex",alignItems:"center"}}),t("field",{rules:[],initialValue:""})(re.createElement(yt.Z,{placeholder:"请输入应用启动用户名",style:{width:"320px"}})),re.createElement(gt.Z,{title:"应用启动用户名，将初始化进产品包的各服务中， 即产品包下各服务部署时，默认以此用户名启动。同时，各服务也支持使用不同的启动用户名， 故实际部署以最终细粒度的服务启动用户名为准。"},re.createElement(ce.Z,{type:"info-circle-o",style:{fontSize:"16px",marginLeft:"10px"}}))),re.createElement(Lt.Z,{style:{color:"rgb(151,151,151)"}},re.createElement(xt.Z,{span:6}),re.createElement(xt.Z,{span:18},"仅以root用户接入主机时，该设置有效。")))}}]),n}(re.Component);const Gt=vt.Z.create()(At);var Vt;function Rt(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}!function(e){e.AUTO="AUTO",e.MANUAL="MANUAL"}(Vt||(Vt={}));var Ft=ht.Z.Option,Ut=kt.Z.Group;const Kt=function(e){(0,E.Z)(n,e);var t=Rt(n);function n(e){var a;return(0,y.Z)(this,n),a=t.call(this,e),(0,I.Z)((0,Z.Z)(a),"setmodal",void 0),(0,I.Z)((0,Z.Z)(a),"state",{productPackageList:a.props.installGuideProp.productPackageList,fileList:[],filters:[],deploy_status:"",modalShow:!1}),(0,I.Z)((0,Z.Z)(a),"uploadOnChange",(function(e){e.file.response&&(0!==e.file.response.code?le.Z.error(e.file.response.msg):(le.Z.success("".concat(e.file.name," 上传成功！")),a.props.actions.getProductPackageList({limit:0,product_type:a.props.isKubernetes?1:0}),e.file.response.data&&le.Z.warning(e.file.response.data)))})),(0,I.Z)((0,Z.Z)(a),"handleProductSelected",(function(e){a.props.isKubernetes?a.props.actions.getBaseClusterList({clusterId:a.props.installGuideProp.clusterId,namespace:a.props.installGuideProp.namespace,pid:e.ID},(function(t){if(!t.baseClusterInfo.hasDepends||-1!==t.baseClusterId){if(a.props.actions.resetInstallGuideConfig(),!t.baseClusterId)return;a.getProductPackageServices(e,t.baseClusterId)}})):a.getProductPackageServices(e),a.props.actions.saveInstallInfo(e)})),(0,I.Z)((0,Z.Z)(a),"getProductPackageServices",(function(e,t){a.props.actions.getProductPackageServices({productName:e.ProductName,productVersion:e.ProductVersion,pid:e.ID,clusterId:a.props.installGuideProp.clusterId,relynamespace:-1===t?void 0:t,namespace:a.props.installGuideProp.namespace})})),(0,I.Z)((0,Z.Z)(a),"handleDeleteProductPackage",(function(e){ie.Z.confirm({title:"确定删除此安装包？",content:"删除后，再次部署时需要再次上传。",icon:re.createElement(ce.Z,{type:"exclamation-circle",theme:"filled"}),okType:"danger",onOk:function(){Pe.jy.deleteProducyPackage({productName:e.ProductName,productVersion:e.ProductVersion}).then((function(e){0===e.data.code?(a.setState({}),a.props.actions.getProductPackageList({limit:0,product_type:a.props.isKubernetes?1:0})):le.Z.error(e.data.msg)}))}})})),(0,I.Z)((0,Z.Z)(a),"initSelectedProduct",(function(){var e,t=a.props.defaultSelectedProduct;K()(e=a.state.productPackageList).call(e,(function(e){t.product_name===e.ProductName&&t.product_version===e.ProductVersion&&t.id===e.ID.toString()&&a.handleProductSelected(e)}))})),(0,I.Z)((0,Z.Z)(a),"changeCheckbox",(function(e){var t=a.props.installGuideProp.productServices,n=A()(t).call(t,(function(e){return e.serviceName})),r=(0,Ee.difference)(n,e);a.props.actions.saveSelectedService(e),a.props.actions.saveUnSelectedService(r)})),(0,I.Z)((0,Z.Z)(a),"getProductServicePromise",(function(e){var t=e.isKubernetes,n=e.productRecord,r={productName:n.ProductName,productVersion:n.ProductVersion,pid:n.ID,clusterId:a.props.installGuideProp.clusterId,baseClusterId:void 0};return t?Pe.jy.getBaseClusterList({clusterId:a.props.installGuideProp.clusterId,namespace:a.props.installGuideProp.namespace,pid:n.ID}).then((function(e){if(0===(e=e.data).code){var t=e.data,n=t.candidates,a=t.targets,r=t.message;return{baseClusterInfo:{baseClusterList:n,hasDepends:t.hasDepends,dependMessage:r},baseClusterId:X()(n).call(n,(function(e){return e.relynamespace===a.relynamespace}))?0===a.relynamespace?-1:a.relynamespace:-1}}throw new Error(e.msg)})).then((function(e){var t=e.baseClusterId;if(!e.baseClusterInfo.hasDepends||-1!==t){var n=-1===t?void 0:t;return r.baseClusterId=n,Pe.jy.getProductPackageServices(r)}})).then((function(e){return e.data.data})):Pe.jy.getProductPackageServices(r).then((function(e){return e.data.data})).catch((function(){le.Z.error("获取组件失败")}))})),(0,I.Z)((0,Z.Z)(a),"tableColInit",(function(){var e,t=a.props.deployMode;return[{title:"产品包名称",dataIndex:"ProductNameDisplay",filters:a.state.filters,filterMultiple:!1,render:function(e,n){var r;return re.createElement("div",null,t===Vt.MANUAL&&re.createElement(mt.ZP,{checked:n.ID===a.props.installGuideProp.selectedProduct.ID,onChange:function(){return a.handleProductSelected(n)}}),t===Vt.AUTO&&re.createElement(kt.Z,{style:{marginRight:"20px"},checked:M()(r=a.props.autoSelectedProducts).call(r,(function(e){return e.ID===n.ID}))>-1,onChange:function(e){var t=a.props.autoSelectedProducts;!0===e.target.checked?a.getProductServicePromise({productRecord:n,isKubernetes:a.props.isKubernetes}).then((function(e){var r,o,s=V()(e).call(e,(function(e,t){return e.baseProduct.length-t.baseProduct.length})),l=A()(r=F()(s).call(s,(function(e){return""===e.baseProduct}))).call(r,(function(e){return e.serviceName})),i=A()(o=F()(s).call(s,(function(e){return""!==e.baseProduct}))).call(o,(function(e){return e.serviceName})),c=F()(t).call(t,(function(e){return e.productName!==n.ProductName}));c.push({ID:n.ID,productName:n.ProductName,productVersion:n.ProductVersion,service:{all:s,checked:l,unChecked:[],disabled:i}}),a.props.updateParentState({autoSelectedProducts:c})})):a.props.updateParentState({autoSelectedProducts:F()(t).call(t,(function(e){return e.ID!==n.ID}))})}}),re.createElement("span",null,e))}},{title:"版本号",dataIndex:"ProductVersion"},{title:"部署状态",dataIndex:"Status",filters:he()(e=[]).call(e,(0,bt.Z)(wt.MD),[{text:"未部署",value:"undeployed"}]),render:function(e,t){var n="";switch(e){case"deploying":n=re.createElement("span",null,"部署中");break;case"deployed":n=re.createElement("span",null,"已部署");break;case"deploy fail":n=re.createElement("span",null,"部署失败");break;case"undeploying":n=re.createElement("span",null,"卸载中");break;case"undeploy fail":n=re.createElement("span",null,"卸载失败");break;case"undeployed":default:n=re.createElement("span",null,"未部署")}return re.createElement("span",null,n)}},{title:"操作",dataIndex:"action",render:function(e,t){return re.createElement("div",{style:{display:"flex",alignItems:"center"}},re.createElement("a",{style:{marginRight:"10px"},onClick:function(e){e.preventDefault(),a.setState({modalShow:t})}},re.createElement(ce.Z,{type:"setting"})))}}]})),(0,I.Z)((0,Z.Z)(a),"handleTableChange",(function(e,t,n){a.props.actions.getProductPackageList({limit:0,product_type:a.props.isKubernetes?1:0,product_name:t.ProductNameDisplay&&t.ProductNameDisplay.toString(),deploy_status:t.Status&&t.Status.join(",").toString()})})),(0,I.Z)((0,Z.Z)(a),"serviceUpdate",(function(e){Pe.jy.serviceUpdate(e,{field_path:"Instance.RunUser",field:e.field}).then((function(e){if(0===e.data.code){var t=a.setmodal;le.Z.success("设置成功！"),a.setState({modalShow:!1}),t.resetFields()}else le.Z.error(e.data.msg)}))})),(0,I.Z)((0,Z.Z)(a),"handleBaseClusterChange",(function(e){var t=a.props.installGuideProp.selectedProduct;a.props.actions.saveSelectBaseCluster(e),a.getProductPackageServices(t,e)})),(0,I.Z)((0,Z.Z)(a),"handleDeployModeChange",(function(e){a.props.updateParentState({deployMode:e.target.value}),e.target.value===Vt.AUTO?a.props.getOrchestrationHistory():ie.Z.info({title:"如果手动部署模式选择了主机，切换至自动部署模式，则自动编排功能将不可用。"})})),a}return(0,S.Z)(n,[{key:"componentDidMount",value:function(){var e=this,t=this.props.isK8s;this.props.getOrchestrationHistory(),Pe.jy.getProductNames({product_type:this.props.isKubernetes?1:0}).then((function(n){var a;0===(n=n.data).code?(K()(a=n.data).call(a,(function(t){e.state.filters.push({text:t,value:t})})),t&&e.props.updateParentState({deployMode:Vt.MANUAL}),e.setState({filters:e.state.filters})):le.Z.error(n.msg)}))}},{key:"componentDidUpdate",value:function(e){var t=e.installGuideProp.productPackageList,n=this.props.installGuideProp.productPackageList;(0,Ee.isEqual)(t,n)||this.setState({productPackageList:n}),"{}"===z()(this.props.installGuideProp.selectedProduct)&&"{}"!==z()(this.props.defaultSelectedProduct)&&this.initSelectedProduct()}},{key:"render",value:function(){var e,t=this,n={name:"package",action:"/api/v2/product/upload",headers:{authorization:"authorization-text"},onChange:this.uploadOnChange,accept:".tar"},a=this.props.installGuideProp,r=a.productServices,o=a.baseClusterId,s=a.baseClusterInfo,l=s.baseClusterList,i=s.hasDepends,c=s.dependMessage,u=this.props.deployMode,p={display:"block",marginBottom:"20px"};return re.createElement("div",{className:"step-one-container step-content-container",style:{overflow:"scroll"}},re.createElement("div",null,re.createElement(mt.ZP.Group,{value:u,defaultValue:Vt.AUTO,onChange:this.handleDeployModeChange},void 0,re.createElement(mt.ZP,{disabled:this.props.isK8s,style:p,value:Vt.AUTO},re.createElement("span",{className:"radio-main"},"自动部署"),re.createElement("span",{className:"radio-tips"},"（支持多个产品包同时部署、支持主机标签自动编排）")),re.createElement(mt.ZP,{style:p,value:Vt.MANUAL},re.createElement("span",{className:"radio-main"},"手动部署"),re.createElement("span",{className:"radio-tips"},"（支持单个产品包部署，支持自定义主机配置）")))),re.createElement("div",{className:"header-box"},re.createElement(Nt.Z,n,re.createElement(ue.Z,{type:"primary"},re.createElement(ce.Z,{type:"upload"}),"上传安装包")),re.createElement("span",{style:{marginLeft:12}},"您需选择需要安装的产品包，可上传新的安装包，也可重新部署之前的安装包。")),u===Vt.MANUAL&&re.createElement("div",null,re.createElement(Dt.Z,{pagination:!1,className:"dt-em-table dt-table-border dt-table-last-row-noborder",rowKey:"ID",onChange:this.handleTableChange,dataSource:this.state.productPackageList,columns:this.tableColInit(),expandedRowRender:function(){return re.createElement("div",{style:{overflow:"auto"}},i&&re.createElement("div",{className:"mt-10 mb-10",style:{margin:"12px 0 0 0",lineHeight:"32px"}},re.createElement(ce.Z,{type:"exclamation-circle",theme:"filled",className:"mr-8",style:{color:"#f5a841",lineHeight:"20px"}}),re.createElement("span",{className:"mr-8",style:{lineHeight:"20px"}},c),void 0,l.length>0&&re.createElement(ht.Z,{style:{width:264,height:"32px"},placeholder:"请选择依赖集群",value:-1===o?void 0:o,onChange:t.handleBaseClusterChange},A()(l).call(l,(function(e){return re.createElement(Ft,{key:e.relynamespace,value:e.relynamespace},e.relynamespace)})))),!(!i||-1!==o)&&re.createElement("p",{style:{height:"12px"}}),(!i||-1!==o)&&re.createElement(re.Fragment,null,re.createElement("div",{style:{margin:"12px 0 0 36px",lineHeight:"20px"}},"EasyManager安装程序将安装以下服务："),re.createElement(Ut,{style:{float:"left",marginBottom:"20px",marginLeft:"36px"},onChange:function(e){t.changeCheckbox(e)},value:t.props.installGuideProp.selectedServiceList},A()(r).call(r,(function(e,t){var n;return re.createElement("p",{key:he()(n="".concat(e.serviceName,"-")).call(n,t),style:{marginTop:"12px",lineHeight:"20px"}},re.createElement(kt.Z,{value:"".concat(e.serviceName),disabled:!!e.baseProduct},re.createElement("span",{style:{marginRight:10}},e.serviceName),re.createElement("span",null,e.serviceVersion?e.serviceVersion:""),re.createElement("span",{style:{marginLeft:10}},e.baseProduct)))})))))},expandedRowKeys:[this.props.installGuideProp.selectedProduct.ID]})),u===Vt.AUTO&&re.createElement("div",null,re.createElement(Dt.Z,{pagination:!1,className:"dt-em-table dt-table-border dt-table-last-row-noborder",rowKey:"ID",onChange:this.handleTableChange,dataSource:this.state.productPackageList,columns:this.tableColInit(),expandedRowRender:function(e){var n,a,r,o=X()(n=t.props.autoSelectedProducts).call(n,(function(t){return t.ID===e.ID}));return o?re.createElement("div",null,re.createElement(re.Fragment,null,re.createElement("div",{style:{margin:"12px 0 0 36px",lineHeight:"20px"}},"EasyManager安装程序将安装以下服务："),re.createElement(Ut,{style:{float:"left",marginBottom:"20px",marginLeft:"36px"},onChange:function(e){t.props.updateAutoDeployService(o.ID,e)},value:he()(a=[]).call(a,(0,bt.Z)(o.service.checked),(0,bt.Z)(o.service.disabled))},A()(r=o.service.all).call(r,(function(e,t){var n;return re.createElement("p",{key:he()(n="".concat(e.serviceName,"-")).call(n,t),style:{marginTop:"12px",lineHeight:"20px"}},re.createElement(kt.Z,{value:"".concat(e.serviceName),disabled:!!e.baseProduct,checked:!0},re.createElement("span",{style:{marginRight:10}},e.serviceName),re.createElement("span",null,e.serviceVersion?e.serviceVersion:""),re.createElement("span",{style:{marginLeft:10}},e.baseProduct)))}))))):null},expandedRowKeys:A()(e=this.props.autoSelectedProducts).call(e,(function(e){return e.ID}))})),re.createElement(ie.Z,{visible:!!this.state.modalShow,title:"设置",okText:"保存",width:600,onOk:function(){t.setmodal.validateFields((function(e,n){null==e&&t.serviceUpdate(n)}))},onCancel:function(){var e=t.setmodal;t.setState({modalShow:!1}),e.resetFields()}},re.createElement(Gt,{data:this.state.modalShow,ref:function(e){return t.setmodal=e}})))}}]),n}(re.Component);var Bt,Mt=n(99210),Ht=n(93883),jt=n(94184),qt=n.n(jt);function zt(e,t){var n=ae()(e);if(l()){var a=l()(e);t&&(a=F()(a).call(a,(function(t){return c()(e,t).enumerable}))),n.push.apply(n,a)}return n}function Yt(e){for(var t=1;t<arguments.length;t++){var n,a,r=null!=arguments[t]?arguments[t]:{};t%2?K()(n=zt(Object(r),!0)).call(n,(function(t){(0,I.Z)(e,t,r[t])})):p()?f()(e,p()(r)):K()(a=zt(Object(r))).call(a,(function(t){h()(e,t,c()(r,t))}))}return e}function Wt(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}var $t=ht.Z.Option,Jt=Mt.Z.Item,Qt=Mt.Z.SubMenu;const Xt=(0,pe.$j)((function(e){return{runtimeState:e.InstallGuideStore.runtimeState,deployState:e.InstallGuideStore.deployState,namespace:e.InstallGuideStore.namespace,upgradeType:e.DeployStore.upgradeType,smoothSelectService:e.InstallGuideStore.smoothSelectService}}))(Bt=function(e){(0,E.Z)(n,e);var t=Wt(n);function n(){var e,a;(0,y.Z)(this,n);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return a=t.call.apply(t,he()(e=[this]).call(e,o)),(0,I.Z)((0,Z.Z)(a),"container",re.createRef()),(0,I.Z)((0,Z.Z)(a),"state",{menuList:[],openKeys:[],allServices:[],searchValue:"",searchData:[],searchFlag:!1,productNameFilter:""}),(0,I.Z)((0,Z.Z)(a),"firstRender",!0),(0,I.Z)((0,Z.Z)(a),"serviceSelected",(function(e){var t=a.props,n=t.runtimeState,r=t.deployState,o=t.clusterId,s=t.upgradeType,l=t.productName,i=t.smoothSelectService;if((0,Ht.U)(n,r)){var c,u=!1;if(null!=i&&i.ServiceAddr)u=null==i||null===(c=i.ServiceAddr)||void 0===c||!c.UnSelect;"mysql"===e.ServiceDisplay&&"smooth"===s&&a.props.actions.setSqlErro({product_name:l,cluster_id:o,final_upgrade:u,ip:e.ServiceAddr.IP.toString()}),a.props.updateServiceHostList({productName:a.props.selectedProduct.ProductName,serviceName:e.serviceKey,clusterId:o}),a.props.setSelectedConfigService(e)}})),(0,I.Z)((0,Z.Z)(a),"getProductInfo",(function(e){var t,n=e.deployMode,a=e.productNameFilter,r=e.productServicesInfo;return n===Vt.AUTO&&T()(r)?a?null===(t=X()(r).call(r,(function(e){return e.productName===a})))||void 0===t?void 0:t.content:r[0].content:r})),(0,I.Z)((0,Z.Z)(a),"getAllService",(function(e){var t=e.deployMode,n=a.state.productNameFilter,r=a.getProductInfo({deployMode:t,productNameFilter:n,productServicesInfo:e.productServicesInfo}),o=[];for(var s in r)for(var l in r[s])o.push(l);a.setState({allServices:o})})),(0,I.Z)((0,Z.Z)(a),"getAllOpenKeys",(function(e){if(!e)return[];var t=(0,bt.Z)(a.state.openKeys);for(var n in e)-1===W()(t).call(t,n)&&t.push(n);return t})),(0,I.Z)((0,Z.Z)(a),"loadMenu",(function(e){if(!e)return null;var t=ae()(e),n=a.props.deployMode;return A()(t).call(t,(function(t,r){return re.createElement(Qt,{className:qt()({"pl-20":n===Vt.AUTO}),key:t,title:t},a.loadSonMenu(e[t],r))}))})),(0,I.Z)((0,Z.Z)(a),"loadSonMenu",(function(e,t){var n=ae()(e);return A()(n).call(n,(function(t,n){return re.createElement(Jt,{onClick:function(){return a.serviceSelected(Yt(Yt({},e[t]),{},{serviceKey:t}))},key:t},e[t].ServiceDisplay)}))})),(0,I.Z)((0,Z.Z)(a),"handleSearch",(function(e){var t,n=a.state.searchData;n=[],K()(t=a.state.allServices).call(t,(function(t){-1!==W()(t).call(t,e)&&n.push(t)})),a.setState({searchData:n})})),(0,I.Z)((0,Z.Z)(a),"handleOpenChange",(function(e){a.setState({openKeys:e})})),(0,I.Z)((0,Z.Z)(a),"handleChange",(function(e){a.setState({searchValue:e},(function(){var t;-1!==W()(t=a.state.allServices).call(t,e)&&a.locateSearch(e)}))})),(0,I.Z)((0,Z.Z)(a),"locateSearch",(function(e){var t=a.props,n=t.deployMode,r=t.productServicesInfo,o=a.state.productNameFilter,s=a.getProductInfo({deployMode:n,productNameFilter:o,productServicesInfo:r}),l=ae()(s);K()(l).call(l,(function(t){var n=ae()(s[t]);K()(n).call(n,(function(n){var r;n===e&&(a.serviceSelected(Yt(Yt({},s[t][n]),{},{serviceKey:n})),a.setState({openKeys:he()(r=a.state.openKeys).call(r,[t]),searchFlag:!0}))}))}))})),(0,I.Z)((0,Z.Z)(a),"handleProdutNameFilter",(function(e){var t=a.props,n=t.deployState,r=t.runtimeState;if((0,Ht.U)(r,n)){var o=a.props.productServicesInfo,s=X()(o).call(o,(function(t){return t.productName===e})),l=a.getAllOpenKeys(s.content);a.setState({productNameFilter:e,openKeys:l},(function(){a.props.saveInstallInfo({ProductName:s.productName,ProductVersion:s.version}),a.props.setSelectedConfigService({})}))}})),a}return(0,S.Z)(n,[{key:"componentDidMount",value:function(){for(var e in this.props.productServicesInfo){var t;-1===W()(t=this.state.openKeys).call(t,e)&&this.state.openKeys.push(e)}this.setState({openKeys:this.state.openKeys}),this.getAllService(this.props)}},{key:"componentDidUpdate",value:function(){var e=this.props,t=e.productServicesInfo;if(e.deployMode===Vt.AUTO&&this.firstRender&&T()(t)){var n=t[0];this.props.saveInstallInfo({ProductName:n.productName,ProductVersion:n.version}),this.firstRender=!1}this.container.current.getElementsByClassName("ant-menu-item-selected").length>0&&this.state.searchFlag&&(this.container.current.scrollTo(0,this.container.current.getElementsByClassName("ant-menu-item-selected")[0].offsetTop),this.setState({searchFlag:!1}))}},{key:"UNSAFE_componentWillReceiveProps",value:function(e){var t,n=this,a=e.deployMode,r=e.productServicesInfo;if(a===Vt.AUTO&&T()(r))this.props.productServicesInfo!==r&&this.setState({productNameFilter:this.state.productNameFilter||r[0].productName},(function(){n.getAllService(e);var t=n.getProductInfo({deployMode:a,productNameFilter:n.state.productNameFilter,productServicesInfo:e.productServicesInfo}),r=n.getAllOpenKeys(t);n.setState({openKeys:r})}));else if(this.getAllService(e),"{}"!==z()(e.selectedService)&&-1===W()(t=this.state.openKeys).call(t,e.selectedService.Group)){var o=this.getAllOpenKeys(r);o.push(e.selectedService.Group),this.setState({openKeys:o})}else{var s=this.getAllOpenKeys(e.productServicesInfo);this.setState({openKeys:s})}}},{key:"render",value:function(){var e,t,n=this,a=this.props,r=a.productServicesInfo,o=a.deployMode,s=this.state.productNameFilter,l=A()(e=this.state.searchData).call(e,(function(e){return re.createElement($t,{key:e,value:e},e)}));return re.createElement("div",{style:{width:this.props.width},className:"step-three-side-container"},re.createElement("div",{className:"search-box",style:{padding:"14px 20px 10px",borderRight:"1px solid #DDDDDD",position:"relative"}},o===Vt.AUTO&&T()(r)&&re.createElement(ht.Z,{value:s,style:{width:"138px"},onChange:this.handleProdutNameFilter},A()(r).call(r,(function(e){return re.createElement($t,{key:e.productName,value:e.productName},e.productName," ",e.version)}))),re.createElement("div",{style:{position:"relative",width:"100%",marginTop:o===Vt.AUTO?"12px":0}},re.createElement(ht.Z,{showSearch:!0,value:this.state.searchValue||void 0,placeholder:"输入服务名",style:{fontSize:12,width:"100%",height:28},defaultActiveFirstOption:!1,showArrow:!1,filterOption:!1,onSearch:this.handleSearch,onChange:this.handleChange,notFoundContent:null},l),re.createElement(ce.Z,{style:{position:"absolute",top:"8px",right:"5px",transform:"translate(-50%,0)",color:"#999999"},type:"search"}))),re.createElement("div",{ref:this.container,className:"menu-box",style:{overflow:"scroll",borderRight:"1px solid #dddddd"}},re.createElement(Mt.Z,{className:"c-sidenav__menu",onOpenChange:function(e){return n.handleOpenChange(e)},openKeys:this.state.openKeys,selectedKeys:[this.props.selectedService.serviceKey],mode:"inline"},o===Vt.MANUAL&&this.loadMenu(r),o===Vt.AUTO&&T()(r)&&this.loadMenu(null===(t=X()(r).call(r,(function(e){return e.productName===s})))||void 0===t?void 0:t.content))))}}]),n}(re.Component))||Bt;var en=n(92762),tn=n.n(en),nn=n(94198),an=n.n(nn),rn=n(79855),on=n(24105),sn=n(89055),ln=n(60331),cn=n(59314),un=n(26712),pn=n(2307),dn=n(91966),fn=n.n(dn);const mn=function(e){var t=e.filteredItems,n=e.onItemSelectAll,a=e.onItemSelect,r=e.selectedKeys,o=e.renderItem,s=e.direction,l=[{title:"",render:function(e){return o(e)}}],i={onSelectAll:function(e,t){var a,o=A()(a=F()(t).call(t,(function(e){return e}))).call(a,(function(e){return e.key})),s=e?fn()(o,r):fn()(r,o);n(s,e)},onSelect:function(e,t){var n=e.key;a(n,t)},getCheckboxProps:function(e){return{disabled:e.disabled}},selectedRowKeys:r},c={size:"small",total:t.length,showSizeChanger:!0,showQuickJumper:!0};return re.createElement(pn.default,{className:"dt-table-last-row-noborder dt-table-fixed-contain-footer",rowSelection:i,showHeader:!1,rowKey:"id","data-testid":s,columns:l,scroll:{y:!0},dataSource:t,size:"small",onRow:function(e){var t=e.key;return{onClick:function(){a(t,!Se()(r).call(r,t))}}},style:{height:313},pagination:c})};function hn(e,t){var n=ae()(e);if(l()){var a=l()(e);t&&(a=F()(a).call(a,(function(t){return c()(e,t).enumerable}))),n.push.apply(n,a)}return n}function vn(e){for(var t=1;t<arguments.length;t++){var n,a,r=null!=arguments[t]?arguments[t]:{};t%2?K()(n=hn(Object(r),!0)).call(n,(function(t){(0,I.Z)(e,t,r[t])})):p()?f()(e,p()(r)):K()(a=hn(Object(r))).call(a,(function(t){h()(e,t,c()(r,t))}))}return e}const gn=function(e){var t=e.footerLeft,n=e.footerRight,a=e.render;return re.createElement(un.default,(0,v.Z)({className:"transfer-table"},e),(function(e){var r="left"===e.direction?t:n,o=vn(vn({},e),{},{footer:r,renderItem:a});return re.createElement(mn,o)}))};var yn,Sn=n(35969);function Zn(e,t){var n=ae()(e);if(l()){var a=l()(e);t&&(a=F()(a).call(a,(function(t){return c()(e,t).enumerable}))),n.push.apply(n,a)}return n}function En(e){for(var t=1;t<arguments.length;t++){var n,a,r=null!=arguments[t]?arguments[t]:{};t%2?K()(n=Zn(Object(r),!0)).call(n,(function(t){(0,I.Z)(e,t,r[t])})):p()?f()(e,p()(r)):K()(a=Zn(Object(r))).call(a,(function(t){h()(e,t,c()(r,t))}))}return e}function Pn(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}const Cn=(0,pe.$j)((function(e){return{initData:e.InstallGuideStore}}))(yn=function(e){(0,E.Z)(n,e);var t=Pn(n);function n(e){var a;return(0,y.Z)(this,n),a=t.call(this,e),(0,I.Z)((0,Z.Z)(a),"state",{targetKeys:[],dataList:[],selectedKeys:[],isCloud_state:a.props.isCloud,cloudHost:"",showBtn:!1,isTransferChange:!1,showAutoBtn:!1,isRerro:a.props.is_Rerro,isLerro:a.props.is_Lerro}),(0,I.Z)((0,Z.Z)(a),"computeRealTargetKeys",(function(e){var t,n,r=a.props.DeployProp.upgradeType,o=a.props.initData.selectedService,s=[],l=[];"smooth"===r?l=o.ServiceAddr.Select?A()(n=(0,bt.Z)(o.ServiceAddr.Select)).call(n,(function(e){return e.IP})):[]:l=e.existIp;e.isCloud===a.state.isCloud_state&&K()(l).call(l,(function(e){var t;K()(t=a.props.hostList).call(t,(function(t){t.ip===e&&s.push(t.id)}))})),a.setState({targetKeys:"smooth"==r?null===(t=a.props)||void 0===t?void 0:t.smoothTarget:s},(function(){a.initDataRight(s)}))})),(0,I.Z)((0,Z.Z)(a),"initData_left",(function(e){a.setState({selectedKeys:[],dataList:e})})),(0,I.Z)((0,Z.Z)(a),"initDataRight",(function(e){a.setState({selectedKeys:[],targetKeys:e})})),(0,I.Z)((0,Z.Z)(a),"handleChange",(function(e,t,n){var r,o=a.props.installGuideProp.selectedService,s=a.props.DeployProp,l=s.forcedUpgrade,i=s.isFirstSmooth;Se()(l).call(l,o.serviceKey)&&i&&((null===(r=a.props.hostList)||void 0===r?void 0:r.length)===e.length?a.setState({isRerro:!1,isLerro:!0}):0===e.length?a.setState({isLerro:!1,isRerro:!0}):a.setState({isLerro:!1,isRerro:!1}));if(e.length>a.props.maxSelected){le.Z.error("IP数量限制".concat(a.props.maxSelected,",目前超出限制！"));var c=F()(e).call(e,(function(e){return!Se()(n).call(n,e)}));a.setState({targetKeys:c})}else a.props.handleResourceSubmit({isCloud:a.state.isCloud_state,hosts:a.state.isCloud_state||!a.props.hasInstance?a.state.cloudHost:e}),a.setState({showBtn:!0,isTransferChange:!1},(function(){a.initDataRight(e)}))})),(0,I.Z)((0,Z.Z)(a),"handleSelect",(function(e,t){var n;a.setState({selectedKeys:he()(n=[]).call(n,(0,bt.Z)(e),(0,bt.Z)(t))})})),(0,I.Z)((0,Z.Z)(a),"handleChangeSwitch",(function(){a.props.handleResourceSubmit({isCloud:a.state.isCloud_state,hosts:a.state.isCloud_state||!a.props.hasInstance?a.state.cloudHost:a.state.targetKeys})})),(0,I.Z)((0,Z.Z)(a),"useCloudChange",(function(e){a.setState({isCloud_state:e,showBtn:!0},(function(){a.handleChangeSwitch(),a.computeRealTargetKeys(a.props)}))})),(0,I.Z)((0,Z.Z)(a),"handleCloudHostChange",(function(e){a.setState({cloudHost:e.target.value,showBtn:!0})})),(0,I.Z)((0,Z.Z)(a),"handleCancel",(function(e){var t;a.props.handleCancel();var n=[];K()(t=a.props.hostList).call(t,(function(e){var t;Se()(t=a.props.existIp).call(t,e.ip)&&n.push(e.id)})),a.setState({selectedKeys:[],targetKeys:n,isCloud_state:a.props.isCloud})})),(0,I.Z)((0,Z.Z)(a),"handleInputBlur",(function(){a.props.handleResourceSubmit({isCloud:a.state.isCloud_state,hosts:a.state.isCloud_state||!a.props.hasInstance?a.state.cloudHost:a.state.targetKeys})})),(0,I.Z)((0,Z.Z)(a),"filterOption",(function(e,t){var n;return W()(n=t.ip).call(n,e)>-1})),(0,I.Z)((0,Z.Z)(a),"handleGetAutoConfig",(function(){Sn.Z.getAutoConfig({productName:a.props.selectedProduct.ProductName,serviceName:a.props.serviceKey,productVersion:a.props.selectedProduct.ProductVersion}).then((function(e){if(0===e.data.code){var t=a.props.installGuideProp.baseClusterId;a.props.actions.getProductServicesInfo({productName:a.props.installGuideProp.selectedProduct.ProductName,productVersion:a.props.installGuideProp.selectedProduct.ProductVersion,unSelectService:a.props.installGuideProp.unSelectedServiceList,baseClusterId:-1===t?void 0:t,clusterId:a.props.installGuideProp.clusterId},(function(e){for(var t in e)for(var n in e[t])n===a.props.installGuideProp.selectedService.serviceKey&&a.props.actions.setSelectedConfigService(En(En({},e[t][n]),{},{serviceKey:n}));a.props.actions.updateServiceHostList({productName:a.props.installGuideProp.selectedProduct.ProductName,serviceName:a.props.installGuideProp.selectedService.serviceKey})})),a.setState({showAutoBtn:!1}),le.Z.success("配置完成！")}else le.Z.error("配置失败！")}))})),(0,I.Z)((0,Z.Z)(a),"handleAutoConfig",(function(){a.setState({showAutoBtn:!0});var e=(0,Z.Z)(a);ie.Z.confirm({title:"确定使用自动配置吗？",content:"系统将会为该服务自动分配主机。",icon:re.createElement(ce.Z,{type:"exclamation-circle",theme:"filled"}),okType:"danger",onOk:function(){e.handleGetAutoConfig()},onCancel:function(){e.setState({showAutoBtn:!1})}})})),(0,I.Z)((0,Z.Z)(a),"trasnferItemRender",(function(e){var t,n=X()(t=window.hostRoleMap).call(t,(function(t){return t.ip===e}));n||(n={});var a=n.role_info,r=void 0===a?[]:a;return re.createElement("span",null,re.createElement("span",null,e),re.createElement("span",{style:{marginLeft:"20px"}},A()(r).call(r,(function(e,t){return re.createElement(ln.Z,{key:t,style:{borderRadius:"11px"}},e.role_name)}))))})),a}return(0,S.Z)(n,[{key:"componentDidMount",value:function(){var e,t=this,n=this.props.DeployProp.upgradeType;this.props.hasInstance?this.setState({targetKeys:"smooth"==n?null===(e=this.props)||void 0===e?void 0:e.smoothTarget:this.props.targetKeys,selectedKeys:this.props.selectedKeys},(function(){t.initDataRight()})):this.setState({cloudHost:this.props.existIp.toString()||""})}},{key:"componentDidUpdate",value:function(e){var t=this,n=this.props.DeployProp.upgradeType;if(!(0,Ee.isEqual)(this.props,e)){var a,r;if(this.state.isTransferChange&&this.props.hasInstance)return void this.setState({isTransferChange:!1});if(this.computeRealTargetKeys(this.props),!this.props.hasInstance)return void this.setState({cloudHost:this.props.existIp.toString()||""});if(this.setState({dataList:[],selectedKeys:[]},(function(){t.setState({isCloud_state:t.props.isCloud,cloudHost:t.props.isCloud?t.props.existIp.toString():""})})),(null===(a=this.props)||void 0===a?void 0:a.smoothTarget)!==(null==e?void 0:e.smoothTarget))this.setState({targetKeys:"smooth"==n?null===(r=this.props)||void 0===r?void 0:r.smoothTarget:this.props.targetKeys});this.props.is_Lerro!==e.is_Lerro&&this.setState({isLerro:this.props.is_Lerro}),this.props.is_Rerro!==e.is_Rerro&&this.setState({isRerro:this.props.is_Rerro}),this.initData_left(this.props.hostList)}}},{key:"render",value:function(){var e=this,t=this.state,n=t.dataList,a=t.isCloud_state,r=t.targetKeys,o=t.isRerro,s=t.isLerro,l=this.props.installGuideProp,i=l.sqlErro,c=l.selectedService,u=this.props.DeployProp,p=u.forcedUpgrade,d=u.upgradeType,f=(ue.Z,this.handleAutoConfig,this.state.showAutoBtn,this.props),m=f.selectedProduct.Status,h=f.Instance;!a&&"undeployed"===m&&(void 0===h?{}:h).MaxReplica;return re.createElement("div",{className:"resource-container"},re.createElement("div",null,this.props.hasInstance&&re.createElement(Lt.Z,{style:{marginBottom:18,display:"flex",alignItems:"center"}},re.createElement("div",{className:"ml-10 mr-20",style:{fontSize:12}},"使用外部主机:"),re.createElement("div",null,re.createElement(cn.Z,{style:{marginTop:"-3px"},className:"switch",checked:this.state.isCloud_state,onChange:function(t){e.useCloudChange(t)}})))),this.state.isCloud_state||!this.props.hasInstance?re.createElement("div",null,re.createElement(Lt.Z,{style:{display:"flex"}},re.createElement("div",{style:{textAlign:"right",paddingRight:20,width:116}},"IP地址:"),re.createElement("div",null,re.createElement(yt.Z.TextArea,{style:{width:500},value:this.state.cloudHost,onBlur:this.handleInputBlur,onChange:function(t){return e.handleCloudHostChange(t)},placeholder:"可填写多个IP地址，多个IP地址用英文逗号分割开，如172.10.16.2,172.10.20.6。"}),i&&"mysql"===c.serviceKey&&re.createElement("div",{className:"errRight",style:{display:"block"}},i)))):!this.props.isKubernetes&&re.createElement(Lt.Z,null,re.createElement(gn,{disabled:!(null!=p&&Se()(p).call(p,c.serviceKey)||"smooth"!==d),rowKey:function(e){return e.id},dataSource:n,showSearch:!0,onChange:this.handleChange,filterOption:this.filterOption,selectedKeys:this.state.selectedKeys,targetKeys:r,render:function(t){return e.trasnferItemRender(t.ip)},onSelectChange:this.handleSelect,listStyle:{flex:1,height:450}}),s&&re.createElement("span",{className:"errRight"},"首次平滑升级本服务，请至少保留一台主机"),o&&re.createElement("span",{className:"errLeft"},"请至少选择一台主机")))}}]),n}(re.Component))||yn;var In=n(39392),_n=n.n(In),bn=n(51298);function kn(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}var Nn=function(e){(0,E.Z)(n,e);var t=kn(n);function n(){return(0,y.Z)(this,n),t.apply(this,arguments)}return(0,S.Z)(n,[{key:"render",value:function(){var e=this,t=this.props,n=t.defaultvalue,a=t.inputDisabled,r=t.title,o=t.iconType,s=t.disabled;if(/password/.test(r.toLowerCase()))return re.createElement("span",{style:{display:"inline-flex"}},re.createElement(yt.Z,{type:o?"textarea":/password/.test(r.toLowerCase())?"password":"textarea",className:"param-input-textarea",value:n,onChange:function(t){return e.props.onChange(t)},disabled:a}),s?null:re.createElement("span",{className:"afteron",onClick:a?null:function(){return e.props.tooltipOnClick()}},re.createElement(gt.Z,{title:"恢复默认值"},re.createElement(ce.Z,{type:"undo"}))));var l=bn.Z.Paragraph,i=a?"focus":"hover",c=/password/.test(r.toLocaleLowerCase())?i:"hover";return re.createElement(gt.Z,{trigger:n?c:"focus",arrowPointAtCenter:!0,title:function(){return re.createElement(l,{copyable:!0,style:{color:"#fff"}},n)}},re.createElement("span",{style:{display:"inline-flex"}},re.createElement(yt.Z.TextArea,{className:"param-input-textarea",value:n,onBlur:function(t){return e.props.onBlur(t)},onChange:function(t){return e.props.onChange(t)},disabled:a,style:{height:32}}),s?null:re.createElement("span",{className:"afteron",onClick:a?null:function(){return e.props.tooltipOnClick()}},re.createElement(gt.Z,{title:"恢复默认值"},re.createElement(ce.Z,{type:"undo"})))))}}]),n}(re.Component);const Dn=vt.Z.create()(Nn);var wn,Ln=n(97538),xn=n(81354),Tn=n(40537),On=n(60558);function An(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}var Gn=ht.Z.Option,Vn={labelCol:{xs:{span:24},sm:{span:6}},wrapperCol:{xs:{span:24},sm:{span:16}}},Rn=(0,pe.$j)((function(e){return{runtimeState:e.InstallGuideStore.runtimeState}}),(function(e){return{actions:(0,de.DE)(D()({},{editRuntimeState:lt}),e)}}))(wn=function(e){(0,E.Z)(n,e);var t=An(n);function n(){var e,a;(0,y.Z)(this,n);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return a=t.call.apply(t,he()(e=[this]).call(e,o)),(0,I.Z)((0,Z.Z)(a),"disabledLink",[]),(0,I.Z)((0,Z.Z)(a),"state",{changeRecorder:[],localState:{},checkVisible:!1,iconType:0,nowTitle:"",password_key:"",hostVisible:!1,linkIndex:void 0,linkName:"",changeHosts:[],configEditState:"normal",beforeEditConfig:{},editFiled:[],isShowErro:!1,isUnlinkHost:!1}),(0,I.Z)((0,Z.Z)(a),"initLocalState",(function(){var e=a.props.config,t={};for(var n in e)!e[n].Value&&""!==e[n].Value||"string"!=typeof e[n].Value||t[n]||(t[n]="".concat(e[n].Value));a.setState({localState:t})})),(0,I.Z)((0,Z.Z)(a),"addItem",(function(e,t,n){var r,o=a.props.config;if(a.setState({changeRecorder:he()(r=[]).call(r,(0,bt.Z)(a.state.changeRecorder),[e])}),"string"==typeof o[e].Value){var s=[{field:o[e].Value,hosts:""},{field:o[e].Value,hosts:""}];a.props.setConfig(e,s)}else o[e].Value.push({field:o[e].Value[0].field,hosts:""}),a.setState({isShowErro:!0}),a.props.setConfig(e,o[e].Value)})),(0,I.Z)((0,Z.Z)(a),"removeItem",(function(e,t,n){var r=a.props.config;if(r[e].Value.length>2){var o=r[e].Value;tn()(o).call(o,t,1),a.props.setConfig(e,o)}else{var s=r[e].Value[0].field;a.props.setConfig(e,s),a.props.handleParamBlur(r[e].Value,"Config.".concat(e,".Value")),a.props.changeHosts()}})),(0,I.Z)((0,Z.Z)(a),"handleInputChange",(function(e,t,n){if(e.target.value!==t){var r,o="Config.".concat(n,".Value"),s=(0,bt.Z)(a.state.editFiled);-1===W()(s).call(s,o)&&(s.push(o),a.setState({editFiled:s})),a.setState({changeRecorder:he()(r=[]).call(r,(0,bt.Z)(a.state.changeRecorder),[n])}),a.props.saveParamValue(e.target.value,o)}})),(0,I.Z)((0,Z.Z)(a),"handleInputArrayChange",(function(e,t,n,r){var o,s,l,i=a.props.config,c=A()(o=(0,bt.Z)(i[t].Value)).call(o,(function(e){return e.field}));r||(c.length>0&&Se()(c).call(c,e.target.value)?a.setState({isShowErro:!0}):a.setState({isShowErro:!1}));var u={field:e.target.value,hosts:i[t].Value[n].hosts?i[t].Value[n].hosts:""};tn()(s=i[t].Value).call(s,n,1,u),a.setState({changeRecorder:he()(l=[]).call(l,(0,bt.Z)(a.state.changeRecorder),[t])}),a.props.setConfig(t,i[t].Value),a.props.saveParamValue(i[t].Value,"Config.".concat(t,".Value")),r&&a.props.handleParamBlur(i[t].Value,"Config.".concat(t,".Value"))})),(0,I.Z)((0,Z.Z)(a),"replacePwd",(function(e,t){var n;a.setState({changeRecorder:he()(n=[]).call(n,(0,bt.Z)(a.state.changeRecorder),[t])}),a.props.saveParamValue(e,"Config.".concat(t,".Value"))})),(0,I.Z)((0,Z.Z)(a),"updateIconType",(function(e){var t;a.setState({changeRecorder:he()(t=[]).call(t,(0,bt.Z)(a.state.changeRecorder),[e])}),a.props.saveParamValue(1,"Config.".concat(e,".iconType"))})),(0,I.Z)((0,Z.Z)(a),"resetIcontype",(function(e){var t;a.setState({changeRecorder:he()(t=[]).call(t,(0,bt.Z)(a.state.changeRecorder),[e])}),a.props.saveParamValue(0,"Config.".concat(e,".iconType"))})),(0,I.Z)((0,Z.Z)(a),"renderNode",(function(e){var t=a.state.isShowErro,n=a.props,r=n.config,o=n.noHosts,s=n.installGuideProp,l=void 0===s?{}:s,i=n.repeatParams,c=l.installType,u=0,p=[],d="normal"===e,f=function(e){var n;if(!r[e].Value&&""!==r[e].Value||"string"!=typeof r[e].Value){if(T()(r[e].Value)){var s;p.push(re.createElement("div",null,A()(s=r[e].Value).call(s,(function(n,s){var l,c,u,p,f;return r[e].Value.length>1?re.createElement(Lt.Z,{style:{marginBottom:20},key:s},re.createElement(xt.Z,{span:10,className:"param-input-label"},0===s&&re.createElement("span",null,e,"："),0===s&&o===e&&re.createElement("span",{style:{fontSize:"12px",color:"#ff5f5c",float:"left",marginLeft:"-130px",marginRight:"10px",marginBottom:"-40px"}},"存在主机未关联该参数")),re.createElement(xt.Z,{span:14,style:{textAlign:"left"}},re.createElement(Dn,{tooltipOnClick:function(){return a.props.resetParamFieldvalue({field_path:"Config.".concat(e,".Value"),type:"2",hosts:n.hosts})},onChange:function(t){return a.handleInputArrayChange(t,e,s)},onBlur:function(t){a.handleInputArrayChange(t,e,s,!0)},defaultvalue:"string"==typeof r[e].Value?r[e].Value:r[e].Value[s].field,title:e,iconType:r[e].iconType,inputDisabled:!(!d&&!/password/.test(e.toLowerCase()))&&!r[e].iconType}),/password/.test(e.toLowerCase())?a.renderIcon(e):null,!/password/.test(e.toLowerCase())&&re.createElement("span",{className:"operate-icon"},re.createElement(ce.Z,{className:"plus-icon",type:"plus",onClick:te()(l=a.addItem).call(l,(0,Z.Z)(a),e,s)}),re.createElement(ce.Z,{type:"link",className:"link-icon",onClick:te()(c=a.linkItem).call(c,(0,Z.Z)(a),e,s)}),s>0&&re.createElement(ce.Z,{className:"dynamic-delete-button",type:"delete",onClick:te()(u=a.removeItem).call(u,(0,Z.Z)(a),e,s)})),i&&0===s&&j()(i).call(i,(function(t){return t===e}))&&re.createElement("p",{style:{fontSize:"12px",color:"#ff5f5c"}},"参数值重复,请重新输入",t,"1"),t&&0===s&&re.createElement("p",{style:{fontSize:"12px",color:"#ff5f5c"}},"参数值重复,请重新输入",t),re.createElement(Lt.Z,{style:{marginTop:n.hosts&&n.hosts.split(",").length>0?"20px":"0"}},n.hosts&&A()(p=n.hosts.split(",")).call(p,(function(t,n){var r;return re.createElement("div",{key:n},re.createElement(xt.Z,{span:5,key:n,style:{marginRight:"12px"}},re.createElement(ln.Z,{visible:!0,closable:!0,onClose:te()(r=a.onCloseHost).call(r,(0,Z.Z)(a),e,t,s)},t)),n%3==2&&re.createElement(Lt.Z,{className:"splice-row"}))}))))):re.createElement(Lt.Z,{style:{marginBottom:20},key:s},re.createElement(xt.Z,{span:10,className:"param-input-label"},re.createElement("span",null,e,"：")),re.createElement(xt.Z,{span:14,style:{textAlign:"left"}},re.createElement(Dn,{tooltipOnClick:function(){return a.props.resetParamFieldvalue({field_path:"Config.".concat(e,".Value"),type:"1"})},onChange:function(t){return a.handleInputChange(t,r[e].Value,e)},defaultvalue:"string"==typeof r[e].Value?r[e].Value:r[e].Value[s].field,title:e,iconType:r[e].iconType,inputDisabled:!(!d&&!/password/.test(e.toLowerCase()))&&!r[e].iconType}),/password/.test(e.toLowerCase())?a.renderIcon(e):null,!/password/.test(e.toLowerCase())&&re.createElement("span",{className:"operate-icon"},re.createElement(ce.Z,{className:"plus-icon",type:"plus",onClick:te()(f=a.addItem).call(f,(0,Z.Z)(a),e,s)}))))}))))}}else u++,p.push(re.createElement(Lt.Z,{style:{marginBottom:20},key:u},re.createElement(xt.Z,{span:10,className:"param-input-label"},re.createElement("span",null,e,"：")),re.createElement(xt.Z,{span:14,style:{textAlign:"left"}},re.createElement(Dn,{tooltipOnClick:function(){return a.props.resetParamFieldvalue({field_path:"Config.".concat(e,".Value"),type:"1"})},onChange:function(t){return a.handleInputChange(t,r[e].Value,e)},defaultvalue:"string"==typeof r[e].Value?r[e].Value:r[e].Value[0].field,title:e,iconType:r[e].iconType,inputDisabled:!(!d&&!/password/.test(e.toLowerCase()))&&!r[e].iconType}),/password/.test(e.toLowerCase())?a.renderIcon(e):null,!/password/.test(e.toLowerCase())&&"kubernetes"!==c&&re.createElement("span",{className:"operate-icon"},re.createElement(ce.Z,{className:"plus-icon",type:"plus",onClick:te()(n=a.addItem).call(n,(0,Z.Z)(a),e,0)})))))};for(var m in r)f(m);return 0===p.length&&p.push(re.createElement("p",{key:"1"},"无")),p})),(0,I.Z)((0,Z.Z)(a),"onCloseHost",(function(e,t,n,r){var o,s=a.props.config,l=s[e].Value[n].hosts.split(","),i=W()(l).call(l,t);tn()(l).call(l,i,1);var c=l.join(",");a.setState({changeHosts:c.split(",")});var u={field:"string"==typeof s[e].Value?s[e].Value:s[e].Value[n].field,hosts:c};tn()(o=s[e].Value).call(o,n,1,u),a.props.handleParamBlur(s[e].Value,"Config.".concat(e,".Value")),a.props.setConfig(e,s[e].Value)})),(0,I.Z)((0,Z.Z)(a),"linkItem",(function(e,t,n){var r=a.props.config;a.props.getHostsList(),a.filterHosts(r[e].Value),a.setState({hostVisible:!0,linkIndex:t,linkName:e.split(".")[0],changeHosts:[]})})),(0,I.Z)((0,Z.Z)(a),"runtimeEdit",(function(){a.setState({configEditState:"edit",beforeEditConfig:(0,Ee.cloneDeep)(a.props.config)}),a.props.actions.editRuntimeState("edit")})),(0,I.Z)((0,Z.Z)(a),"runtimeCancel",(function(){a.props.setAllConfig("Config",a.state.beforeEditConfig);var e=a.contrastAndReturnEditData(a.props.config,a.state.beforeEditConfig);a.setState({configEditState:"normal"}),a.props.actions.editRuntimeState("normal"),"{}"!==z()(e)&&a.props.saveAllConfig("Config",e,a.state.editFiled)})),(0,I.Z)((0,Z.Z)(a),"runtimeSave",(function(){var e=a.props,t=e.config,n=e.encryptInfo,r=e.hostsSelectList,o=a.state,s=o.password_key,l=o.isShowErro,i=[];if(l)le.Z.warning("参数值重复,请重新输入");else{for(var c in t){var u;if(T()(t[c].Value))if(K()(u=t[c].Value).call(u,(function(e){e.hosts&&i.push(e.hosts)})),i.length!==r.length)return void le.Z.warning("存在主机未关联改参数");if(t[c].iconType)return void le.Z.warning("请先上锁")}a.setState({configEditState:"normal"});var p=a.contrastAndReturnEditData(a.state.beforeEditConfig,a.props.config);if(a.props.actions.editRuntimeState("normal"),"{}"!==z()(p)){if(s&&"sm2"===n.encrypt_type){var d={securityKey:xn.MD5(s),iv:"1234567890123456"};for(var f in p)if(W()(f).call(f,"password")>-1){var m=a.decrypt(p[f].Default,d),h=a.decrypt(p[f].Value,d);p[f].Default=(0,On.ON)(m,n.encrypt_public_key),p[f].Value=(0,On.ON)(h,n.encrypt_public_key)}}a.props.saveAllConfig("Config",p,a.state.editFiled,!0)}}})),(0,I.Z)((0,Z.Z)(a),"onChangeHosts",(function(e){a.setState({changeHosts:e})})),(0,I.Z)((0,Z.Z)(a),"contrastAndReturnEditData",(function(e,t){var n={};for(var a in t){var r,o;(null===(r=t[a])||void 0===r?void 0:r.Value)!=(null===(o=e[a])||void 0===o?void 0:o.Value)&&(n[a]=t[a])}return n})),a}return(0,S.Z)(n,[{key:"componentDidMount",value:function(){this.initLocalState()}},{key:"componentDidUpdate",value:function(e){(0,Ee.isEqual)(e.config,this.props.config)||this.initLocalState()}},{key:"filterHosts",value:function(e){var t=[];T()(e)&&A()(e).call(e,(function(e,n){var a=e.hosts&&e.hosts.split(",");if(a&&a.length>=1)for(var r in a)""!==a[r]&&"string"==typeof a[r]&&t.push(a[r]);return t})),this.disabledLink=t}},{key:"renderIcon",value:function(e){var t,n,a=this.state.configEditState;return this.props.config[e].iconType?re.createElement(ce.Z,{type:"unlock",theme:"filled",style:{fontSize:20,marginLeft:"20px"},onClick:te()(t=this.closeKey).call(t,this,e)}):"normal"==a?re.createElement(gt.Z,{placement:"top",title:"请先开放编辑"},re.createElement(ce.Z,{type:"lock",theme:"filled",style:{fontSize:20,cursor:"pointer",marginLeft:"20px"}})):re.createElement(ce.Z,{type:"lock",theme:"filled",style:{fontSize:20,cursor:"pointer",marginLeft:"20px"},onClick:te()(n=this.saveKey).call(n,this,e)})}},{key:"saveKey",value:function(e){this.setState({checkVisible:!0,nowTitle:e})}},{key:"closeKey",value:function(e){var t=this,n=this.props.config,a=this.props.form.setFieldsValue,r=this.state.password_key,o=n[e].Value;""==o&&(o="45d3161f8aa54588ab3901fa954cc01a");var s={securityKey:xn.MD5(r),iv:"1234567890123456"},l=this.encrypt(o,s);this.replacePwd(l,e),dt()((function(){t.resetIcontype(e)}),0),a({input_password:""})}},{key:"checkPassWord",value:function(){var e=this,t=this.props.form,n=t.getFieldValue,a=t.setFieldsValue,r=this.state.nowTitle,o=this.props.config,s=n("input_password"),l={securityKey:xn.MD5(s),iv:"1234567890123456"},i=this.decrypt(o[r].Value,l);"45d3161f8aa54588ab3901fa954cc01a"==i?(i="",this.replacePwd(i,r),this.setState({checkVisible:!1,iconType:1,password_key:s},(function(){a({input_password:""}),e.updateIconType(r)}))):i?(this.replacePwd(i,r),this.setState({checkVisible:!1,iconType:1,password_key:s},(function(){a({input_password:""}),e.updateIconType(r)}))):le.Z.error("密码输入错误！请重新输入")}},{key:"encrypt",value:function(e,t){var n=xn.enc.Utf8.parse(t.securityKey),a=xn.enc.Utf8.parse(t.iv);return xn.AES.encrypt(e,n,{iv:a,mode:xn.mode.CBC,padding:xn.pad.Pkcs7}).toString()}},{key:"decrypt",value:function(e,t){var n=xn.enc.Utf8.parse(t.securityKey),a=xn.enc.Utf8.parse(t.iv);return xn.AES.decrypt(e,n,{iv:a,mode:xn.mode.CBC,padding:xn.pad.Pkcs7}).toString(xn.enc.Utf8)}},{key:"saveHosts",value:function(){var e,t,n=this.state,a=n.changeHosts,r=n.linkIndex,o=n.linkName,s=this.props.config,l=A()(e=(0,bt.Z)(s[o].Value)).call(e,(function(e){return e.field})),i=new(_n());l=F()(l).call(l,(function(e){return!i.has(e)&&i.set(e,1)})),s[o].Value.length!==l.length?this.setState({isShowErro:!0}):this.setState({isShowErro:!1});var c={field:"string"==typeof s[o].Value[r]?s[o].Value[r]:s[o].Value[r].field,hosts:0!==a.length?s[o].Value[r].hosts.length>1?s[o].Value[r].hosts+","+a.join(","):a.join(","):s[o].Value[r].hosts};tn()(t=s[o].Value).call(t,r,1,c),this.props.handleParamBlur(s[o].Value,"Config.".concat(o,".Value")),this.props.setConfig(o,s[o].Value),this.cancelLink()}},{key:"cancelLink",value:function(){this.setState({hostVisible:!1,linkIndex:null,linkName:"",changeHosts:[]})}},{key:"render",value:function(){var e,t,n=this,a=this.props.form,r=a.getFieldDecorator,o=a.setFieldsValue,s=this.state,l=s.checkVisible,i=s.hostVisible,c=s.changeHosts,u=s.configEditState,p=this.props,d=p.hostsSelectList,f=p.config,m=p.handleFileChange,h=p.selectedConfigFile,g=p.configFileList,y=this.disabledLink;return re.createElement("div",{className:"config-param_COMP"},re.createElement("div",null,"配置文件：",re.createElement(ht.Z,{placeholder:"请选择配置文件",value:h,style:{width:"264px",marginRight:"-50px"},onChange:function(e){return m(e)}},(null==g?void 0:g.length)&&re.createElement(Gn,{value:""},"全部"),A()(e=g||[]).call(e,(function(e){return re.createElement(Gn,{key:e},e)})))),"{}"===z()(f)?null:re.createElement("div",{className:"handle-btn"},"normal"===u?re.createElement("div",null,re.createElement(ue.Z,{type:"link",onClick:this.runtimeEdit},"编辑")):re.createElement("div",null,re.createElement(ue.Z,{type:"link",onClick:this.runtimeSave},"保存"),re.createElement(ue.Z,{type:"link",onClick:this.runtimeCancel},"取消"))),re.createElement("div",null,A()(t=this.renderNode(u)).call(t,(function(e){return e}))),re.createElement(ie.Z,{visible:l,title:"解锁提醒",onOk:function(){return n.checkPassWord()},onCancel:function(){return n.setState({checkVisible:!1},(function(){return o({input_password:""})}))},okText:"确认",cancelText:"取消"},re.createElement("form",{action:"",autoComplete:"off"},re.createElement(Tn.default,(0,v.Z)({},Vn,{label:"解锁密码"}),r("input_password",{})(re.createElement(yt.Z,{type:"password",autoComplete:"off"}))))),re.createElement(ie.Z,{title:"关联主机",className:"linkhosts-modal",visible:i,onOk:function(){return n.saveHosts()},onCancel:function(){return n.cancelLink()}},re.createElement("div",{className:"linkhosts-title"},re.createElement(ce.Z,{type:"info-circle",theme:"filled",style:{marginRight:"5px",color:"#3f87ff",verticalAlign:"middle"}}),re.createElement("span",null,"已关联的主机需要删除后才能再次关联")),re.createElement("div",{className:"linkhosts-content"},re.createElement(kt.Z.Group,{onChange:this.onChangeHosts,style:{width:"100%"},value:c},re.createElement(Lt.Z,null,d&&A()(d).call(d,(function(e,t){return y&&M()(y).call(y,(function(t){return t===e}))>-1?re.createElement(xt.Z,{span:8,key:t},re.createElement(kt.Z,{value:e,disabled:!0,style:{marginBottom:"20px"}},e)):re.createElement(xt.Z,{span:8,key:t},re.createElement(kt.Z,{value:e,style:{marginBottom:"20px"}},e))})))))))}}]),n}(re.Component))||wn;const Fn=Ln.default.create()(Rn);var Un;function Kn(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}const Bn=(0,pe.$j)((function(e){return{deployState:e.InstallGuideStore.deployState}}),(function(e){return{actions:(0,de.DE)(D()({},{editDeployState:it}),e)}}))(Un=function(e){(0,E.Z)(n,e);var t=Kn(n);function n(){var e,a;(0,y.Z)(this,n);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return a=t.call.apply(t,he()(e=[this]).call(e,o)),(0,I.Z)((0,Z.Z)(a),"state",{localState:{},configEditState:"normal",beforeEditConfig:{},editFiled:[]}),(0,I.Z)((0,Z.Z)(a),"initLocalState",(function(){var e=a.props,t=e.instanceData,n=e.isCloud,r=ae()(t),o={};"{}"===z()(t)||n||(K()(r).call(r,(function(e,n){var a;if(t[e]instanceof Array)K()(a=t[e]).call(a,(function(t,n){var a,r;o[he()(a="".concat(e,".")).call(a,n)]||(o[he()(r="".concat(e,".")).call(r,n)]="".concat(t))}));else if("string"==typeof t[e]||"number"==typeof t[e])o["".concat(e)]||(o["".concat(e)]=t[e]);else{var r;K()(r=ae()(t[e])).call(r,(function(n,a){var r,s;o[he()(r="".concat(e,".")).call(r,n)]||(o[he()(s="".concat(e,".")).call(s,n)]=t[e][n])}))}})),a.setState({localState:o}))})),(0,I.Z)((0,Z.Z)(a),"handleInputChange",(function(e,t,n){if(e.target.value!==t){var r="Instance.".concat(n),o=(0,bt.Z)(a.state.editFiled);-1===W()(o).call(o,r)&&(o.push(r),a.setState({editFiled:o})),a.props.saveParamValue(e.target.value,r,"Instance")}})),(0,I.Z)((0,Z.Z)(a),"handleBlur",(function(e,t){var n=a.state.localState;n[t].toString()!==e.target.value&&(a.props.handleParamBlur(e.target.value,"Instance.".concat(t)),a.setState({localState:D()({},n,(0,I.Z)({},t,e.target.value))}))})),(0,I.Z)((0,Z.Z)(a),"renderNode",(function(e){var t=a.props,n=t.instanceData,r=t.isCloud,o="normal"===e;if("{}"===z()(n)||r)return re.createElement("p",null,"无");var s=ae()(n),l=M()(s).call(s,(function(e){return"environment"===e}));return-1!==l&&(tn()(s).call(s,l,1),s.push("environment")),A()(s).call(s,(function(e,t){var r,s;return n[e]instanceof Array?re.createElement(Lt.Z,{style:{marginBottom:20},key:t},re.createElement(xt.Z,{span:10},re.createElement("p",{className:"param-input-label"},e,"：")),A()(r=n[e]).call(r,(function(t,r){return re.createElement(Lt.Z,{style:{marginBottom:10},key:r},re.createElement(xt.Z,{span:10}),re.createElement(xt.Z,{span:14},re.createElement(Dn,{inputDisabled:o,tooltipOnClick:function(){var t;return a.props.resetParamFieldvalue({field_path:he()(t="Instance.".concat(e,".")).call(t,r),type:"1"})},defaultvalue:t,onChange:function(t){var o;return a.handleInputChange(t,n[e],he()(o="".concat(e,".")).call(o,r))},disabled:"MaxReplica"===e,title:e})))}))):"string"==typeof n[e]||"number"==typeof n[e]?re.createElement(Lt.Z,{style:{marginBottom:20},key:t},re.createElement(xt.Z,{span:10},re.createElement("p",{className:"param-input-label"},e,"：")),re.createElement(xt.Z,{span:14},re.createElement(Dn,{inputDisabled:o,tooltipOnClick:function(){return a.props.resetParamFieldvalue({field_path:"Instance.".concat(e),type:"1"})},defaultvalue:n[e],onChange:function(t){return a.handleInputChange(t,n[e],"".concat(e))},disabled:"MaxReplica"===e,title:e}))):re.createElement(Lt.Z,{style:{marginBottom:20},key:t},A()(s=ae()(n[e])).call(s,(function(t,r){return re.createElement(Lt.Z,{style:{marginBottom:10},key:r},re.createElement(Lt.Z,null,re.createElement(xt.Z,{className:"param-input-label",span:10},"environment"===e&&re.createElement("i",{className:"emicon emicon-env mr-8"}),re.createElement("span",null,e,".",t,"：")),re.createElement(xt.Z,{span:14},re.createElement(Dn,{inputDisabled:o,tooltipOnClick:function(){var n;return a.props.resetParamFieldvalue({field_path:he()(n="Instance.".concat(e,".")).call(n,t),type:"1"})},onChange:function(n){var r;return a.handleInputChange(n,t,he()(r="".concat(e,".")).call(r,t))},defaultvalue:n[e][t],disabled:"MaxReplica"===e,title:e}))))})))}))})),(0,I.Z)((0,Z.Z)(a),"runtimeEdit",(function(){a.setState({configEditState:"edit",beforeEditConfig:(0,Ee.cloneDeep)(a.props.instanceData)}),a.props.actions.editDeployState("edit")})),(0,I.Z)((0,Z.Z)(a),"runtimeCancel",(function(){a.props.setAllConfig("Instance",a.state.beforeEditConfig);var e=a.contrastAndReturnEditData(a.props.instanceData,a.state.beforeEditConfig);a.setState({configEditState:"normal"}),a.props.actions.editDeployState("normal"),"{}"!==z()(e)&&a.props.saveAllConfig("Instance",e,a.state.editFiled)})),(0,I.Z)((0,Z.Z)(a),"runtimeSave",(function(){a.setState({configEditState:"normal"});var e=a.contrastAndReturnEditData(a.state.beforeEditConfig,a.props.instanceData);a.props.actions.editDeployState("normal"),"{}"!==z()(e)&&a.props.saveAllConfig("Instance",e,a.state.editFiled,!0)})),(0,I.Z)((0,Z.Z)(a),"contrastAndReturnEditData",(function(e,t){var n={};for(var a in t){var r=t[a];r!=e[a]&&(n[a]=r)}return n})),a}return(0,S.Z)(n,[{key:"componentDidMount",value:function(){this.initLocalState()}},{key:"componentDidUpdate",value:function(e){(0,Ee.isEqual)(e.instanceData,this.props.instanceData)||this.initLocalState()}},{key:"render",value:function(){var e=this.state.configEditState,t=this.props.instanceData,n=this.props.isCloud;return re.createElement("div",{className:"config-param_COMP"},"{}"===z()(t)||n?null:re.createElement("div",{className:"handle-btn"},"normal"===e?re.createElement("div",null,re.createElement(ue.Z,{type:"link",onClick:this.runtimeEdit},"编辑")):re.createElement("div",null,re.createElement(ue.Z,{type:"link",onClick:this.runtimeSave},"保存"),re.createElement(ue.Z,{type:"link",onClick:this.runtimeCancel},"取消"))),this.renderNode(e))}}]),n}(re.Component))||Un;var Mn=n(78241),Hn=n(90143);function jn(e,t){var n=ae()(e);if(l()){var a=l()(e);t&&(a=F()(a).call(a,(function(t){return c()(e,t).enumerable}))),n.push.apply(n,a)}return n}function qn(e){for(var t=1;t<arguments.length;t++){var n,a,r=null!=arguments[t]?arguments[t]:{};t%2?K()(n=jn(Object(r),!0)).call(n,(function(t){(0,I.Z)(e,t,r[t])})):p()?f()(e,p()(r)):K()(a=jn(Object(r))).call(a,(function(t){h()(e,t,c()(r,t))}))}return e}function zn(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}var Yn=rn.Z.TabPane,Wn=on.Z.Panel,$n=ht.Z.Option;const Jn=function(e){(0,E.Z)(n,e);var t=zn(n);function n(){var e,a;(0,y.Z)(this,n);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return a=t.call.apply(t,he()(e=[this]).call(e,o)),(0,I.Z)((0,Z.Z)(a),"state",{selectedHost:[],showBtnBox:!1,serviceInfo:{},changeFields:{},resetField:"",cancel:!1,isCommitHost:!1,activeTabpane:a.props.defaultActiveKey,Instate:{},hostsSelectList:[],activeKey:null,visibleConfig:!1,diffData:{},currentHosts:[],selectHost:"",configFileList:[],configFile:"",selectedConfigFile:"",encryptInfo:{},isRerro:!1,isLerro:!1,smoothTarget:[],isChange:!1}),(0,I.Z)((0,Z.Z)(a),"getPublicKey",(0,g.Z)(k().mark((function e(){var t,n;return k().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Pe.bS.getPublicKey();case 2:if(t=e.sent,0===(n=t.data).code){e.next=6;break}return e.abrupt("return");case 6:a.setState({encryptInfo:n.data});case 7:case"end":return e.stop()}}),e)})))),(0,I.Z)((0,Z.Z)(a),"getHostsList",(function(){var e,t,n=a.props,r=n.sname,o=n.pname,s=n.installGuideProp;r&&o&&Mn.get(he()(e=he()(t="/api/v2/product/".concat(o,"/service/")).call(t,r,"/selected_hosts?clusterId=")).call(e,s.clusterId),{}).then((function(e){0===(e=e.data).code?a.setState({hostsSelectList:e.data.hosts}):le.Z.error(e.msg)}))})),(0,I.Z)((0,Z.Z)(a),"getConfigFile",(function(){var e=a.props,t=e.pname,n=e.selectedProduct.ProductVersion,r=e.sname;Pe.BZ.getParamDropList({productName:t,productVersion:n,serviceName:r}).then((function(e){var t,n,r=(null===(t=e=e.data)||void 0===t||null===(n=t.data)||void 0===n?void 0:n.list)||[],o=r.length?r[0]:"";a.setState({configFileList:r,configFile:o})}))})),(0,I.Z)((0,Z.Z)(a),"configData",(function(e){if(e){var t=qn({},e);for(var n in t.Config)t.Config[n]=qn(qn({},t.Config[n]),{},{iconType:0});return t}return{}})),(0,I.Z)((0,Z.Z)(a),"handleResourceSubmit",(function(e){a.setState({isCommitHost:!0}),a.props.handleResourceSubmit(e)})),(0,I.Z)((0,Z.Z)(a),"getFieldValue",(function(e,t){var n=t.split("."),a=null;return K()(n).call(n,(function(t){a=a?a[t]:e.serviceData[t]})),a})),(0,I.Z)((0,Z.Z)(a),"afterParamFieldChange",(function(e,t,n){if("Instance"===n)return a.changeServiceInfo(t,e),void a.setState({changeFields:D()({},a.state.changeFields,(0,I.Z)({},t,e))});T()(e)?(a.setConfig(t.split(".")[1],e),a.setState({changeFields:D()({},a.state.changeFields,(0,I.Z)({},t,e))})):(a.changeServiceInfo(t,e),a.setState({changeFields:D()({},a.state.changeFields,(0,I.Z)({},t,e))}))})),(0,I.Z)((0,Z.Z)(a),"handleParamsBlur",(function(e,t){a.props.paramChangeBlur(t,e)})),(0,I.Z)((0,Z.Z)(a),"changeServiceInfo",(function(e,t){var n,r=(0,Ee.cloneDeep)(a.state.serviceInfo),o=e.split(".");o.length>2?r[o[0]][o[1]]instanceof Array?tn()(n=r[o[0]][o[1]]).call(n,an()(o[2]),1,t):r[o[0]][o[1]][o[2]]=t:r[o[0]][o[1]]=t;a.setState({serviceInfo:r})})),(0,I.Z)((0,Z.Z)(a),"resetParamFieldvalue",(function(e){ie.Z.confirm({title:"确认恢复此字段默认值吗？",icon:re.createElement(ce.Z,{type:"exclamation-circle",theme:"filled"}),okType:"danger",onOk:function(){a.props.resetParamFieldvalue(e,(function(t){var n;0===t.code&&(-1!==W()(n=ae()(a.state.changeFields)).call(n,e.field_path)&&delete a.state.changeFields[e.field_path],a.setState({resetField:e.field_path,showBtnBox:!0}))}))}})})),(0,I.Z)((0,Z.Z)(a),"syncHost",(function(e){a.setState({selectedHost:e})})),(0,I.Z)((0,Z.Z)(a),"handleCancel",(function(){a.setState({changeFields:{},showBtnBox:!1,cancel:!0}),a.props.handleCancel()})),(0,I.Z)((0,Z.Z)(a),"commitParamChange",(function(){a.props.commitParamChange(a.state.changeFields)})),(0,I.Z)((0,Z.Z)(a),"computeTransferIpList",(function(){var e=a.props.serviceData.ServiceAddr,t=void 0===e?{}:e,n=a.props.DeployProp,r=n.upgradeType,o=n.isFirstSmooth,s=[],l=[],i=a.props.hostList;if("smooth"!==r&&K()(i).call(i,(function(e){-1===W()(s).call(s,e.ip)&&e.ip&&(l.push({id:e.ip,ip:e.ip,key:e.ip}),s.push(e.ip))})),a.props.serviceData.Instance&&a.props.serviceData.Instance.UseCloud)return a.setState({currentHosts:l,selectHost:T()(null==t?void 0:t.IP)?null==t?void 0:t.IP[0]:""}),l;var c,u,p,d=t.Select?t.Select:[];A()(d).call(d,(function(e){var n;null!=t&&t.IP&&(null!=t&&Se()(n=t.IP).call(n,e.IP)&&(e.disabled=!0));return e}));var f=t.UnSelect?t.UnSelect:[];if(A()(f).call(f,(function(e){return e.disabled=!1,e})),"smooth"===r){var m,h,v,g=he()(m=[]).call(m,(0,bt.Z)(d),(0,bt.Z)(f));return K()(g).call(g,(function(e){l.push({id:e.IP,ip:e.IP,key:e.IP,disabled:!o&&e.disabled})})),a.setState({currentHosts:l,selectHost:null===(h=d[0])||void 0===h?void 0:h.IP,smoothTarget:A()(v=(0,bt.Z)(d)).call(v,(function(e){return e.IP}))}),l}var y=A()(c=he()(u=[]).call(u,(0,bt.Z)(d),(0,bt.Z)(f))).call(c,(function(e){return e.IP}));return K()(y).call(y,(function(e){-1===W()(s).call(s,e)&&e&&(l.push({id:e,ip:e,key:e}),s.push(e))})),a.setState({currentHosts:l,selectHost:null===(p=d[0])||void 0===p?void 0:p.IP}),l})),(0,I.Z)((0,Z.Z)(a),"setConfig",(function(e,t,n){var r=a.state.serviceInfo;n?r.Config[e].Value[n]=t:r.Config[e].Value=t,a.setState({serviceInfo:r})})),(0,I.Z)((0,Z.Z)(a),"changeCollapse",(function(e){a.setState({activeKey:e})})),(0,I.Z)((0,Z.Z)(a),"changeTabs",(function(e){a.initErro(),a.setState({activeTabpane:e}),"param"==e?(a.getHostsList(),a.setState({isChange:!0})):a.setState({isChange:!1})})),(0,I.Z)((0,Z.Z)(a),"initErro",(function(){var e=a.props.installGuideProp.selectedService,t=e.ServiceAddr,n=a.props.DeployProp,r=n.forcedUpgrade,o=n.isFirstSmooth;Se()(r).call(r,e.serviceKey)&&o?(t.UnSelect?a.setState({isLerro:!1}):a.setState({isLerro:!0}),t.Select?a.setState({isRerro:!1}):a.setState({isRerro:!0})):a.setState({isLerro:!1,isRerro:!1})})),(0,I.Z)((0,Z.Z)(a),"getConfDiff",(function(){var e=a.props,t=e.pname,n=e.selectedProduct.ProductVersion,r=e.sname,o=a.state,s=o.selectHost,l={file:o.configFile||"",ip:s||"",product_name:t,product_version:n,service_name:r};Pe.BZ.getConfDiff(l).then((function(e){var t=e.data,n=t.code,r=t.data,o=t.msg,s={before:"",after:""};0===n?s=qn({},r):le.Z.error(o),a.setState({diffData:s})}))})),(0,I.Z)((0,Z.Z)(a),"handleDispath",(function(){a.state.visibleConfig||a.getConfDiff(),a.setState({visibleConfig:!a.state.visibleConfig})})),(0,I.Z)((0,Z.Z)(a),"setAllConfig",(function(e,t){var n=a.state.serviceInfo;n[e]=t,a.setState({serviceInfo:n})})),(0,I.Z)((0,Z.Z)(a),"recursionObjKeyValue",(function(e,t,n){if(T()(t))K()(t).call(t,(function(t,a){var r;n.push({field_path:he()(r="".concat(e,".")).call(r,a),field:t})}));else for(var r in t){var o,s,l=t[r];if("string"==typeof l)n.push({field_path:he()(o="".concat(e,".")).call(o,r),field:l});else a.recursionObjKeyValue(he()(s="".concat(e,".")).call(s,r),l,n)}})),(0,I.Z)((0,Z.Z)(a),"handleFileChange",(function(e){a.setState({configFile:e},(function(){a.state.visibleConfig&&a.getConfDiff()}))})),(0,I.Z)((0,Z.Z)(a),"handleConfigFileChange",(function(e){a.setState({selectedConfigFile:e},(function(){a.getCurrentFileConf(e)}))})),(0,I.Z)((0,Z.Z)(a),"getCurrentFileConf",(function(e){var t=a.props.installGuideProp,n=t.clusterId,r=t.selectedProduct.ProductVersion,o=a.props,s=o.pname,l=o.sname;Pe.jy.getServiceGroupFile({productName:s,productVersion:r},{servicename:l,clusterId:n,file:e}).then((function(e){0===(e=e.data).code?a.setAllConfig("Config",e.data):le.Z.error(e.msg)}))})),(0,I.Z)((0,Z.Z)(a),"saveAllConfig",(function(e,t,n,r){var o=[];for(var s in t)if("Config"===e){var l=t[s].Value;"string"==typeof l?o.push({field_path:"Config.".concat(s,".Value"),field:l}):a.recursionObjKeyValue("Config.".concat(s,".Value"),l,o)}else{var i=t[s];"string"==typeof i?o.push({field_path:"Instance.".concat(s),field:i}):a.recursionObjKeyValue("Instance.".concat(s),i,o)}var c=a.props.installGuideProp,u=c.namespace,p=c.clusterId,d=a.props,f=d.pname,m=d.sname,h=[];K()(o).call(o,(function(e){Se()(n).call(n,e.field_path)&&h.push(qn(qn({},e),{},{namespace:u,clusterId:p}))})),Pe.jy.setParamConfigFieldValueTotal({productName:f,serviceName:m},h).then((function(e){0===(e=e.data).code?(r&&le.Z.success("保存成功"),a.props.getProductServicesInfo(!1),r&&a.handleDispath()):(le.Z.error(e.msg),a.props.getProductServicesInfo(!1))}))})),(0,I.Z)((0,Z.Z)(a),"defaultTabKey",(function(e){return e?"resource":"param"})),(0,I.Z)((0,Z.Z)(a),"handleDiffHost",(function(e){a.setState({selectHost:e},(function(){a.getConfDiff()}))})),a}return(0,S.Z)(n,[{key:"componentDidMount",value:function(){this.setState({serviceInfo:qn({},this.configData(this.props.serviceData))}),this.computeTransferIpList(),this.getPublicKey(),this.getConfigFile(),this.initErro()}},{key:"componentDidUpdate",value:function(e,t){var n=this;if(!(0,Ee.isEqual)(this.props.serviceData.serviceKey,e.serviceData.serviceKey)||this.state.isChange){var a=this.state.serviceInfo.Instance;this.setState({serviceInfo:qn({},this.configData(this.props.serviceData)),selectedConfigFile:"",Instate:a,cancel:!1,isCommitHost:!1},(function(){n.computeTransferIpList(),n.getConfigFile(),n.initErro(),n.setState({isChange:!1})}))}""!==this.state.resetField&&(this.changeServiceInfo(this.state.resetField,this.getFieldValue(this.props,this.state.resetField)),this.setState({resetField:""}))}},{key:"render",value:function(){var e,t,n=this,a=this.props.serviceData.ServiceAddr,r=this.state,o=r.activeKey,s=r.activeTabpane,l=r.visibleConfig,i=r.diffData,c=r.currentHosts,u=r.selectHost,p=r.configFile,d=r.configFileList,f=r.encryptInfo,m=r.selectedConfigFile,h=r.isRerro,v=r.isLerro,g=r.smoothTarget,y=re.createElement("div",{className:"extra-sider"},re.createElement(ht.Z,{value:u,onChange:this.handleDiffHost,placeholder:"选择主机",size:"small"},null==a||null===(e=a.IP)||void 0===e?void 0:A()(e).call(e,(function(e){return re.createElement($n,{key:e},e)}))),re.createElement("h2",null,"配置文件"),re.createElement("ul",{className:"extra-ul",onClick:function(e){return n.handleFileChange(e.target.title)}},A()(t=d||[]).call(t,(function(e){return re.createElement("li",{title:e,key:e,className:qt()("",{"extra-selected":e===p})},e)}))));return re.createElement("div",{className:"COMP_CONFIG_SERVICE",style:{position:"relative"}},re.createElement(sn.Z,{message:""}),re.createElement(rn.Z,{onChange:function(e){return n.changeTabs(e)},activeKey:s||this.defaultTabKey(!0)},re.createElement(Yn,{key:"resource",tab:"资源分配"},re.createElement(Cn,{hasInstance:!!this.props.serviceData.Instance,maxSelected:this.props.serviceData.Instance?this.props.serviceData.Instance.MaxReplica:9999,handleCancel:this.handleCancel,handleResourceSubmit:function(e){return n.handleResourceSubmit(e)},isCloud:!(!this.props.serviceData.Instance||!this.props.serviceData.Instance.UseCloud)&&this.props.serviceData.Instance.UseCloud,existIp:this.props.serviceData.ServiceAddr&&this.props.serviceData.ServiceAddr.IP||[],serviceKey:this.props.serviceData.serviceKey,selectedKeys:this.props.resourceState.selectedKeys||[],targetKeys:this.props.resourceState.targetKeys||[],syncHost:this.props.saveResourceState,hostList:c,selectedProduct:this.props.selectedProduct,Instance:this.state.Instate,installGuideProp:this.props.installGuideProp,DeployProp:this.props.DeployProp,actions:this.props.actions,smoothTarget:g,isKubernetes:this.props.isKubernetes,is_Lerro:v,is_Rerro:h})),re.createElement(Yn,{key:"param",tab:"参数配置"},re.createElement(on.Z,{activeKey:o,className:"mb-20",accordion:!0,onChange:function(e){return n.changeCollapse(e)}},re.createElement(Wn,{header:"运行配置",key:"1"},re.createElement(Fn,{resetParamFieldvalue:this.resetParamFieldvalue,saveParamValue:this.afterParamFieldChange,handleParamBlur:this.handleParamsBlur,config:this.state.serviceInfo.Config||{},setConfig:this.setConfig,saveAllConfig:this.saveAllConfig,setAllConfig:this.setAllConfig,hostsSelectList:this.state.hostsSelectList,noHosts:this.props.noHosts,repeatParams:this.props.repeatParams,changeHosts:this.props.changeHosts,getHostsList:this.getHostsList,installGuideProp:this.props.installGuideProp,encryptInfo:f,configFileList:d,configFile:p,selectedConfigFile:m,handleFileChange:this.handleConfigFileChange})),re.createElement(Wn,{header:"部署配置",key:"2"},re.createElement(Bn,{setAllConfig:this.setAllConfig,saveAllConfig:this.saveAllConfig,instanceData:this.state.serviceInfo.Instance||{},resetParamFieldvalue:this.resetParamFieldvalue,handleParamBlur:this.handleParamsBlur,saveParamValue:this.afterParamFieldChange,isCloud:!(!this.props.serviceData.Instance||!this.props.serviceData.Instance.UseCloud)&&this.props.serviceData.Instance.UseCloud})),re.createElement(Wn,{header:"依赖服务",key:"3"},this.state.serviceInfo.DependsOn?this.state.serviceInfo.DependsOn.toString():"无")))),l&&re.createElement(Hn.Z,{title:"配置确认（请确认保存后的配置，第一次部署的服务不存在当前版本）",visible:l,data:[i.before,i.after],extra:y,handleCancle:this.handleDispath,handleSubmit:this.handleDispath}))}}]),n}(re.Component);var Qn;function Xn(e,t){var n=ae()(e);if(l()){var a=l()(e);t&&(a=F()(a).call(a,(function(t){return c()(e,t).enumerable}))),n.push.apply(n,a)}return n}function ea(e){for(var t=1;t<arguments.length;t++){var n,a,r=null!=arguments[t]?arguments[t]:{};t%2?K()(n=Xn(Object(r),!0)).call(n,(function(t){(0,I.Z)(e,t,r[t])})):p()?f()(e,p()(r)):K()(a=Xn(Object(r))).call(a,(function(t){h()(e,t,c()(r,t))}))}return e}function ta(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}const na=(0,pe.$j)((function(e){return{smoothSelectService:e.InstallGuideStore.smoothSelectService}}))(Qn=function(e){(0,E.Z)(n,e);var t=ta(n);function n(e){var a;return(0,y.Z)(this,n),a=t.call(this,e),(0,I.Z)((0,Z.Z)(a),"getOldHostInfo",(function(){var e=a.props,t=e.installGuideProp,n=e.actions,r=e.productName;Pe.jy.getOldHostInfo({productName:t.selectedProduct.ProductName||r},{cluster_id:t.clusterId||t.baseClusterId}).then((function(e){0===(e=e.data).code?(le.Z.success("保存成功"),n.setOldHostInfo(e.data)):le.Z.error(e.msg)}))})),(0,I.Z)((0,Z.Z)(a),"getProductServicesInfo",(function(e){a.props.deployMode===Vt.AUTO?a.refreshDeployServiceForAuto():a.refreshDeployServiceForManual(e)})),(0,I.Z)((0,Z.Z)(a),"handlegetGlobalAutoConfig",(function(){a.setState({showGlobalBtn:!1});var e=a.props.installGuideProp.unSelectedServiceList.join(",");Pe.jy.getGlobalAutoConfig({productName:a.props.installGuideProp.selectedProduct.ProductName,productVersion:a.props.installGuideProp.selectedProduct.ProductVersion,carbon_thriftserver:e}).then((function(e){0===e.data.code?(le.Z.success("配置完成！"),a.setState({disabledAutoBtn:!1,showGlobalBtn:!0}),a.getProductServicesInfo(!0)):le.Z.error("配置失败！")}))})),(0,I.Z)((0,Z.Z)(a),"handleGlobalAutoConfig",(function(){a.setState({disabledAutoBtn:!0,showGlobalBtn:!0});var e=(0,Z.Z)(a);ie.Z.confirm({title:"确定全局自动配置资源吗？",content:"全局自动配置将会为该安装包下的所有服务自动分配主机，可能需要一点时间，请耐心等待。",icon:re.createElement(ce.Z,{type:"exclamation-circle",theme:"filled"}),okType:"danger",onOk:function(){e.handlegetGlobalAutoConfig()},onCancel:function(){e.setState({disabledAutoBtn:!1,showGlobalBtn:!0})}})})),(0,I.Z)((0,Z.Z)(a),"handleSetParamField",(function(e,t){a.props.actions.saveParamsFieldConfigState({key:t,value:e})})),(0,I.Z)((0,Z.Z)(a),"hadnleResetparamField",(function(e,t){Pe.jy.resetParamConfigFieldValue(ea(ea({},e),{},{productName:a.props.installGuideProp.selectedProduct.ProductName,serviceName:a.props.installGuideProp.selectedService.serviceKey,pid:a.props.installGuideProp.selectedProduct.ID,product_version:a.props.installGuideProp.selectedProduct.ProductVersion,namespace:a.props.installGuideProp.namespace})).then((function(e){0===(e=e.data).code?(le.Z.success("重置成功"),t(e),a.getProductServicesInfo(!1)):le.Z.error(e.msg)}))})),(0,I.Z)((0,Z.Z)(a),"commitParamChange",(function(e){Pe.jy.modifyProductConfigAll({productName:a.props.installGuideProp.selectedProduct.ProductName,serviceName:a.props.installGuideProp.selectedService.serviceKey},e).then((function(e){0===(e=e.data).code?(le.Z.success("保存成功"),a.getProductServicesInfo(!0)):le.Z.error(e.msg)}))})),(0,I.Z)((0,Z.Z)(a),"handleConfigCancel",(function(){a.getProductServicesInfo(!1)})),(0,I.Z)((0,Z.Z)(a),"handleResourceSubmit",(function(e){var t=a.props.installGuideProp,n=t.selectedService,r=t.clusterId;n.Instance&&e.isCloud!==(!!n.Instance&&(!!n.Instance.UseCloud&&n.Instance.UseCloud))?Pe.jy.setParamConfigFieldValue({productName:a.props.installGuideProp.selectedProduct.ProductName,serviceName:a.props.installGuideProp.selectedService.serviceKey},{field_path:"Instance.UseCloud",field:e.isCloud,namespace:a.props.installGuideProp.namespace,clusterId:r}).then((function(t){0===(t=t.data).code?a.submitHost(e.hosts):le.Z.error(t.msg)})):a.submitHost(e.hosts)})),(0,I.Z)((0,Z.Z)(a),"refreshDeployServiceForAuto",(function(){(0,a.props.refreshDeployService)((function(e){var t,n,r=a.props.installGuideProp,o=r.selectedProduct,s=r.selectedService,l=o.ProductName,i=s.serviceKey,c=X()(e).call(e,(function(e){return e.productName===l}));if(c){var u=L()(t=ae()(c.content)).call(t,(function(e,t){return ea(ea({},e),c.content[t])}),{}),p=A()(n=ae()(u)).call(n,(function(e){return ea(ea({},u[e]),{},{key:e})})),d=X()(p).call(p,(function(e){return e.key===i}));d&&a.props.actions.setSelectedConfigService(ea(ea({},d),{},{serviceKey:d.key}))}}))})),(0,I.Z)((0,Z.Z)(a),"refreshDeployServiceForManual",(function(e){var t=a.props.DeployProp,n=t.forcedUpgrade,r=t.upgradeType,o=a.props.installGuideProp.baseClusterId,s={productName:a.props.installGuideProp.selectedProduct.ProductName,productVersion:a.props.installGuideProp.selectedProduct.ProductVersion,unSelectService:a.props.installGuideProp.unSelectedServiceList,relynamespace:-1===o?void 0:o,namespace:a.props.installGuideProp.namespace,clusterId:a.props.installGuideProp.clusterId};"smooth"===r&&D()(s,{upgrade_mode:"smooth"}),a.props.actions.getProductServicesInfo(s,(function(t){for(var n in t)for(var r in t[n])r===a.props.installGuideProp.selectedService.serviceKey&&a.props.actions.setSelectedConfigService(ea(ea({},t[n][r]),{},{serviceKey:r}));e&&a.props.actions.updateServiceHostList({productName:a.props.installGuideProp.selectedProduct.ProductName,serviceName:a.props.installGuideProp.selectedService.serviceKey,clusterId:a.props.installGuideProp.clusterId})}),n)})),(0,I.Z)((0,Z.Z)(a),"checkSql",(function(e){var t,n=a.props.installGuideProp.clusterId,r=a.props,o=r.productName,s=r.smoothSelectService,l=!1;null!=s&&s.ServiceAddr&&(l=null==s||null===(t=s.ServiceAddr)||void 0===t||!t.UnSelect);a.props.actions.setSqlErro({product_name:o,cluster_id:n,final_upgrade:l,ip:e.toString()})})),(0,I.Z)((0,Z.Z)(a),"submitHost",(function(e){var t=a.props.DeployProp.upgradeType,n=a.props.installGuideProp,r=n.namespace,o=n.clusterId,s=n.selectedService;Pe.jy.setIp({productName:a.props.installGuideProp.selectedProduct.ProductName,serviceName:a.props.installGuideProp.selectedService.serviceKey},{ip:e.toString(),clusterId:o,namespace:r}).then((function(n){0===(n=n.data).code?(le.Z.success("保存成功"),a.getProductServicesInfo(!0),"mysql"==s.serviceKey&&"smooth"===t&&a.checkSql(e)):le.Z.error(n.msg)}))})),(0,I.Z)((0,Z.Z)(a),"getHostRoleMap",(0,g.Z)(k().mark((function e(){var t,n,r,o,s;return k().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.props.installGuideProp.clusterId,e.next=3,Pe.jy.getHostRoleMap({cluster_id:t});case 3:n=e.sent,r=n.data,o=r.code,s=r.data,0===o&&(window.hostRoleMap=s||[]);case 6:case"end":return e.stop()}}),e)})))),(0,I.Z)((0,Z.Z)(a),"getCurrentHostsList",(function(e,t){var n,r,o=a.props.installGuideProp.selectedProduct.ProductName,s=a.props.installGuideProp.selectedService.serviceKey;o&&s&&Mn.get(he()(n=he()(r="/api/v2/product/".concat(o,"/service/")).call(r,s,"/selected_hosts?clusterId=")).call(n,a.props.installGuideProp.clusterId),{}).then((function(n){0===(n=n.data).code?a.setState({allHostList:n.data.hosts},(function(){a.handleSaveMoreConfig(e,t)})):le.Z.error(n.msg)}))})),(0,I.Z)((0,Z.Z)(a),"handleParamBlur",(function(e,t){T()(t)?j()(t).call(t,(function(e){return""===e.hosts}))?a.setState({noHosts:e.split(".")[1]}):j()(t).call(t,(function(e){return""!==e.hosts&&""!==e.field}))&&(a.changeHosts(),a.getCurrentHostsList(e,t)):"string"==typeof t&&Pe.jy.setParamConfigFieldValue({productName:a.props.installGuideProp.selectedProduct.ProductName,serviceName:a.props.installGuideProp.selectedService.serviceKey},{field_path:e,field:t,namespace:a.props.installGuideProp.namespace,clusterId:a.props.installGuideProp.clusterId}).then((function(e){0===(e=e.data).code?(le.Z.success("保存成功"),a.getProductServicesInfo(!0)):le.Z.error(e.msg)}))})),(0,I.Z)((0,Z.Z)(a),"handleSaveMoreConfig",(function(e,t){var n=A()(t).call(t,(function(e){return e.hosts})),r=a.state.allHostList,o=n.join(",").split(",");r&&o.length===r.length&&j()(r).call(r,(function(e){return-1!==W()(o).call(o,e)}))?Pe.jy.modifyMultiSingleField({productName:a.props.installGuideProp.selectedProduct.ProductName,serviceName:a.props.installGuideProp.selectedService.serviceKey},{field_path:e,field:z()(t),clusterId:a.props.installGuideProp.clusterId}).then((function(e){var t;if(0===(e=e.data).code)le.Z.success("关联主机成功"),a.getProductServicesInfo(!0),a.changeHosts();else if(100===e.code&&Se()(t=e.msg).call(t,"输入值重复")){var n,r=e.msg.substring(1,W()(n=e.msg).call(n,")")).split(",");a.setState({repeatParams:r})}else le.Z.error(e.msg)})):a.setState({noHosts:e.split(".")[1]})})),(0,I.Z)((0,Z.Z)(a),"sideNav",null),(0,I.Z)((0,Z.Z)(a),"changeHosts",(function(){a.setState({noHosts:"",repeatParams:[]})})),a.state={showGlobalBtn:!0,disabledAutoBtn:!1,hostsSelectList:[],noHosts:"",repeatParams:[],allHostList:[]},a}return(0,S.Z)(n,[{key:"componentDidMount",value:function(){var e=this;this.getHostRoleMap(),this.getOldHostInfo();var t=this.props.installGuideProp,n=t.namespace,a=t.baseClusterId,r=t.clusterId,o=this.props.DeployProp.upgradeType,s={productName:this.props.installGuideProp.selectedProduct.ProductName,productVersion:this.props.installGuideProp.selectedProduct.ProductVersion,namespace:n,relynamespace:-1===a?void 0:a,clusterId:r};s.productName&&s.productVersion&&("smooth"===o&&D()(s,{upgrade_mode:"smooth"}),Pe.jy.getProductServicesInfo(s).then((function(t){var n=t.data.data;for(var a in n)for(var r in n[a]){var o=n[a][r].Instance;if(null!=o)void 0===o.MaxReplica&&e.setState({showGlobalBtn:!1})}})))}},{key:"render",value:function(){var e,t=this,n=this.props.installGuideProp,a=n.selectedService,r=n.serviceHostList,o=re.createElement("p",{className:"title ml-10"},re.createElement(ce.Z,{type:"exclamation-circle",theme:"filled",style:{color:"#3f87ff",marginRight:8}}),"您需选择安装服务的主机，并可进行参数配置。");return re.createElement("div",{className:"step-three-container step-content-container"},o,re.createElement("div",{className:"edit-config-container"},re.createElement(Xt,{ref:function(e){return t.sideNav=e},width:200,actions:this.props.actions,selectedService:this.props.installGuideProp.selectedService,updateServiceHostList:this.props.actions.updateServiceHostList,selectedProduct:this.props.installGuideProp.selectedProduct,productName:this.props.productName,clusterId:this.props.installGuideProp.clusterId,setSelectedConfigService:this.props.actions.setSelectedConfigService,productServicesInfo:this.props.installGuideProp.productServicesInfo,deployMode:this.props.deployMode,saveInstallInfo:this.props.actions.saveInstallInfo}),re.createElement("div",{className:"step-three-main-container"},this.props.installGuideProp.selectedService.serviceKey&&re.createElement("div",null,re.createElement("div",{className:"header",style:{paddingTop:14.5}},re.createElement("p",{className:"title"},a.serviceKey),""!==a.Version&&re.createElement(gt.Z,{title:"组件版本号"},re.createElement("p",{className:"version-tag tag"},a.Version)),""!==a.BaseService&&re.createElement(gt.Z,{title:"当前服务的部分配置继承于该服务"},re.createElement("p",{className:"depend-tag tag"},a.BaseProduct,"@",a.BaseService)),a.DependsOn&&A()(e=a.DependsOn).call(e,(function(e,t){return re.createElement("p",{key:t.toString(),className:"depend-tag tag"},e,re.createElement(gt.Z,{title:"当前服务的部分配置依赖于该服务"},re.createElement(ce.Z,{style:{color:"#53E3C3",marginLeft:3},type:"info-circle"})))}))),re.createElement("div",{className:"tabs-container"},re.createElement(Jn,{paramChangeBlur:this.handleParamBlur,handleCancel:this.handleConfigCancel,handleResourceSubmit:this.handleResourceSubmit,commitParamChange:this.commitParamChange,afterParamFieldChange:this.handleSetParamField,resetParamFieldvalue:this.hadnleResetparamField,resourceState:this.props.installGuideProp.resourceState,saveResourceState:this.props.actions.saveResourceState,serviceData:this.props.installGuideProp.selectedService,hostList:r,selectedProduct:this.props.installGuideProp.selectedProduct,installGuideProp:this.props.installGuideProp,DeployProp:this.props.DeployProp,actions:this.props.actions,isKubernetes:this.props.isKubernetes,sname:this.props.installGuideProp.selectedService.serviceKey,pname:this.props.installGuideProp.selectedProduct.ProductName,noHosts:this.state.noHosts,repeatParams:this.state.repeatParams,changeHosts:this.changeHosts,getProductServicesInfo:this.getProductServicesInfo})))||re.createElement("p",{className:"no-select-text"},"请在左侧列表选择需要配置的服务"))))}}]),n}(re.Component))||Qn;var aa=n(31581),ra=n.n(aa),oa=n(45334),sa=n(11382),la=n(65778),ia=n(43138),ca=n(28568),ua=n(88081);function pa(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}const da=function(e){(0,E.Z)(n,e);var t=pa(n);function n(){var e,a;(0,y.Z)(this,n);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];return a=t.call.apply(t,he()(e=[this]).call(e,o)),(0,I.Z)((0,Z.Z)(a),"timer",Object),(0,I.Z)((0,Z.Z)(a),"timerInterval",Object),(0,I.Z)((0,Z.Z)(a),"handScroll",!1),(0,I.Z)((0,Z.Z)(a),"container",null),(0,I.Z)((0,Z.Z)(a),"state",{dataList:[],timerCount:0,timerGone:!1,progressPre:[],log_modal_visible:!1,logpaths:[],log_service_id:"",deployFailed:!1,deploySuccess:!1,status:"",modalContent:null,serviceGroup:null,visibleServiceLog:!1}),(0,I.Z)((0,Z.Z)(a),"handleScroll",Ee.debounce((function(e){document.getElementsByClassName("ant-table-row")[document.getElementsByClassName("ant-table-row").length-1].offsetTop-a.container.scrollTop>206&&(a.handScroll=!0,a.container.removeEventListener("scroll",a.handleScroll))}),100)),(0,I.Z)((0,Z.Z)(a),"loadDataInter",(function(){a.timer=ra()((function(){a.setState({timerCount:a.state.timerCount+1}),a.props.actions.getDeployList({uuid:a.props.installGuideProp.deployUUID,start:a.props.installGuideProp.start||0,status:""});var e=a.props.installGuideProp.complete,t="deploying"===e,n=a.props.isKubernetes&&"undeploying"===e;t||n||clearInterval(a.timer),"deployed"===e?(se.Z.success({message:"提示",description:"部署成功！",duration:0}),sessionStorage.removeItem("upgradeType"),sessionStorage.removeItem("forcedUpgrade"),sessionStorage.removeItem("isFirstSmooth"),sessionStorage.removeItem("product_backup_info")):t||n||se.Z.error({message:"提示",description:"部署失败！",duration:0})}),3e3)})),(0,I.Z)((0,Z.Z)(a),"loadFirstScreenList",(function(){a.timerInterval=ra()((function(){a.props.actions.getCurrentDeployList({uuid:a.props.installGuideProp.deployUUID,start:0,status:""});var e=a.props.installGuideProp.complete,t="deploying"===e,n=a.props.isKubernetes&&"undeploying"===e;t||n||clearInterval(a.timerInterval),"deployed"===e?se.Z.success({message:"提示",description:"部署成功！",duration:0}):t||n||se.Z.error({message:"提示",description:"部署失败！",duration:0})}),3e3)})),(0,I.Z)((0,Z.Z)(a),"loadCurrentScreenList",(function(e){a.timerInterval=ra()((function(){a.props.actions.getCurrentDeployList({uuid:a.props.installGuideProp.deployUUID,start:e,status:""});var t=a.props.installGuideProp.complete,n="deploying"===t,r=a.props.isKubernetes&&"undeploying"===t;n||r||clearInterval(a.timerInterval),"deployed"===t?se.Z.success({message:"提示",description:"部署成功！",duration:0}):n||r||se.Z.error({message:"提示",description:"部署失败！",duration:0})}),3e3)})),(0,I.Z)((0,Z.Z)(a),"loadLastScreen",(function(){a.props.actions.getDeployList({uuid:a.props.installGuideProp.deployUUID,start:a.props.installGuideProp.count-20>0?a.props.installGuideProp.count-20:0,status:""})})),(0,I.Z)((0,Z.Z)(a),"clearTimer",(function(){var e=a.props.installGuideProp.complete,t="deploying"===e,n=a.props.isKubernetes&&"undeploying"===e;t||n||(clearInterval(a.timer),clearInterval(a.timerInterval))})),(0,I.Z)((0,Z.Z)(a),"showDeployLog",(function(e){var t=JSON.parse(e.schema?e.schema:"{}");a.setState({log_modal_visible:!0,logpaths:t.Instance.Logs,log_service_id:e.instance_id})})),(0,I.Z)((0,Z.Z)(a),"showAllServiceLog",(function(){var e=a.props.installGuideProp;a.setState({visibleServiceLog:!0},(function(){a.loadServiceGroup({product_name:e.selectedProduct.ProductName})}))})),(0,I.Z)((0,Z.Z)(a),"onSelectedLogService",(function(e){var t=a.props.installGuideProp;a.getDeployLog({deployId:t.deployUUID,serviceName:e||"",productName:t.selectedProduct.ProductName,productVersion:t.selectedProduct.ProductVersion})})),(0,I.Z)((0,Z.Z)(a),"getDeployLog",(function(e){Pe.aJ.searchDeployLog(e).then((function(e){0===e.data.code&&a.setState({modalContent:(0,Ee.get)(e,"data.data.result","")})}))})),(0,I.Z)((0,Z.Z)(a),"loadServiceGroup",(function(e){Pe.BZ.getServiceGroup(e).then((function(e){0===e.data.code&&a.setState({serviceGroup:(0,Ee.get)(e,"data.data.groups",{})})}))})),(0,I.Z)((0,Z.Z)(a),"initColumns",(function(){var e=a.props.installGuideProp.complete;return[{title:"执行时间",dataIndex:"update_time"},{title:"产品包名称",dataIndex:"product_name"},{title:"服务名称",dataIndex:"service_name"},{title:"服务版本号",dataIndex:"service_version"},{title:"主机IP",dataIndex:"ip"},{title:"组件版本号",dataIndex:"product_version"},{title:"部署进度",dataIndex:"progressbar",render:function(e,t){var n=!1;switch(t.status){case"install fail":case"run fail":case"health-check fail":case"stop fail":case"health-check cancelled":n=!0;break;default:n=!1}return re.createElement(oa.Z,{percent:t.progress,status:n?"exception":"active"})}},{title:"启动状态",dataIndex:"status",filters:"deploying"!==e||"undeploying"!==e?a.props.isKubernetes?[{text:"installing",value:"installing"},{text:"installed",value:"installed"},{text:"install fail",value:"install fail"},{text:"uninstalling",value:"uninstalling"},{text:"uninstalled",value:"uninstalled"},{text:"uninstall fail",value:"uninstall fail"},{text:"running",value:"running"},{text:"run fail",value:"run fail"},{text:"health-checked",value:"health-checked"},{text:"health-check fail",value:"health-check fail"}]:[{text:"installing",value:"installing"},{text:"installed",value:"installed"},{text:"install fail",value:"install fail"},{text:"uninstalling",value:"uninstalling"},{text:"uninstalled",value:"uninstalled"},{text:"uninstall fail",value:"uninstall fail"},{text:"installing cancelled",value:"installing cancelled"},{text:"running",value:"running"},{text:"run fail",value:"run fail"},{text:"health-checked",value:"health-checked"},{text:"health-check fail",value:"health-check fail"},{text:"health-check cancelled",value:"health-check cancelled"},{text:"health-check waiting",value:"health-check waiting"},{text:"stopped",value:"stopped"},{text:"stopping",value:"stopping"},{text:"stop fail",value:"stop fail"},{text:"update-config fail",value:"update-config fail"}]:[],render:function(e,t){var n={};switch(t.status){case"install fail":case"run fail":case"stop fail":case"health-check fail":case"health-check cancelled":n={color:"#FF5F5C"};break;case"installed":case"health-checked":n={color:"#12BC6A"}}return re.createElement("div",null,re.createElement("span",{style:n},e),re.createElement(gt.Z,{title:t.status_message},t.status_message?re.createElement(ce.Z,{style:{marginLeft:3},type:"info-circle"}):null))}},{title:"查看",dataIndex:"action",render:function(e,t){var n=JSON.parse(t.schema?t.schema:"{}");return n&&n.Instance&&n.Instance.Logs?re.createElement("span",null,re.createElement("a",{style:n.Instance.Logs.length?{display:"inline"}:{display:"none"},onClick:function(){return a.showDeployLog(t)}},"部署日志")):"-"}}]})),(0,I.Z)((0,Z.Z)(a),"handleTableChange",(function(e,t,n){clearInterval(a.timer),clearInterval(a.timerInterval),a.props.actions.getDeployList({uuid:a.props.installGuideProp.deployUUID,start:0,status:t.status?t.status.join(",").toString():""})})),a}return(0,S.Z)(n,[{key:"componentDidMount",value:function(){this.handScroll=!1,this.container=document.getElementsByClassName("step-main-container")[0],this.container.addEventListener("scroll",this.handleScroll),this.loadDataInter()}},{key:"UNSAFE_componentWillMount",value:function(){this.container&&this.container.removeEventListener("scroll",this.handleScroll)}},{key:"componentWillUnmount",value:function(){clearInterval(this.timer),clearInterval(this.timerInterval)}},{key:"componentDidUpdate",value:function(){if(!this.handScroll){var e=document.getElementsByClassName("ant-table-row")[document.getElementsByClassName("ant-table-row").length-1];e&&document.getElementsByClassName("step-main-container")[0].scrollTo(0,e.offsetTop)}}},{key:"UNSAFE_componentWillReceiveProps",value:function(e){e.installGuideProp.stopDeployBySelf}},{key:"render",value:function(){var e,t,n,a=this,r=this.state.visibleServiceLog,o=this.initColumns(),s=this.props,l=s.installGuideProp,i=s.isKubernetes,c="deploying"===this.props.installGuideProp.complete,u=i&&"undeploying"===this.props.installGuideProp.complete,p=this.props.installGuideProp.start-20>0?this.props.installGuideProp.start-20:0,d=this.props.installGuideProp.count-20>0?this.props.installGuideProp.count-20:0,f="deploy fail"===l.complete,m="deployed"===l.complete;return re.createElement("div",{className:"step-four-container step-content-container",style:{position:"relative"}},re.createElement("p",{className:"header-box"},re.createElement(ce.Z,{type:"exclamation-circle",theme:"filled",style:{color:"#3f87ff",marginRight:8}}),"产品包中的已选择服务将在主机上开始部署，可查看服务的安装状态及部署详情。"),re.createElement("div",{className:"table-box table-pagination_wraper",style:{marginBottom:30}},re.createElement("div",null,re.createElement(Dt.Z,{rowKey:"id",className:"dt-em-table dt-table-border dt-table-last-row-noborder",columns:o,pagination:!1,dataSource:this.props.installGuideProp.deployList,onChange:this.handleTableChange}),i&&re.createElement(ua.Z,{wsUrl:he()(e=he()(t=he()(n="ws://".concat(window.location.host,"/api/v2/cluster/kubernetes/")).call(n,l.clusterId,"/namespace/")).call(t,l.namespace,"/product/")).call(e,l.selectedProduct.ID,"/installLog")}),c||u?re.createElement("div",{className:"table-pagination_wraper_spin"},re.createElement(sa.Z,null)):null,this.props.installGuideProp.deployList&&this.props.installGuideProp.deployList.length>0?re.createElement(ia.Z,{handleClickTop:function(){clearInterval(a.timer),clearInterval(a.timerInterval),a.props.actions.getCurrentDeployList({uuid:a.props.installGuideProp.deployUUID,start:0,status:""}),(c||u)&&a.loadFirstScreenList()},handleClickUp:function(){clearInterval(a.timer),clearInterval(a.timerInterval),a.props.actions.getDeployList({uuid:a.props.installGuideProp.deployUUID,start:p,status:""}),(c||u)&&a.loadCurrentScreenList(p)},handleClickDown:function(){clearInterval(a.timer),clearInterval(a.timerInterval),a.props.actions.getDeployList({uuid:a.props.installGuideProp.deployUUID,start:d,status:""}),(c||u)&&a.loadCurrentScreenList(d)},handleClickNew:function(){clearInterval(a.timer),clearInterval(a.timerInterval),a.loadLastScreen(),(c||u)&&a.loadCurrentScreenList(d)}}):null)),f||m?re.createElement(Lt.Z,{className:"absolute-middle",style:{textAlign:"center",fontSize:"12px",top:"auto",bottom:"20px"}},m?re.createElement("span",{style:{color:"#12BC6A"}},re.createElement(ce.Z,{type:"check-circle"})," 部署成功!"):null,f?re.createElement("span",{style:{color:"#FF5F5C"}},re.createElement(ce.Z,{type:"close-circle"})," 部署失败!"):null,!i&&re.createElement("span",null,"  ",re.createElement("a",{onClick:this.showAllServiceLog},"查看全部部署日志"))):null,re.createElement(ie.Z,{className:"logtail-box",destroyOnClose:!0,title:"执行日志",footer:null,width:800,visible:this.state.log_modal_visible,maskClosable:!1,onCancel:function(){return a.setState({log_modal_visible:!1})}},re.createElement(la.Z,{logs:this.state.logpaths,serviceid:this.state.log_service_id,isreset:!this.state.log_modal_visible})),re.createElement(ca.Z,{key:"deployModal",title:"部署日志",visible:r,content:this.state.modalContent,serviceData:this.state.serviceGroup,onCancel:function(){return a.setState({visibleServiceLog:!1,modalContent:null})},onSelectedService:this.onSelectedLogService}))}}]),n}(re.Component);var fa,ma=n(64143);function ha(e,t){var n=ae()(e);if(l()){var a=l()(e);t&&(a=F()(a).call(a,(function(t){return c()(e,t).enumerable}))),n.push.apply(n,a)}return n}function va(e){for(var t=1;t<arguments.length;t++){var n,a,r=null!=arguments[t]?arguments[t]:{};t%2?K()(n=ha(Object(r),!0)).call(n,(function(t){(0,I.Z)(e,t,r[t])})):p()?f()(e,p()(r)):K()(a=ha(Object(r))).call(a,(function(t){h()(e,t,c()(r,t))}))}return e}function ga(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,C.Z)(e);if(t){var r=(0,C.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,P.Z)(this,n)}}var ya=oe.Z.Step;const Sa=(0,pe.$j)((function(e){return{installGuideProp:e.InstallGuideStore,deployProp:e.DeployStore,userCenterProp:e.UserCenterStore,headerStore:e.HeaderStore}}),(function(e){return{actions:(0,de.DE)(D()({},a,fe),e)}}))(fa=function(e){(0,E.Z)(n,e);var t=ga(n);function n(e){var a;return(0,y.Z)(this,n),a=t.call(this,e),(0,I.Z)((0,Z.Z)(a),"state",{urlParams:{},gobackLocation:"",canUpgrade:!0,regionPID:-1,autoProductList:[],deployMode:Vt.AUTO,autoExpendRowKeys:[],autoSelectedProducts:[],deployUUID:"",upgradeStep:0,isUpgrade:!1}),(0,I.Z)((0,Z.Z)(a),"stepTwoForm",null),(0,I.Z)((0,Z.Z)(a),"getOrchestrationHistory",(0,g.Z)(k().mark((function e(){var t,n,r,o,s,l;return k().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.props.installGuideProp.clusterId,e.next=3,Pe.aJ.getOrchestrationHistory({cluster_id:t});case 3:n=e.sent,r=n.data,o=r.data,s=void 0===o?[]:o,0===r.code&&(l=T()(s)?A()(s).call(s,(function(e){var t,n,a=V()(t=e.service.all_service).call(t,(function(e,t){return e.baseProduct.length-t.baseProduct.length})),r=A()(n=F()(a).call(a,(function(e){return""!==e.baseProduct}))).call(n,(function(e){return e.serviceName})),o=e.service,s=o.check_service,l=void 0===s?[]:s,i=o.uncheck_service,c=void 0===i?[]:i,u=A()(l).call(l,(function(e){return e.service_name})),p=A()(c).call(c,(function(e){return e.service_name}));return{ID:e.pid,productName:e.product_name,service:{all:a,checked:u,unChecked:p,disabled:r}}})):[],a.setState({autoSelectedProducts:l}));case 6:case"end":return e.stop()}}),e)})))),(0,I.Z)((0,Z.Z)(a),"refreshDeployService",(function(e){var t=a.state.autoSelectedProducts,n={cluster_id:a.props.installGuideProp.clusterId,product_info:A()(t).call(t,(function(e){return{id:e.ID,name:e.productName,service_list:e.service.checked,uncheck_service_list:e.service.unChecked}}))};a.props.actions.refreshServicesInfoForAutoDeploy(n,e)})),(0,I.Z)((0,Z.Z)(a),"updateAutoDeployService",(function(e,t){var n=a.state.autoSelectedProducts,r=A()(n).call(n,(function(n){if(e===n.ID){var a,r=[];return K()(a=n.service.all).call(a,(function(e){-1===M()(t).call(t,(function(t){return t===e.serviceName}))&&r.push(e.serviceName)})),va(va({},n),{},{service:{all:n.service.all,checked:t,unChecked:r,disabled:n.service.disabled}})}return n}));a.setState({autoSelectedProducts:r})})),(0,I.Z)((0,Z.Z)(a),"initStep",(function(){var e=a.state.urlParams,t=e.query_str,n=e.cluster_id,r=e.product_name,o=e.product_version,s=e.id,l=e.redeploy,i=e.type,c=e.namespace,u=e.new_version,p=i||"hosts";if(a.props.actions.initInstallGuide(),a.props.actions.saveInstallType(p),t&&t.length>0)"kubernetes"===p&&(a.props.actions.saveSelectCluster(Number(n)),a.props.actions.saveSelectNamespace({},{namespace:c},!1)),a.props.actions.saveInstallInfo({ProductName:r,ProductVersion:o,ID:s}),a.props.actions.setDeployUUID(t),a.props.actions.goToStep(3);else if(a.props.actions.getInstallClusterList({limit:0,type:p}),l){if(ft.set("em_current_cluster_id",l),ft.set("em_current_cluster_type",p),a.props.actions.saveSelectCluster(Number(l)),"kubernetes"===p&&(a.props.actions.getNamespaceList({clusterId:Number(l)}),c&&a.props.actions.saveSelectNamespace({},{namespace:c},!1)),u)return void a.setState({isUpgrade:!0},(function(){a.goToStepThree()}));a.props.actions.goToStep(1),a.props.actions.getProductPackageList({limit:0,product_type:"hosts"===p?0:1})}else sessionStorage.removeItem("upgradeType"),sessionStorage.removeItem("forcedUpgrade"),sessionStorage.removeItem("isFirstSmooth")})),(0,I.Z)((0,Z.Z)(a),"goToStepThree",(function(){var e=a.state.urlParams.type||"hosts";a.props.actions.getProductPackageList({limit:0,product_type:"hosts"===e?0:1},a.getSelectedProduct)})),(0,I.Z)((0,Z.Z)(a),"getSelectedProduct",(function(){var e=a.state.urlParams,t=e.product_version,n=e.product_name,r=e.id,o=a.props.installGuideProp.productPackageList,s=void 0===o?[]:o;K()(s).call(s,(function(e){n===e.ProductName&&t===e.ProductVersion&&r===e.ID.toString()&&a.handleProductSelected(e)}))})),(0,I.Z)((0,Z.Z)(a),"handleProductSelected",(function(e){a.getProductPackageServices(e),a.props.actions.saveInstallInfo(e)})),(0,I.Z)((0,Z.Z)(a),"getProductPackageServices",(function(e,t){a.props.actions.getProductPackageServices({productName:e.ProductName,productVersion:e.ProductVersion,pid:e.ID,clusterId:a.props.installGuideProp.clusterId,baseClusterId:t},(function(){a.getProductServicesInfo(),a.props.actions.goToStep(2)}))})),(0,I.Z)((0,Z.Z)(a),"getProductServicesInfo",(function(){var e=a.state,t=e.deployMode;e.urlParams;if(t!==Vt.AUTO){var n=a.props.installGuideProp,r=n.baseClusterId,o=n.selectedProduct,s=n.unSelectedServiceList,l=n.namespace,i=n.clusterId,c=a.props.deployProp,u=c.upgradeType,p=c.forcedUpgrade;if(o.ProductName&&o.ProductVersion){var d={productName:o.ProductName,productVersion:o.ProductVersion,unSelectService:s,relynamespace:-1===r?void 0:r,namespace:l,clusterId:i};"smooth"===u&&D()(d,{upgrade_mode:"smooth"}),a.props.actions.getProductServicesInfo(d,null,p)}}})),(0,I.Z)((0,Z.Z)(a),"handleLastStep",(function(){var e=a.props.installGuideProp,t=e.runtimeState,n=e.deployState,r=a.props.actions.setSelectedConfigService;(0,Ht.U)(t,n)&&(a.props.actions.lastStep(),r({}))})),(0,I.Z)((0,Z.Z)(a),"productPackageValidator",(function(){var e=a.props.installGuideProp,t=e.installType,n=e.selectedProduct,r=e.selectedServiceList,o=e.baseClusterId,s=e.baseClusterInfo,l=a.state,i=l.autoSelectedProducts,c={status:!0,message:""};return l.deployMode===Vt.AUTO?0===i.length?(c.status=!1,c.message="请选择要安装的产品"):j()(i).call(i,(function(e){return 0===e.service.checked.length}))&&(c.status=!1,c.message="请选择要安装的服务"):"{}"===z()(n)?(c.status=!1,c.message="请选择要安装的产品"):"kubernetes"===t&&-1===o&&s.hasDepends?(c.status=!1,c.message="请选择依赖集群"):0===r.length&&(c.status=!1,c.message="请选择要安装的服务"),c})),(0,I.Z)((0,Z.Z)(a),"handleNextStep",(function(){var e=a.props.installGuideProp,t=e.step,n=e.installType,r=e.selectedProduct,o=e.unSelectedServiceList,s=e.namespace,l=e.clusterId,i=e.baseClusterId,c=e.deployState,u=e.runtimeState,p=e.smoothSelectService,d=a.props.deployProp.upgradeType,f=a.state,m=f.autoSelectedProducts,h=f.deployMode,v=f.upgradeStep,y=f.isUpgrade;if(0===t)return a.stepTwoForm.props.form.validateFields(function(){var e=(0,g.Z)(k().mark((function e(t,r){var o,s;return k().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return");case 2:if("kubernetes"===n){e.next=5;break}return a.props.actions.nextStep(),e.abrupt("return");case 5:o={clusterId:l},s={clusterId:l,namespace:r.namespace},a.props.actions.saveSelectNamespace(o,s,r.isNewSpace,(function(){a.props.actions.checkDefaultImageStore(o,(function(e){e?a.props.actions.nextStep():se.Z.error({message:"该集群中无默认镜像仓库",description:re.createElement("span",null,"请",re.createElement("a",{href:"deploycenter/cluster/detail/imagestore"},"前往集群管理"),"设置默认镜像仓库"),className:"check-default-notification",duration:null})}))}));case 8:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}());if(1===t){var S=a.productPackageValidator();if(!S.status)return le.Z.error(S.message);if(h===Vt.MANUAL)a.getProductServicesInfo();else if(h===Vt.AUTO){var Z={cluster_id:a.props.installGuideProp.clusterId,product_info:A()(m).call(m,(function(e){return{id:e.ID,name:e.productName,service_list:e.service.checked,uncheck_service_list:e.service.unChecked}}))};return void a.props.actions.getProductServicesInfoForAutoDeploy(Z,(function(){a.props.actions.nextStep()}))}}else if(2===t||0===v&&y){var E=a.props.userCenterProp.authorityList;if(!(0,Ht.U)(u,c))return;if(!E.package_upload_deploy)return le.Z.error("权限不足，请联系管理员！");if(y&&a.saveUpgrade(),h===Vt.AUTO){var P={cluster_id:a.props.installGuideProp.clusterId,product_info:A()(m).call(m,(function(e){return{id:e.ID,name:e.productName,service_list:e.service.checked,uncheck_service_list:e.service.unChecked}}))};a.props.actions.startAutoDeploy(P,(function(e){a.setState({deployUUID:e.deploy_uuid}),a.props.actions.nextStep()}))}else{var C=JSON.parse(sessionStorage.getItem("product_backup_info")),I={productName:r.ProductName,version:r.ProductVersion,unchecked_services:o,deployMode:a.state.urlParams.new_version?1:void 0,clusterId:a.props.installGuideProp.clusterId};if("smooth"===d){var _,b=!1;if(null!=p&&p.ServiceAddr)b=null==p||null===(_=p.ServiceAddr)||void 0===_||!_.UnSelect;D()(I,{deployMode:3,source_version:null==C?void 0:C.source_version,final_upgrade:b})}"kubernetes"===n&&(I=D()({},I,{namespace:s,relynamespace:-1===i?void 0:i,clusterId:l,pid:r.ID})),a.props.actions.startDeploy(I,y?function(){a.setState({upgradeStep:1})}:a.props.actions.nextStep)}return}a.props.actions.nextStep()})),(0,I.Z)((0,Z.Z)(a),"handleQuit",(function(){var e=a.props.installGuideProp,t=e.deployState,n=e.runtimeState,r=a.state,o=r.upgradeStep,s=r.isUpgrade;(0,Ht.U)(n,t)&&(3!==a.props.installGuideProp.step&&!s||s&&0===o?ie.Z.confirm({title:"退出会失去已改动的内容，确认退出吗?",icon:re.createElement(ce.Z,{type:"exclamation-circle",theme:"filled"}),okType:"danger",onOk:function(){a.props.actions.initInstallGuide(),a.props.history.push(a.getGoBackLocation())}}):"deployed"===a.props.installGuideProp.complete?(a.props.actions.initInstallGuide(),a.props.history.push(a.getGoBackLocation())):a.props.history.push(a.getGoBackLocation()))})),(0,I.Z)((0,Z.Z)(a),"getGoBackLocation",(function(){var e=a.state.gobackLocation;return e&&-1!==W()(e).call(e,"/appmanage/")?(ma.Z.setNaviKey("sub_menu_product_deploy","sub_menu_cluster_list"),"/deploycenter/cluster/list"):(ma.Z.setNaviKey("sub_menu_product_deploy","sub_menu_cluster_list"),"/deploycenter/cluster/detail/deployed")})),(0,I.Z)((0,Z.Z)(a),"handleUrlParamSearch",(function(){var e,t,n,r={},o=null===(e=a.props.location)||void 0===e?void 0:J()(t=e.search).call(t,1);o&&K()(n=o.split("&")).call(n,(function(e){r[e.split("=")[0]]=e.split("=")[1]}));a.setState({urlParams:r,gobackLocation:r.from||"/"},(function(){a.initStep()}))})),(0,I.Z)((0,Z.Z)(a),"saveUpgrade",(0,g.Z)(k().mark((function e(){var t,n,r,o,s,l,i,c,u,p;return k().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.props.installGuideProp,r=n.selectedProduct,o=void 0===r?{}:r,s=n.oldHostInfo,l=a.props.deployProp.upgradeType,i={},"smooth"===l&&D()(i,{upgrade_mode:"smooth"}),c=JSON.parse(sessionStorage.getItem("product_backup_info"))||{},e.next=7,Pe.jy.saveUpgrade({productName:o.ProductName},va(va(va({},c),s),i));case 7:if(u=e.sent,0!==(p=u.data).code||null===(t=p.data)||void 0===t||!t.upgrade_id){e.next=11;break}return e.abrupt("return",!0);case 11:return e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e)})))),(0,I.Z)((0,Z.Z)(a),"handleStopDeploy",(function(){var e=a.props.installGuideProp,t=e.selectedProduct,n=void 0===t?{}:t,r=e.clusterId,o=e.namespace,s=e.installType,l="kubernetes"===s,i=a.props.deployProp.deployType;ie.Z.confirm({title:"确定停止当前部署吗？",content:"停止后，服务将不在继续部署！",icon:re.createElement(ce.Z,{type:"exclamation-circle",theme:"filled"}),okType:"danger",onOk:function(){if("auto"===i){var e=a.props.installGuideProp.clusterId,t=a.state.deployUUID;a.props.actions.stopAutoDeploy(l,{cluster_id:e,deploy_uuid:t||a.props.installGuideProp.deployUUID})}else{var c="kubernetes"===s,u={productName:n.ProductName,version:n.ProductVersion,product_type:n.ProductType};c&&(u=D()(u,{clusterId:r,namespace:o})),a.props.actions.stopDeploy(c,u)}}})})),(0,I.Z)((0,Z.Z)(a),"deployDone",(function(){if("/login"!=a.state.gobackLocation){var e=a.props,t=e.actions,n=e.headerStore,r=e.installGuideProp,o=n.parentClusters,s=r.clusterId,l=X()(o).call(o,(function(e){return e.id===+s}));l&&t.setCurrentParentCluster(l)}ma.Z.setNaviKey("sub_menu_product_deploy","sub_menu_cluster_list"),a.props.history.push("/login"===a.state.gobackLocation?"/":"/deploycenter/cluster/detail/deployed")})),a}return(0,S.Z)(n,[{key:"componentDidMount",value:function(){var e=this;this.handleUrlParamSearch();var t,n,a=(t=this.props.location.search)?L()(n=t.split("?")[1].split("&")).call(n,(function(e,t){var n=t.split("="),a=(0,_.Z)(n,2),r=a[0],o=a[1];return e[r]=o,e}),{}):{};new RegExp("/deploycenter").test(a.from)&&void 0!==a.product_name?this.setState({deployMode:Vt.MANUAL}):this.setState({deployMode:Vt.AUTO},(function(){e.getOrchestrationHistory()}))}},{key:"componentWillUnmount",value:function(){this.props.actions.initInstallGuide()}},{key:"render",value:function(){var e,t=this,n=this.state,a=n.canUpgrade,r=n.urlParams,o=n.isUpgrade,s=n.upgradeStep,l=this.props.installGuideProp,i=l.step,c=l.complete,u=l.stopDeployBySelf,p=l.baseClusterInfo,d=l.installType,f=p||{},m=f.baseClusterList,h=f.hasDepends,g=i,y="kubernetes"===d,S=y&&1===g&&h&&!m.length,Z={installGuideProp:this.props.installGuideProp,actions:this.props.actions,location:this.props.location,defaultSelectedProduct:r,DeployProp:this.props.deployProp,isKubernetes:y};return re.createElement("div",{className:"step-container",style:{height:document.body.clientHeight-50}},re.createElement("div",{className:"step-main-container"},!o&&re.createElement("div",{className:"na-page-content-box"},re.createElement(oe.Z,{current:g},re.createElement(ya,{title:"选择集群"}),re.createElement(ya,{title:"选择产品包"}),re.createElement(ya,{title:"配置服务"}),re.createElement(ya,{title:"执行部署"})),re.createElement("div",{className:"step-triangle-box"},re.createElement("div",{className:0===g?"step-triangle-item":"step-triangle-item not-active-step"}),re.createElement("div",{className:1===g?"step-triangle-item":"step-triangle-item not-active-step"}),re.createElement("div",{className:2===g?"step-triangle-item":"step-triangle-item not-active-step"}),re.createElement("div",{className:3===g?"step-triangle-item":"step-triangle-item not-active-step"})),0===g&&re.createElement(_t,(0,v.Z)({wrappedComponentRef:function(e){return t.stepTwoForm=e}},Z))||1===g&&re.createElement(Kt,(0,v.Z)({autoProductList:this.state.autoProductList,deployMode:this.state.deployMode,autoSelectedProducts:this.state.autoSelectedProducts,updateAutoDeployService:this.updateAutoDeployService,getOrchestrationHistory:this.getOrchestrationHistory,updateParentState:te()(e=this.setState).call(e,this),isK8s:"kubernetes"===this.props.installGuideProp.installType},Z))||2===g&&re.createElement(na,(0,v.Z)({productName:r.product_name,deployMode:this.state.deployMode,refreshDeployService:this.refreshDeployService},Z))||3===g&&re.createElement(da,Z)),o&&re.createElement("div",{className:"na-page-content-box"},re.createElement(oe.Z,{current:s,style:{width:300}},re.createElement(ya,{title:"配置服务"}),re.createElement(ya,{title:"执行部署"})),re.createElement("div",{className:"step-triangle-box",style:{width:"100%"}},0===s&&re.createElement(na,(0,v.Z)({productName:r.product_name,deployMode:this.state.deployMode,refreshDeployService:this.refreshDeployService},Z))||1===s&&re.createElement(da,Z))),re.createElement("div",{className:"btn-container"},re.createElement(ue.Z,{className:"dt-em-btn",onClick:this.handleQuit},"退出"),3===g||1===s?re.createElement("span",null,re.createElement(ue.Z,{ghost:!0,onClick:function(){return t.handleStopDeploy()},disabled:"deploying"!==c||""===this.props.deployProp.deployType,className:"dt-em-btn",type:"danger"},"停止部署"),re.createElement(ue.Z,{onClick:this.deployDone,disabled:"deployed"!==c&&!u,className:"dt-em-btn",type:"primary"},"完成")):re.createElement("span",null,0!==g&&!o&&re.createElement(ue.Z,{className:"dt-em-btn",onClick:this.handleLastStep},"上一步"),re.createElement(ue.Z,{className:"dt-em-btn",type:"primary",disabled:S||!a,onClick:this.handleNextStep},2===g||o?"执行部署":"下一步")))))}}],[{key:"getDerivedStateFromProps",value:function(e,t){var n=e.installGuideProp,a=n.selectedProduct,r=n.clusterId,o=n.namespace,s=n.step,l=t.urlParams,i=void 0===l?{}:l,c=t.regionPID,u=i.new_version,p=i.redeploy,d=i.product_name,f=i.product_version,m=i.id;if(u&&1===s&&ae()(a).length){var h=null==a?void 0:a.ID,v="".concat(h)===m&&(null==a?void 0:a.ProductName)===d&&(null==a?void 0:a.ProductVersion)===f,g="".concat(r)===p&&(o||void 0)===(null==i?void 0:i.namespace);if(!v||!g)return h!==c?(le.Z.error("与之前选择不一致，请重新选择"),{regionPID:h,canUpgrade:!1}):null}return{canUpgrade:!0}}}]),n}(re.Component))||fa},60558:(e,t,n)=>{n.d(t,{ON:()=>l,g8:()=>s});var a=n(49754),r=n(35558),o=n(98130);function s(e,t){if(!t)return e;var n=new a.Z;return n.setPublicKey(t),(0,r.GV)(n.encrypt(e)||"")}function l(e,t){return"04"+o.sg.encrypt(e,t,{inputEncoding:"utf8",outputEncoding:"hex"})}},64143:(e,t,n)=>{n.d(t,{Z:()=>y});var a=n(77766),r=n.n(a),o=n(78914),s=n.n(o),l=n(81643),i=n.n(l),c=n(2991),u=n.n(c),p=n(86902),d=n.n(p),f=n(31238),m=n.n(f),h=n(45360),v=n(36808),g=n(18274);const y={pageWidth:function(){return Math.max(document.documentElement.clientWidth,window.innerWidth||0)},pageHeight:function(){return Math.max(document.documentElement.clientHeight,window.innerHeight||0)},getParameterByName:function(e,t){t||(t=window.location.href),e=e.replace(/[[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null},getBase64:function(e,t){var n=new FileReader;n.addEventListener("load",(function(){return t(n.result)})),n.readAsDataURL(e)},percent:function(e,t){return e&&e!==1/0?(e>1&&(e=1),t=t||2,t=Math.pow(10,t),Math.round(e*t*100)/t+"%"):"0%"},getCssText:function(e){var t="";for(var n in e)t+=n+":"+e[n]+";";return t},formateDateTime:function(e){var t,n,a,o,s;if(!e)return"";var l=new Date(e),i=l.getFullYear(),c=l.getMonth()+1+"",u=l.getDate()+"",p=l.getHours()+"",d=l.getMinutes()+"",f=l.getSeconds()+"";return 1===c.toString().length&&(c="0".concat(c)),1===u.toString().length&&(u="0".concat(u)),1===p.toString().length&&(p="0".concat(p)),1===d.toString().length&&(d="0".concat(d)),1===f.toString().length&&(f="0".concat(f)),r()(t=r()(n=r()(a=r()(o=r()(s="".concat(i,"-")).call(s,c,"-")).call(o,u," ")).call(a,p,":")).call(n,d,":")).call(t,f)},formateDate:function(e){var t,n;if(!e)return"";var a=new Date(e),o=a.getFullYear(),s=a.getMonth()+1+"",l=a.getDate()+"";return 1===s.toString().length&&(s="0".concat(s)),1===l.toString().length&&(l="0".concat(l)),r()(t=r()(n="".concat(o,"-")).call(n,s,"-")).call(t,l)},trim:function(e){return"string"==typeof e?e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""):e},messageFilter:function(e,t,n,a){1001===e.status.code&&(a||h.Z.success("成功"),t&&t())},getTableParam:function(e){var t={};return s()(e).call(e,(function(e,n){var a=e.split("-");t[a[1]]=a[2]})),t},setAlertControl:function(e){var t={},n=e.alert_control;return"1"===n?t.close=1:(t.close=0,e["alert_num_"+n]&&(t.times_after_close=e["alert_num_"+n]),e["recover_num_"+n]&&(t.close_after_long_time_reset_amount=e["recover_num_"+n],t.close_after_long_time_reset_unit=e["recover_unit_"+n])),t},getAlertControl:function(e){var t={alert_control:""};return 0===e.close&&(0!==e.times_after_close?(t.alert_control="2",t["alert_num_"+t.alert_control]=e.times_after_close):t.alert_control="3",""!==e.close_after_long_time_reset_amount&&("2"===t.alert_control&&(t.alert_control="4"),t["alert_num_"+t.alert_control]=e.times_after_close,t["recover_num_"+t.alert_control]=e.close_after_long_time_reset_amount,t["recover_unit_"+t.alert_control]=e.close_after_long_time_reset_unit)),t},filterOption:function(e,t){var n;return-1!==i()(n=t.props.children).call(n,e)},getParamsFromUrl:function(e){var t={},n=[],a="",r="",o=e.substring(i()(e).call(e,"?")+1,e.length).split("&");for(var s in o)a=(n=o[s].split("="))[0],r=n[1],t[a]=r;return t},jsonToQuery:function(e){var t;return e?function(e){for(var t=[],n=0;n<e.length;n++)e[n]&&t.push(e[n]);return t}(u()(t=d()(e)).call(t,(function(t){return void 0===e[t]?"":encodeURIComponent(t)+"="+encodeURIComponent(e[t])}))).join("&"):""},checkNullObj:function(e){return 0===d()(e).length},serviceCallback:function(e,t,n){0===e.data.code?(h.Z.success(t),n&&n()):h.Z.error(e.data.msg)},noAuthorityToDO:function(e,t){return!e[t]&&(h.Z.error("权限不足，请联系管理员!"),!0)},get k8sNamespace(){return v.get(g.E9.NAMESPACE)},setNaviKey:function(e,t){sessionStorage.setItem("firstLevelNav",e),sessionStorage.setItem("siderLevelNav",t)},formatGBUnit:function(e){return i()(e).call(e,"MB")>-1?m()(e.replace("MB",""))/1024:i()(e).call(e,"KB")>-1?m()(e.replace("KB",""))/1024/1024:i()(e).call(e,"GB")>-1?m()(e.replace("GB","")):i()(e).call(e,"TB")>-1?1024*m()(e.replace("TB","")):0}}}}]);