"use strict";(self.webpackChunkdt_em_front=self.webpackChunkdt_em_front||[]).push([[4455],{28568:(e,t,n)=>{n.d(t,{Z:()=>w});var a=n(1068),r=n.n(a),o=n(68420),l=n(27344),s=n(5281),c=n(84441),i=n(3020),u=n(3362),d=n(44845),p=n(2991),m=n.n(p),f=n(25843),h=n.n(f),g=n(77766),v=n.n(g),y=n(67294),Z=n(34041),_=n(85733),E=n(30258),S=n(31097),C=n(4107),b=n(67908);function k(e){var t=function(){if("undefined"==typeof Reflect||!r())return!1;if(r().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(r()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,u.Z)(e);if(t){var o=(0,u.Z)(this).constructor;n=r()(a,arguments,o)}else n=a.apply(this,arguments);return(0,i.Z)(this,n)}}var x=Z.Z.Option,N=_.Z.TreeNode,w=function(e){(0,c.Z)(n,e);var t=k(n);function n(e){var a;return(0,o.Z)(this,n),a=t.call(this,e),(0,d.Z)((0,s.Z)(a),"state",{first_logfile:"",second_logfile:"",show_second_select:!1,second_logs:[],log_message:"",lineNum:"200",searchText:"",sourceText:"",query:""}),(0,d.Z)((0,s.Z)(a),"onSearch",(function(e){a.setState({query:e},(function(){a.setLogMessage(a.props.content,!1)}))})),(0,d.Z)((0,s.Z)(a),"setContent",(function(e){var t=a.setQueryKey(e),n=new RegExp(/([\S ]*ERROR[\S ]*)/,"gi");return t.replace(n,'<span style="color: red">$1</span>')})),(0,d.Z)((0,s.Z)(a),"setQueryKey",(function(e){var t=a.state.query;if(""===t)return e;var n=t.toLowerCase(),r=new RegExp("(".concat(n,")"),"gi");return e.replace(r,'<span style="color: #2391F7">$1</span>')})),(0,d.Z)((0,s.Z)(a),"setLogMessage",(function(e,t){var n=a.props.fileGoBottom,r=document.getElementById("textPre");r&&(r.innerHTML=a.setContent(e||""),(void 0===t?n:t)&&document.getElementsByClassName("log-message-box").length>0&&document.getElementsByClassName("log-message-box")[0].scrollTo(0,r.offsetHeight))})),(0,d.Z)((0,s.Z)(a),"renderServiceSelect",(function(){var e=a.props,t=e.serviceData,n=e.onSelectedService;return y.createElement(_.Z,{showSearch:!0,style:{width:200,marginRight:10},dropdownStyle:{maxHeight:400,overflow:"auto"},placeholder:"按服务搜索",allowClear:!0,treeDefaultExpandAll:!0,onChange:n},function(e){var t=[],n=function(n){if(Object.prototype.hasOwnProperty.call(e,n)){var a=e[n];t.push(y.createElement(N,{value:n,title:n,key:n,selectable:!1},a&&m()(a).call(a,(function(e){return y.createElement(N,{isLeaf:!0,value:e.service_name,title:e.service_name_display,key:n+"-"+e.service_name})}))))}};for(var a in e)n(a);return t}(t))})),a}return(0,l.Z)(n,[{key:"componentDidMount",value:function(){this.setLogMessage(this.props.content)}},{key:"componentDidUpdate",value:function(e,t){var n=document.getElementById("textPre");this.props.content===e.content&&this.props.content&&!n.innerHTML&&this.setLogMessage(this.props.content),this.props.content!==e.content&&this.setLogMessage(this.props.content)}},{key:"render",value:function(){var e=this.props,t=e.visible,n=e.onCancel,a=e.title,r=e.maskClosable,o=e.onSelectedFile,l=e.fileList,s=e.content,c=e.selectedFile,i=e.serviceData,u=e.loading;return y.createElement(E.Z,{className:"logtail-box",destroyOnClose:!0,title:a,footer:null,width:800,visible:t,maskClosable:r,onCancel:n},y.createElement("div",{className:"logtail-box"},y.createElement("div",{className:"option-bar",style:{display:"flex"}},i&&y.createElement("span",null,this.renderServiceSelect()),l?y.createElement(Z.Z,{allowClear:!0,showSearch:!0,placeholder:"选择文件",value:c,style:{width:200,marginBottom:10,marginRight:10},onChange:o},m()(l).call(l,(function(e,t){var n,a=h()(e).call(e);return y.createElement(x,{key:v()(n="".concat(a,"-")).call(n,t),value:a},y.createElement(S.Z,{title:a},a))}))):null,y.createElement(C.Z.Search,{placeholder:"输入关键词",style:{width:200,marginBottom:10},onSearch:this.onSearch})),y.createElement("div",{className:"log-message-box",style:{height:"400px",paddingTop:"10px",overflowY:"auto",backgroundColor:"#F5F5F5",border:"1px dashed #DDDDDD"}},s?y.createElement("pre",{id:"textPre",style:{paddingLeft:10,height:"auto"}}):null,""===s?y.createElement("div",{style:{lineHeight:"380px",color:"#dddddd",textAlign:"center"}},"没有记录"):null,null===s?y.createElement("div",{style:{lineHeight:"380px",color:"#dddddd",textAlign:"center"}},"请选择上方过滤条件"):null,u&&s&&y.createElement(b.Z,{className:"ml-10",type:"loading"}))))}}]),n}(y.Component)},65778:(e,t,n)=>{n.d(t,{Z:()=>F});var a=n(1068),r=n.n(a),o=n(68420),l=n(27344),s=n(5281),c=n(84441),i=n(3020),u=n(3362),d=n(44845),p=n(81643),m=n.n(p),f=n(94198),h=n.n(f),g=n(78914),v=n.n(g),y=n(3649),Z=n.n(y),_=n(2991),E=n.n(_),S=n(25843),C=n.n(S),b=n(67294),k=n(34041),x=n(45360),N=n(31097),w=n(4107),P=n(67908),L=n(78241);function D(e){var t=function(){if("undefined"==typeof Reflect||!r())return!1;if(r().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(r()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,u.Z)(e);if(t){var o=(0,u.Z)(this).constructor;n=r()(a,arguments,o)}else n=a.apply(this,arguments);return(0,i.Z)(this,n)}}var I=k.Z.Option,F=function(e){(0,c.Z)(n,e);var t=D(n);function n(e){var a;return(0,o.Z)(this,n),a=t.call(this,e),(0,d.Z)((0,s.Z)(a),"state",{first_logfile:"",second_logfile:"",show_second_select:!1,second_logs:[],log_message:"",lineNum:"200",searchText:"",sourceText:""}),(0,d.Z)((0,s.Z)(a),"handleMenu1Click",(function(e){var t=(0,s.Z)(a),n=a.props.serviceid;m()(e).call(e,"*")>-1?L.get("/api/v2/instance/".concat(n,"/log"),{logfile:e.replace(/\s+/g,""),is_match:!1}).then((function(n){var a,r,o;0===(n=n.data).code?t.setState({first_logfile:e,second_logs:null===(a=n)||void 0===a||null===(r=a.data)||void 0===r||null===(o=r.result)||void 0===o?void 0:o.replace(/\s+/g,"").split(","),show_second_select:!0}):x.Z.error(n.msg)})):L.get("/api/v2/instance/".concat(n,"/log"),{logfile:e,is_match:!0}).then((function(n){0===(n=n.data).code?(t.setState({first_logfile:e,show_second_select:!1,sourceText:n.data.result}),a.setLogMessage(n.data.result,!0)):x.Z.error(n.msg)}))})),(0,d.Z)((0,s.Z)(a),"handleMenu2Click",(function(e){var t=(0,s.Z)(a),n=a.props.serviceid;L.get("/api/v2/instance/".concat(n,"/log"),{logfile:e,is_match:!0,tail_num:a.state.lineNum}).then((function(n){0===(n=n.data).code?(t.setState({second_logfile:e,show_second_select:!0,sourceText:n.data.result}),a.setLogMessage(n.data.result)):x.Z.error(n.msg)}))})),(0,d.Z)((0,s.Z)(a),"handleRefreshLogs",(function(){var e=a.props.serviceid,t=a.state.first_logfile;(h()(a.state.lineNum)>1e3||h()(a.state.lineNum)<0)&&x.Z.error("行数只能位于0-1000之间"),a.state.second_logfile&&(t=a.state.second_logfile),L.get("/api/v2/instance/".concat(e,"/log"),{logfile:t,is_match:!0,tail_num:a.state.lineNum}).then((function(e){0===(e=e.data).code?(a.setState({sourceText:e.data.result}),a.setLogMessage(e.data.result,!0)):x.Z.error(e.msg)}))})),(0,d.Z)((0,s.Z)(a),"handleLineNumChange",(function(e){a.setState({lineNum:e.target.value})})),(0,d.Z)((0,s.Z)(a),"handleSearchChange",(function(e){var t=e.toLowerCase();if(a.setState({searchText:e}),""!==e){var n=a.state.sourceText.toLocaleLowerCase().split(t),r=[];v()(n).call(n,(function(e){r.push(e.length)}));var o=[],l=0;v()(r).call(r,(function(t){o.push(l+t),l+=t+e.length}));for(var s="",c="",i=a.state.sourceText,u=0,d=0;d<o.length;d++)c=Z()(i).call(i,o[d],o[d]+e.length),c='<span style="color: red">'.concat(c,"</span>"),s+=Z()(i).call(i,u,o[d])+c,u=o[d]+e.length;a.setLogMessage(s)}else a.setLogMessage(a.state.sourceText)})),(0,d.Z)((0,s.Z)(a),"setLogMessage",(function(e,t){document.getElementById("textPre").innerHTML=e,t&&document.getElementsByClassName("log-message-box").length>0&&document.getElementsByClassName("log-message-box")[0].scrollTo(0,document.getElementById("textPre").offsetHeight),a.setState({log_message:e})})),a}return(0,l.Z)(n,[{key:"UNSAFE_componentWillReceiveProps",value:function(e){}},{key:"render",value:function(){var e=this.props.logs,t=this.state,n=t.first_logfile,a=t.second_logfile,r=t.second_logs,o=void 0===r?[]:r;return b.createElement("div",{className:"logtail-box"},b.createElement("div",{className:"option-bar",style:{display:"flex"}},b.createElement(k.Z,{style:{height:26,minWidth:150,marginBottom:10},value:n,onChange:this.handleMenu1Click},E()(e).call(e,(function(e,t){return b.createElement(I,{key:t+"",value:e},b.createElement(N.Z,{key:t+"",title:e},e))}))),b.createElement("div",{style:this.state.show_second_select?{display:"inline-block",marginLeft:8}:{display:"none"}},b.createElement(k.Z,{style:{height:26,minWidth:150,maxWidth:300,marginBottom:10},value:a,onChange:this.handleMenu2Click},E()(o).call(o,(function(e,t){return b.createElement(I,{key:t+"",value:e},b.createElement(N.Z,{key:t+"",title:C()(e).call(e)},C()(e).call(e)))})))),b.createElement(w.Z,{placeholder:"输入日志行数，“0-1000”之间",onPressEnter:this.handleRefreshLogs,style:{height:26,width:230,marginLeft:8,marginBottom:10},onChange:this.handleLineNumChange,addonAfter:b.createElement(P.Z,{style:{cursor:"pointer"},onClick:this.handleRefreshLogs,type:"reload"})}),b.createElement(w.Z.Search,{placeholder:"输入关键词",style:{height:26,width:179,marginLeft:10,marginBottom:10},onSearch:this.handleSearchChange})),b.createElement("div",{className:"log-message-box",style:{height:"400px",paddingTop:"10px",overflowY:"auto",backgroundColor:"#F5F5F5",border:"1px dashed #DDDDDD"}},b.createElement("span",null,b.createElement("pre",{id:"textPre",style:{paddingLeft:10}}))))}}]),n}(b.Component)},43138:(e,t,n)=>{n.d(t,{Z:()=>m});var a=n(1068),r=n.n(a),o=n(68420),l=n(27344),s=n(84441),c=n(3020),i=n(3362),u=n(67294),d=n(67908);function p(e){var t=function(){if("undefined"==typeof Reflect||!r())return!1;if(r().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(r()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,i.Z)(e);if(t){var o=(0,i.Z)(this).constructor;n=r()(a,arguments,o)}else n=a.apply(this,arguments);return(0,c.Z)(this,n)}}const m=function(e){(0,s.Z)(n,e);var t=p(n);function n(e){return(0,o.Z)(this,n),t.call(this,e)}return(0,l.Z)(n,[{key:"render",value:function(){var e=this.props,t=e.style,n=e.handleClickTop,a=e.handleClickUp,r=e.handleClickDown,o=e.handleClickNew;return u.createElement("div",{className:"special_pagination",style:t},u.createElement("button",{onClick:n},"TOP"),u.createElement("button",{onClick:a},u.createElement(d.Z,{type:"up"})),u.createElement("button",{onClick:r},u.createElement(d.Z,{type:"down"})),u.createElement("button",{onClick:o},"NEW"))}}]),n}(u.Component)},18274:(e,t,n)=>{n.d(t,{E9:()=>s,MD:()=>a,OY:()=>o,RI:()=>l,XN:()=>r});var a=[{text:"部署成功",value:"deployed"},{text:"部署失败",value:"deploy fail"},{text:"部署中",value:"deploying"},{text:"卸载失败",value:"undeploy fail"},{text:"卸载中",value:"undeploying"}],r=[{text:"更新成功",value:"success"},{text:"更新失败",value:"fail"},{text:"更新中",value:"update"}],o={hosts:["主机集群"],kubernetes:["Kubernetes集群（自建集群）","Kubernetes集群（导入已有集群）"]},l={hosts:{title:"主机安装会经过2个状态：管控安装-主机初始化，若某一步安装失败，请查看具体日志。",filters:[{text:"管控安装成功",value:"管控安装成功"},{text:"管控安装失败",value:"管控安装失败"},{text:"script安装成功",value:"script安装成功"},{text:"script安装失败",value:"script安装失败"},{text:"主机初始化成功",value:"主机初始化成功"},{text:"主机初始化失败",value:"主机初始化失败"}],finalStatus:3},kubernetes:{title:"Kubernetes集群主机安装会经过5个状态：管控安装-主机初始化-K8S Docker初始化-K8S Node初始化-K8S Node部署成功，若某一步安装失败，请查看具体日志",filters:[{text:"管控安装失败",value:"管控安装失败",status:-1},{text:"管控安装成功",value:"管控安装成功",status:1},{text:"主机初始化失败",value:"主机初始化失败",status:-3},{text:"主机初始化成功",value:"主机初始化成功",status:3},{text:"K8S DOCKER初始化失败",value:"K8S DOCKER初始化失败",status:-5},{text:"K8S DOCKER初始化成功",value:"K8S DOCKER初始化成功",status:5},{text:"K8S NODE初始化失败",value:"K8S NODE初始化失败",status:-6},{text:"K8S NODE初始化成功",value:"K8S NODE初始化成功",status:6},{text:"K8S NODE部署失败",value:"K8S NODE部署失败",status:-7},{text:"K8S NODE部署成功",value:"K8S NODE部署成功",status:7}],finalStatus:7}},s={NAMESPACE:"em_current_k8s_namespace"}},42238:(e,t,n)=>{n.d(t,{Y:()=>r,v:()=>a});var a={labelCol:{xs:{span:24},sm:{span:8}},wrapperCol:{xs:{span:24},sm:{span:12}}},r={labelCol:{xs:{span:24},sm:{span:6}},wrapperCol:{xs:{span:24},sm:{span:16}}}},37092:(e,t,n)=>{n.d(t,{Z:()=>P});var a=n(71649),r=n(95266),o=n(32366),l=n.n(o),s=n(86902),c=n.n(s),i=n(77766),u=n.n(i),d=n(39969),p=n.n(d),m=n(67294),f=n(45360),h=n(77268),g=n(30258),v=n(11382),y=n(14277),Z=n(74981),_=(n(44576),n(68886),n(40049),n(55827)),E=n(30381),S=n.n(E),C=n(36808),b=n(96486),k=function(e,t){var n,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r=l()(n=c()(a)).call(n,(function(e,t){var n,r;return u()(n=u()(r="".concat(e)).call(r,t,"=")).call(n,a[t],"&")}),"".concat(e,"?")).replace(/&$/,"");fetch(r).then((function(e){return e.blob()})).then((function(e){var n=p().createObjectURL(e),a=document.createElement("a");a.href=n,a.download=t,a.click(),p().revokeObjectURL(a.href)})).catch((function(e){f.Z.error(e.message)}))},x=function(e){var t=e.title,n=e.visible,a=e.type,r=e.onColse,o=e.execId,l=e.showFooter,s=void 0===l||l,c=m.useRef(null),i=m.useCallback((function(e){var t=e.type,n=e.payload;switch(t){case"log":k("/api/v2/cluster/downLoadShellLog","".concat(o,"-shell.log"),n);break;case"echo":k("/api/v2/cluster/downLoadShellContent","".concat(o,"-content.sh"),n)}}),[]),u="echo"===a?m.createElement(h.Z,{type:"primary",disabled:!o,onClick:b.debounce((function(){return i({type:"echo",payload:{execId:o}})}),200)},"下载完整脚本"):m.createElement(h.Z,{type:"primary",disabled:!o,onClick:b.debounce((function(){i({type:"log",payload:{clusterId:C.get("em_current_cluster_id"),execId:o}})}),200)},"下载完整日志");return m.createElement(g.Z,{className:"code-view-modal",width:"echo"===a?520:1050,title:t,visible:n,footer:s?u:null,onCancel:function(e){c.current&&c.current.wsClose(),r()}},"echo"===a?m.createElement(N,{execId:o}):m.createElement(w,{execId:o,cref:c}))},N=function(e){var t=e.execId,n=m.useState(""),a=(0,r.Z)(n,2),o=a[0],l=a[1];return m.useEffect((function(){t&&function(e){_.Z.showShellContent({execId:e}).then((function(e){var t=e.data,n=t.data,a=t.code,r=t.msg;if(0===a)return l(n);f.Z.error(r)})).catch((function(e){f.Z.error(e.message)}))}(t)}),[t]),m.createElement(Z.ZP,{className:"ace-code-portal",mode:"golang",theme:"kuroir",value:o,readOnly:!0,width:"400px",height:"100%",showGutter:!1})},w=function(e){var t=e.execId,n=e.cref,o=m.useState([]),l=(0,r.Z)(o,2),s=l[0],c=l[1],i=m.useState(!1),d=(0,r.Z)(i,2),p=d[0],f=d[1],h=m.useRef(null);m.useImperativeHandle(n,(function(){return{wsClose:function(){h.current&&h.current.close(),h.current=null}}}));m.useEffect((function(){if(t)try{var e,n;h.current=new WebSocket(u()(e=u()(n="ws://".concat(window.location.hostname,":")).call(n,window.location.port,"/api/v2/cluster/showShellLog?execId=")).call(e,t)),h.current.onmessage=function(e){c((function(t){var n;return u()(n=[]).call(n,(0,a.Z)(t),[{time:"[".concat(S()().format("hh:mm:ss"),"]"),message:e.data}])})),f(!1)},h.current.onopen=function(e){f(!0)},h.current.onerror=function(e){f(!1)},h.current.onclose=function(){f(!1)}}catch(e){f(!1)}}),[t]);return m.createElement(v.Z,{spinning:p},s.length?m.createElement("div",{className:"log-info"},m.createElement("ul",{dangerouslySetInnerHTML:{__html:function(e){var t="";for(var n in e){t+="\n        <li>\n          <pre>".concat(e[n].message,"</pre>\n        </li>\n      ")}return t}(s)}})):m.createElement(y.Z,null))};const P=m.memo(x,(function(e,t){return e.execId===t.execId}))},6101:(e,t,n)=>{n.d(t,{Z:()=>S});var a=n(1068),r=n.n(a),o=n(44930),l=n(68420),s=n(27344),c=n(5281),i=n(84441),u=n(3020),d=n(3362),p=n(44845),m=n(63109),f=n.n(m),h=n(77766),g=n.n(h),v=n(67294),y=n(96486),Z=n(19528),_=n(28568);function E(e){var t=function(){if("undefined"==typeof Reflect||!r())return!1;if(r().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(r()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,d.Z)(e);if(t){var o=(0,d.Z)(this).constructor;n=r()(a,arguments,o)}else n=a.apply(this,arguments);return(0,u.Z)(this,n)}}const S=function(e){(0,i.Z)(n,e);var t=E(n);function n(){var e,a;(0,l.Z)(this,n);for(var r=arguments.length,s=new Array(r),i=0;i<r;i++)s[i]=arguments[i];return a=t.call.apply(t,g()(e=[this]).call(e,s)),(0,p.Z)((0,c.Z)(a),"state",{loading:!1,selectedService:null,configList:[],showModal:!1,modalContent:null,visibleConfigInfo:!1,selectedFile:void 0,serviceGroup:null}),(0,p.Z)((0,c.Z)(a),"loadServiceGroup",function(){var e=(0,o.Z)(f().mark((function e(t){var n;return f().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!a.props.shouldGetAll){e.next=7;break}return e.next=4,Z.BZ.getAllServiceGroup(t);case 4:e.t0=e.sent,e.next=10;break;case 7:return e.next=9,Z.BZ.getServiceGroup(t);case 9:e.t0=e.sent;case 10:0===(n=e.t0).data.code&&a.setState({serviceGroup:(0,y.get)(n,"data.data.groups",{})});case 12:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),(0,p.Z)((0,c.Z)(a),"onShowConfigInfo",(function(e){var t=a.props.shouldGetAll;e&&e.product_name&&a.setState({visibleConfigInfo:!0},(function(){var n={product_name:e.product_name};t&&(n.product_version=e.product_version),a.loadServiceGroup(n)}))})),(0,p.Z)((0,c.Z)(a),"getConfigList",(function(e){Z._7.getServiceTree(e).then((function(e){0===e.data.code&&a.setState({configList:(0,y.get)(e,"data.data.list",[])})}))})),(0,p.Z)((0,c.Z)(a),"getConfigContent",(function(e){Z._7.getServiceFile(e).then((function(e){0===e.data.code&&a.setState({modalContent:(0,y.get)(e,"data.data","")})}))})),(0,p.Z)((0,c.Z)(a),"onSelectedFile",(function(e){var t=a.props.componentData;a.setState({selectedFile:e});var n=a.state.selectedService;a.getConfigContent({file:e,serviceName:n,productName:t.product_name,productVersion:t.product_version})})),(0,p.Z)((0,c.Z)(a),"onSelectedConfigService",(function(e){var t=a.props.componentData;a.setState({selectedService:e,selectedFile:void 0,configList:[]}),a.getConfigList({serviceName:e,productName:t.product_name,productVersion:t.product_version})})),(0,p.Z)((0,c.Z)(a),"onCloseModal",(function(){a.setState({visibleConfigInfo:!1,selectedService:null,selectedFile:void 0,modalContent:null},(function(){a.props.onClose()}))})),(0,p.Z)((0,c.Z)(a),"render",(function(){var e=a.state.visibleConfigInfo;return v.createElement(v.Fragment,null,v.createElement(_.Z,{key:"configModal",title:"配置信息",fileList:a.state.configList,visible:e,content:a.state.modalContent,serviceData:a.state.serviceGroup,onCancel:a.onCloseModal,selectedFile:a.state.selectedFile,onSelectedFile:a.onSelectedFile,onSelectedService:a.onSelectedConfigService}))})),a}return(0,s.Z)(n,[{key:"componentDidMount",value:function(){var e=this.props.componentData;this.props.componentData&&this.onShowConfigInfo(e)}},{key:"componentDidUpdate",value:function(e){e.componentData!==this.props.componentData&&this.onShowConfigInfo(this.props.componentData)}}]),n}(v.Component)},24455:(e,t,n)=>{n.r(t),n.d(t,{default:()=>kt});var a,r=n(1068),o=n.n(r),l=n(73126),s=n(68420),c=n(27344),i=n(5281),u=n(84441),d=n(3020),p=n(3362),m=n(44845),f=n(77766),h=n.n(f),g=n(11128),v=n.n(g),y=n(78914),Z=n.n(y),_=n(86902),E=n.n(_),S=n(94473),C=n.n(S),b=n(51942),k=n.n(b),x=n(78580),N=n.n(x),w=n(41511),P=n.n(w),L=n(2991),D=n.n(L),I=n(67294),F=n(29027),T=n(34041),M=n(4107),R=n(45360),U=n(67908),B=n(77268),V=n(96486),O=n(19528),A=n(71649),K=n(44930),j=n(63109),z=n.n(j),H=n(33032),G=n.n(H),q=n(54103),W=n.n(q),Y=n(92762),$=n.n(Y),J=n(20116),Q=n.n(J),X=n(30258),ee=n(31097),te=n(27049),ne=n(75443),ae=n(8263),re=n(15857),oe=n(4482),le=n(18274),se=n(31581),ce=n.n(se),ie=n(26855),ue=n(45334),de=n(11382),pe=n(43138),me=n(65778);function fe(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,p.Z)(e);if(t){var r=(0,p.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,d.Z)(this,n)}}const he=(0,F.$j)((function(e){return{deployProps:e.UnDeployStore}}),(function(e){return{actions:(0,re.DE)(k()({},oe),e)}}))(a=function(e){(0,u.Z)(n,e);var t=fe(n);function n(e){var a;return(0,s.Z)(this,n),a=t.call(this,e),(0,m.Z)((0,i.Z)(a),"timerInterval",null),(0,m.Z)((0,i.Z)(a),"state",{log_modal_visible:!1,logpaths:[],log_service_id:"",status:"",title:""}),(0,m.Z)((0,i.Z)(a),"clearIntervals",(function(){clearInterval(a.timerInterval)})),(0,m.Z)((0,i.Z)(a),"loadCurrentScreenList",(function(e){a.timerInterval=ce()((0,K.Z)(z().mark((function t(){var n,r,o,l,s;return z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=a.props,r=n.progressType,o=n.actions,l=n.deployProps,s=n.getDataList,t.next=3,o.getCurrentUnDepolyList({deployUuid:l.deploy_uuid,start:e||0,limit:20,status:a.state.status});case 3:("undeploying"!==l.complete&&"unDeploy"===r||"deploying"!==l.complete&&"rollback"===r)&&clearInterval(a.timerInterval),"undeployed"===l.complete||"deployed"===l.complete?(ie.Z.success({message:"提示",description:"unDeploy"===r?"卸载成功！":"回滚成功！",duration:0}),s()):("undeploying"!==l.complete&&"unDeploy"===r||"deploying"!==l.complete&&"rollback"===r)&&ie.Z.error({message:"提示",description:"unDeploy"===r?"卸载失败！":"回滚失败！",duration:0});case 5:case"end":return t.stop()}}),t)}))),3e3)})),(0,m.Z)((0,i.Z)(a),"loadLastScreen",(function(){a.props.actions.getUnDepolyList({deployUuid:a.props.deployProps.deploy_uuid,start:a.props.deployProps.count-20>0?a.props.deployProps.count-20:0,limit:20,status:a.state.status})})),(0,m.Z)((0,i.Z)(a),"showDeployLog",(function(e){var t=JSON.parse(e.schema?e.schema:"{}");a.setState({log_modal_visible:!0,logpaths:t.Instance?t.Instance.Logs:[],log_service_id:e.instance_id})})),(0,m.Z)((0,i.Z)(a),"forceSuccessRefesh",(function(){a.props.actions.getCurrentUnDepolyList({deployUuid:a.props.deployProps.deploy_uuid,start:a.props.deployProps.start||0,limit:20,status:a.state.status})})),(0,m.Z)((0,i.Z)(a),"initColumns",(function(){var e=a.state.title;return[{title:"执行时间",dataIndex:"update_time"},{title:"服务名称",dataIndex:"service_name"},{title:"服务版本号",dataIndex:"service_version"},{title:"主机IP",dataIndex:"ip"},{title:"组件版本号",dataIndex:"product_version"},{title:"".concat(e,"进度"),dataIndex:"progressbar",render:function(e,t){var n="force uninstall"===t.status_message||"force stop"===t.status_message;return I.createElement(ue.Z,{percent:t.progress,status:"stop fail"===t.status||"uninstall fail"===t.status||n?"exception":"normal"})}},{title:"".concat(e,"状态"),dataIndex:"status",filters:"undeploying"!==a.props.deployProps.complete?[{text:"uninstalling",value:"uninstalling"},{text:"uninstall fail",value:"uninstall fail"},{text:"uninstalled",value:"uninstalled"},{text:"stopping",value:"stopping"},{text:"stopped",value:"stopped"},{text:"stop fail",value:"stop fail"}]:[],render:function(e,t){var n={};switch(t.status){case"install fail":case"run fail":case"health-check fail":case"health-check cancelled":case"undeploy fail":case"undeploying":case"stop fail":case"uninstall fail":n={color:"#FF5F5C"};break;case"undeployed":case"installed":case"health-checked":n={color:"#12BC6A"}}return I.createElement("div",null,I.createElement("span",{style:n},e),I.createElement(ee.Z,{title:t.status_message},t.status_message?I.createElement(U.Z,{style:{marginLeft:3},type:"info-circle"}):null))}},{title:"操作",dataIndex:"action",render:function(t,n){var r=!1,o=JSON.parse(n.schema?n.schema:"{}");o&&o.Instance&&o.Instance.Logs&&(r=!0);var l=!1,s=!1;switch(n.status){case"stop fail":l=!0,s=!0;break;case"uninstall fail":l=!0,s=!1;break;default:l=!1,s=!1}return I.createElement("span",null,r?I.createElement("a",{onClick:function(){return a.showDeployLog(n)}},e,"详情"):l?null:"-",l?I.createElement(ne.Z,{title:s?"是否强制停止!":"是否强制卸载!",okText:"是",cancelText:"否",onConfirm:function(){s?a.props.actions.forceStop(n.id,a.forceSuccessRefesh):a.props.actions.forceUninstall(n.id,a.forceSuccessRefesh)}},I.createElement("span",null,r?I.createElement(te.Z,{type:"vertical"}):null,s?I.createElement("a",{style:{color:"#E6432C"}},"强制停止"):I.createElement("a",{style:{color:"#E6432C"}},"强制卸载"))):null)}}]})),(0,m.Z)((0,i.Z)(a),"handleTableChange",(function(e,t,n){a.clearIntervals(),a.props.actions.getUnDepolyList({deployUuid:a.props.deployProps.deploy_uuid,start:0,limit:20,status:t.status.join(",").toString()})})),(0,m.Z)((0,i.Z)(a),"modalClose",(function(){a.setState({log_modal_visible:!1})})),a}return(0,c.Z)(n,[{key:"componentDidUpdate",value:function(e,t){var n=this,a=this.props,r=a.deployProps,o=a.progressType;if(r.deploy_uuid&&e.deployProps.deploy_uuid!==r.deploy_uuid){var l="rollback"===o?"回滚":"卸载";this.setState({title:l},(function(){n.loadCurrentScreenList(r.start)}))}}},{key:"componentWillUnmount",value:function(){this.clearIntervals()}},{key:"render",value:function(){var e=this,t=this.props,n=t.visible,a=t.onClose,r=t.deployReacord,o=t.deployProps,l=this.state.title,s=this.initColumns(),c="undeploying"===o.complete,i=o.start-20>0?o.start-20:0,u=o.count-20>0?o.count-20:0;return I.createElement("div",null,I.createElement(X.Z,{title:I.createElement("span",null,I.createElement("span",{className:"title__span--progress"},l),I.createElement("span",{className:"title__span--component"},"组件名称：","".concat(r.product_name_display)),I.createElement("span",{className:"title__span--component"},"组件版本号：","".concat(r.product_version))),width:"1000px",footer:null,maskClosable:!1,visible:n,onCancel:a},I.createElement("div",{className:"table-pagination_wraper"},I.createElement(ae.Z,{rowKey:"id",size:"small",className:"border-table",bordered:!0,columns:s,pagination:!1,onChange:this.handleTableChange,dataSource:o.unDeployList}),"undeploying"===o.complete?I.createElement("div",{className:"table-pagination_wraper_spin"},I.createElement(de.Z,null)):null,o.unDeployList.length>0?I.createElement(pe.Z,{handleClickTop:function(){e.clearIntervals(),e.props.actions.getCurrentUnDepolyList({deployUuid:o.deploy_uuid,start:0,limit:20,status:e.state.status}),c&&e.loadCurrentScreenList()},handleClickUp:function(){e.clearIntervals(),e.props.actions.getUnDepolyList({deployUuid:o.deploy_uuid,start:i,limit:20,status:e.state.status}),c&&e.loadCurrentScreenList(i)},handleClickDown:function(){e.clearIntervals(),e.props.actions.getUnDepolyList({deployUuid:o.deploy_uuid,start:u,limit:20,status:e.state.status}),c&&e.loadCurrentScreenList(u)},handleClickNew:function(){e.clearIntervals(),e.loadLastScreen(),c&&e.loadCurrentScreenList(u)}}):null)),I.createElement(X.Z,{title:"".concat(l,"详情"),visible:this.state.log_modal_visible,onCancel:this.modalClose,onOk:this.modalClose,width:800},I.createElement(me.Z,{logs:this.state.logpaths,serviceid:this.state.log_service_id,isreset:!this.state.log_modal_visible})))}}]),n}(I.Component))||a;var ge=n(6101),ve=n(14310),ye=n.n(ve),Ze=n(34074),_e=n.n(Ze),Ee=n(39649),Se=n.n(Ee),Ce=n(20368),be=n.n(Ce),ke=n(63978),xe=n.n(ke),Ne=n(95266),we=n(59340),Pe=n.n(we),Le=n(69035),De=n(37870),Ie=n(66253),Fe=n(42238),Te=n(37092);function Me(e,t){var n=E()(e);if(ye()){var a=ye()(e);t&&(a=Q()(a).call(a,(function(t){return _e()(e,t).enumerable}))),n.push.apply(n,a)}return n}function Re(e){for(var t=1;t<arguments.length;t++){var n,a,r=null!=arguments[t]?arguments[t]:{};t%2?Z()(n=Me(Object(r),!0)).call(n,(function(t){(0,m.Z)(e,t,r[t])})):Se()?be()(e,Se()(r)):Z()(a=Me(Object(r))).call(a,(function(t){xe()(e,t,_e()(r,t))}))}return e}var Ue=Le.Z.Item,Be=T.Z.Option;const Ve=Le.Z.create()((function(e){var t=e.visible,n=e.type,a=e.onOk,r=e.onCancel,o=e.options,s=e.clusterId,c=e.record,i=e.form,u=e.changeUpgradeType,d=i.getFieldDecorator,p=i.validateFields,m=(0,I.useState)({status:"",exec_id:"",backup_name:""}),f=(0,Ne.Z)(m,2),h=f[0],g=f[1],v=(0,I.useState)({visible:!1,title:"查看日志",type:"log",execId:""}),y=(0,Ne.Z)(v,2),Z=y[0],_=y[1],E=(0,I.useState)(!1),S=(0,Ne.Z)(E,2),C=S[0],b=S[1],x=(0,I.useState)([]),N=(0,Ne.Z)(x,2),w=N[0],P=N[1],L=(0,I.useState)([]),F=(0,Ne.Z)(L,2),M=F[0],V=F[1],A=(0,I.useState)(!1),j=(0,Ne.Z)(A,2),H=j[0],G=j[1],q=(0,I.useState)(null!=c&&c.smooth_upgrade_product?"smooth":"normal"),W=(0,Ne.Z)(q,2),Y=W[0],$=W[1],J=(0,I.useMemo)((function(){return["upgrade"===n?"升级":"回滚","upgrade"===n?"请先备份库，再执行升级部署，部署完成后将自动执行版本间的增量SQL；开始备份后，请勿退出页面，否则将取消本次升级。":"仅支持回滚至 “升级” 操作前的版本，请先备份库，再执行回滚；开始备份后，请勿退出页面，否则将取消本次回滚。"]}),[]),Q=(0,Ne.Z)(J,2),ee=Q[0],te=Q[1];function ne(){return(ne=(0,K.Z)(z().mark((function e(){var t,a,r;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t={cluster_id:s,source_version:null==c?void 0:c.product_version,target_version:i.getFieldValue("target_version")},"running"!==h.status&&(g((function(e){return Re(Re({},e),{},{status:"running"})})),G(!1)),e.next=4,O.aJ.handleBackUp({productName:null==c?void 0:c.product_name},t);case 4:0===(a=e.sent).data.code?"running"!==(r=a.data.data).status&&(g(r),G(!0),"upgrade"===n&&"success"===r.status&&sessionStorage.setItem("product_backup_info",Pe()(Re(Re({},t),{},{backup_name:r.backup_name,backup_sqls:r.backup_sqls})))):(g((function(e){return Re(Re({},e),{},{status:"fail"})})),G(!0),R.Z.error(a.data.msg));case 6:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function ae(){return(ae=(0,K.Z)(z().mark((function e(){var t,n,a;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t={cluster_id:s,product_version:null==c?void 0:c.product_version},(null!=c&&c.smooth_upgrade_product||null!=c&&c.isChildren)&&k()(t,{upgrade_mode:"smooth"}),e.next=4,O.aJ.getRollBackList({productName:null==c?void 0:c.product_name},t);case 4:n=e.sent,0===(a=n.data).code&&P(a.data||[]);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function re(){return(re=(0,K.Z)(z().mark((function e(t){var n,a,r;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n={cluster_id:s,target_version:t},(null!=c&&c.smooth_upgrade_product||null!=c&&c.isChildren)&&k()(n,{upgrade_mode:"smooth"}),e.next=4,O.aJ.getBackupTimes({productName:null==c?void 0:c.product_name},n);case 4:a=e.sent,0===(r=a.data).code&&V(r.data||[]);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}(0,I.useEffect)((function(){"upgrade"!==n&&function(){ae.apply(this,arguments)}()}),[]);var oe=function(){_((function(e){return{visible:!e.visible,title:"日志查看",type:"log",execId:h.exec_id}}))};function le(){b(!1),r()}function se(e){G(!0),function(e){re.apply(this,arguments)}(e)}return I.createElement(I.Fragment,null,I.createElement(X.Z,{title:"组件".concat(ee),visible:t,onCancel:le,className:"product-modal",footer:[I.createElement(B.Z,{key:"cancel",onClick:le},"取消"),I.createElement(B.Z,{loading:C,key:"ok",type:"primary",onClick:function(){p((function(e,t){if(!e){var r=t.target_version;"rollback"===n&&(r={cluster_id:s,source_version:c.product_version,target_version:t.target_version,backup_name:t.backup_name},b(!0)),a(r)}}))},disabled:"success"!==(null==h?void 0:h.status)},ee)]},I.createElement(Le.Z,Fe.Y,I.createElement(De.Z,{className:"mb-20",type:"info",showIcon:!0,message:te}),"upgrade"===n&&(null==c?void 0:c.can_smooth_upgrade)&&I.createElement(Ue,{label:"升级模式"},I.createElement(Ie.ZP.Group,{disabled:!(null==c||!c.smooth_upgrade_product),onChange:function(e){u(e.target.value),$(e.target.value)},name:"radiogroup",defaultValue:Y},I.createElement(Ie.ZP,{value:"normal"},"普通升级"),I.createElement(Ie.ZP,{value:"smooth"},"平滑升级")),I.createElement("div",{className:"modeTips"},"normal"===Y?"一键升级至目标版本，过程中会有短暂停服。":"通过多次升级平滑过渡至目标版本，升级过程不停服。")),I.createElement(Ue,{label:"目标组件版本"},d("target_version",{rules:[{required:!0,message:"请选择目标组件版本"}]})(I.createElement(T.Z,{onChange:function(e){return se(e)},placeholder:"请选择目标组件版本"},"upgrade"===n?D()(o).call(o,(function(e){return I.createElement(Be,{key:e.id,value:e.product_version},e.product_version)})):D()(w).call(w,(function(e){return I.createElement(Be,{key:e,value:e},e)}))))),"upgrade"!==n&&I.createElement(Ue,{label:"备份库还原"},d("backup_name",{rules:[{required:!0,message:"备份库缺失"}]})(I.createElement(T.Z,{placeholder:"请选择备份时间",disabled:!H,onChange:function(e){return function(e){e&&(null!=c&&c.smooth_upgrade_product||null!=c&&c.isChildren)&&g((function(e){return Re(Re({},e),{},{status:"success"})}))}(e)}},D()(M).call(M,(function(e){return I.createElement(Be,{key:e,value:e},e)}))))),("upgrade"===n||!(null!=c&&c.smooth_upgrade_product)&&!(null!=c&&c.isChildren)&&"upgrade"!==n)&&I.createElement(Ue,{label:"备份当前库",style:{marginBottom:0}},I.createElement(B.Z,{type:"primary",onClick:function(){return ne.apply(this,arguments)},disabled:!H},"开始备份"),I.createElement("div",{className:"tips"},"running"===(null==h?void 0:h.status)&&I.createElement("div",{className:"backuping"},I.createElement(U.Z,{type:"reload",spin:!0})," 备份中，请勿退出"),"success"===(null==h?void 0:h.status)&&I.createElement("div",{className:"backupsuccess"},I.createElement("span",null,I.createElement(U.Z,{type:"check-circle",theme:"filled"})," 备份成功"),I.createElement("span",null,h.backup_name)),"fail"===(null==h?void 0:h.status)&&I.createElement("div",{className:"backupfail"},I.createElement("span",null,I.createElement(U.Z,{type:"close-circle",theme:"filled"})," 备份失败"),I.createElement("a",{onClick:function(e){return oe()}},"查看日志")))))),Z.visible&&I.createElement(Te.Z,(0,l.Z)({},Z,{showFooter:!1,onColse:oe})))}));var Oe,Ae=n(64143);function Ke(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,p.Z)(e);if(t){var r=(0,p.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,d.Z)(this,n)}}var je=T.Z.Option;const ze=(0,F.$j)((function(e){return{authorityList:e.UserCenterStore.authorityList,deployProp:e.DeployStore}}),(function(e){return{unDeployActions:(0,re.DE)(k()({},oe),e)}}))(Oe=function(e){(0,u.Z)(n,e);var t=Ke(n);function n(){var e,a;(0,s.Z)(this,n);for(var r=arguments.length,o=new Array(r),l=0;l<r;l++)o[l]=arguments[l];return a=t.call.apply(t,h()(e=[this]).call(e,o)),(0,m.Z)((0,i.Z)(a),"state",{componentData:{list:[],count:0},loading:!1,searchParam:{productName:void 0,parentProductName:void 0,clusterId:void 0,productVersion:void 0,deploy_status:"","sort-by":"deploy_time","sort-dir":"desc",limit:10,start:0},isShowUnDeploy:!1,progressModalType:"",unDeployRecord:"",activeKey:"",modalStatus:"",selectedRecord:void 0,currentPage:1,showModal:!1,upgradeModalVisible:!1,modalType:"",versionLists:[],record:null,expandedKeys:[]}),(0,m.Z)((0,i.Z)(a),"errorMsg",(function(){R.Z.error("权限不足，请联系管理员！")})),(0,m.Z)((0,i.Z)(a),"getDataList",(function(){var e=!1,t=k()({},a.state.searchParam);t.parentProductName&&(t.start=t.start*t.limit,t.deploy_status&&(e=!0,t.deploy_status=t.deploy_status.join(",")),t.productName&&(e=!0,t.productName=t.productName.join(",")),t.productVersion&&(e=!0),t.mode=a.props.mode,t.mode&&(e=!0),a.setState({loading:!0}),O.t6.getAllProducts(t).then((function(t){if(0===(t=t.data).code){var n,r=t.data,o=[];D()(n=t.data.list).call(n,(function(t,n){var a;if(t.key=h()(a="tr_".concat(t.id)).call(a,n),e&&o.push(t.key),null!=t&&t.smooth_upgrade_product){var r,l,s;null!=t&&t.can_rollback||null!=t&&t.can_upgrade||"deploying"===(null==t?void 0:t.status)||(t.isShowNull=!0);var c=[];return c.push(null==t?void 0:t.smooth_upgrade_product),t.children=c,null!=t&&null!==(r=t.smooth_upgrade_product)&&void 0!==r&&r.can_rollback||null!=t&&null!==(l=t.smooth_upgrade_product)&&void 0!==l&&l.can_upgrade||"deploying"==(null==t||null===(s=t.smooth_upgrade_product)||void 0===s?void 0:s.status)||(c[0].isShowNull=!0),c[0].isChildren=!0,c[0].key="tr_".concat(c[0].id),t}})),a.setState({expandedKeys:o,componentData:r})}else R.Z.error(t.msg);a.setState({loading:!1})})))})),(0,m.Z)((0,i.Z)(a),"renderOption",(function(e){return D()(e).call(e,(function(e,t){return I.createElement(je,{key:t+"",value:e},e)}))})),(0,m.Z)((0,i.Z)(a),"handleTableChange",(function(e,t,n){var r,o=k()(a.state.searchParam);(t.type&&(o.type=t.type[0]),o.start=e.current-1,o.deploy_status=t.status,t.product_type)&&(o.product_type=D()(r=t.product_type).call(r,(function(e){return+e})).join(","));if(n){var l=n.field,s=n.order;s&&(o["sort-dir"]="descend"===s?"desc":"asc"),l&&(o["sort-by"]=l)}a.setState({searchParam:o,currentPage:e.current},(function(){a.getDataList()}))})),(0,m.Z)((0,i.Z)(a),"closeUnDeployModal",(function(){var e=a.state.componentData.list,t=a.props,n=t.clusterId,r=t.parentProductName,o=t.getParentClustersList;a.setState({isShowUnDeploy:!1}),G()((function(){e.length>1?a.getDataList():o(n,r)}),2e3)})),(0,m.Z)((0,i.Z)(a),"stopUndeploy",(function(e,t){var n;t?X.Z.confirm({title:"确认要停止卸载吗？",icon:I.createElement(U.Z,{type:"exclamation-circle",theme:"filled"}),okType:"danger",onOk:(n=(0,K.Z)(z().mark((function t(){var n,r,o;return z().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,O.aJ.stopUndeploy({clusterId:a.props.clusterId,namespace:null!==(n=e.namespace)&&void 0!==n?n:"",pid:e.id});case 2:r=t.sent,0===(o=r.data).code?(R.Z.success("停止卸载成功"),a.getDataList()):R.Z.error(o.msg);case 5:case"end":return t.stop()}}),t)}))),function(){return n.apply(this,arguments)})}):a.errorMsg()})),(0,m.Z)((0,i.Z)(a),"handleUpgradeModalCancel",(function(){a.setState({upgradeModalVisible:!1,record:null,versionLists:[],modalType:""})})),(0,m.Z)((0,i.Z)(a),"jumpToGuide",(function(e){var t=a.state,n=t.record,r=t.versionLists,o=C()(r).call(r,(function(t){return t.product_version===e}))||{},l=a.initUrl(n,o);Ae.Z.setNaviKey("menu_ops_center","sub_menu_cluster_list"),a.props.history.push(l),a.handleUpgradeModalCancel()})),(0,m.Z)((0,i.Z)(a),"handleOk",(function(e){var t=a.state,n=t.modalType,r=t.record,o=a.props.deployProp.upgradeType;"upgrade"===n?("smooth"===o?(a.props.unDeployActions.saveForcedUpgrade(null==r?void 0:r.upgrade_service),a.props.unDeployActions.getIsFirstSmooth(!(null==r||!r.can_smooth_upgrade||null!=r&&r.smooth_upgrade_product))):(a.props.unDeployActions.saveForcedUpgrade([]),a.props.unDeployActions.getIsFirstSmooth(!1)),a.jumpToGuide(e)):a.handleRollback(e)})),(0,m.Z)((0,i.Z)(a),"handleRollback",function(){var e=(0,K.Z)(z().mark((function e(t){var n,r,o;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=a.state.record,e.next=3,O.aJ.handleRollBack({productName:null==n?void 0:n.product_name},t);case 3:r=e.sent,0===(o=r.data).code?a.setState({isShowUnDeploy:!0,progressModalType:"rollback",unDeployRecord:n},(function(){a.props.unDeployActions.getUndeploy({deploy_uuid:o.data.deploy_uuid,autoRefresh:!0,complete:"deploying"}),a.getDataList(),a.handleUpgradeModalCancel()})):R.Z.error(o.msg);case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),(0,m.Z)((0,i.Z)(a),"changeUpgradeType",(function(e){var t=a.state.record;a.props.unDeployActions.getUpgradeType(e),a.getProductVersionList(t,e)})),(0,m.Z)((0,i.Z)(a),"handleProductUpgrade",(function(e,t){t.preventDefault(),a.props.unDeployActions.getUpgradeType(null!=e&&e.smooth_upgrade_product?"smooth":"");var n=a.props.authorityList;if(Ae.Z.noAuthorityToDO(n,"package_upgrade"))return!1;a.getProductVersionList(e),a.setState({upgradeModalVisible:!0,modalType:"upgrade",record:e})})),(0,m.Z)((0,i.Z)(a),"handleProductRollback",(function(e,t){t.preventDefault();var n=a.props.authorityList;if(Ae.Z.noAuthorityToDO(n,"package_upgrade"))return!1;a.setState({upgradeModalVisible:!0,modalType:"rollback",record:e})})),(0,m.Z)((0,i.Z)(a),"getProductVersionList",function(){var e=(0,K.Z)(z().mark((function e(t,n){var r,o,l,s,c,i;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={product_name:t.product_name,product_version:t.product_version},("smooth"===n||null!=t&&t.smooth_upgrade_product)&&k()(r,{upgrade_mode:"smooth"}),e.prev=2,e.next=5,O.t6.getProductVersionList(r);case 5:o=e.sent,l=o.data,s=l.code,c=l.data,i=l.msg,0===s?a.setState({versionLists:(null==c?void 0:c.list)||[]}):R.Z.error(i),e.next=13;break;case 10:e.prev=10,e.t0=e.catch(2),R.Z.error(e.t0);case 13:case"end":return e.stop()}}),e,null,[[2,10]])})));return function(t,n){return e.apply(this,arguments)}}()),(0,m.Z)((0,i.Z)(a),"initUrl",(function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1?arguments[1]:void 0,n=a.props,r=n.clusterList,o=void 0===r?[]:r,l=n.clusterId,s=C()(o).call(o,(function(e){return e.clusterId===l}))||{},c="/deploycenter/appmanage/installs?type="+s.clusterType+"&product_version="+((null==t?void 0:t.product_version)||e.product_version)+"&product_name="+e.product_name+"&id="+((null==t?void 0:t.id)||e.id)+"&from="+a.props.location.pathname;return e.namespace&&(c+="&namespace="+e.namespace),null!=t&&t.product_version&&(c=c+"&new_version="+t.product_version+"&redeploy="+s.clusterId),c})),(0,m.Z)((0,i.Z)(a),"handleLink",(function(e,t){var n=a.props,r=n.history,o=n.authorityList,l=o.menu_deploy_guide,s=o.sub_menu_service_view_progress;("重新部署"!==t&&"部署"!==t||(a.props.unDeployActions.saveForcedUpgrade([]),a.props.unDeployActions.getIsFirstSmooth(!1),a.props.unDeployActions.getUpgradeType(""),l))&&("查看进度"!==t||s)?r.push(e):a.errorMsg()})),(0,m.Z)((0,i.Z)(a),"getTableColumns",(function(){var e=a.props,t=e.authorityList,n=e.HeaderStore.cur_parent_cluster,r=t.installed_app_view,o=t.sub_menu_service_stop_delete,l=t.sub_menu_component_delete,s=t.sub_menu_service_stop_force,c=t.sub_menu_service_delete_force,u=[{title:"组件名称",dataIndex:"product_name_display",width:"10%",onCell:function(){return{style:{maxWidth:160,overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",cursor:"pointer"}}},render:function(e){return I.createElement(ee.Z,{placement:"topLeft",title:e},I.createElement("span",null,e))}},{title:"组件版本号",dataIndex:"product_version",key:"product_version",width:"15%",sorter:!0,onCell:function(){return{style:{maxWidth:160,overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis",cursor:"pointer"}}},render:function(e,t){return I.createElement(ee.Z,{placement:"topLeft",title:function(){return I.createElement("span",null,e,1===t.is_current_version&&I.createElement(U.Z,{style:{marginLeft:3},type:"star"}))}},I.createElement("span",null,e,1===t.is_current_version&&I.createElement(U.Z,{style:{marginLeft:3},type:"star"})))}},{title:"命名空间",dataIndex:"namespace",key:"namespace",render:function(e){return e||"--"}},{title:"安装包类型",dataIndex:"product_type",key:"product_type",filters:[{text:"传统包",value:"0"},{text:"Kubernetes包",value:"1"}],render:function(e){return I.createElement("span",null,e?"Kubernetes包":"传统包")}},{title:"部署状态",dataIndex:"status",filters:le.MD,render:function(e,t){var n="";switch(e){case"deploying":n=I.createElement("span",{className:"deploy-status-orange"},I.createElement(U.Z,{style:{fontSize:12,color:"#FFB310",marginRight:6},type:"exclamation-circle",theme:"filled"}),"部署中");break;case"deployed":n=I.createElement("span",{className:"deploy-status-green"},I.createElement(U.Z,{style:{fontSize:12,color:"#12BC6A",marginRight:6},type:"check-circle",theme:"filled"}),"部署成功");break;case"deploy fail":n=I.createElement("span",{className:"deploy-status-red"},I.createElement(U.Z,{style:{fontSize:12,color:"#FF5F5C",marginRight:6},type:"close-circle",theme:"filled"}),"部署失败");break;case"undeploying":n=I.createElement("span",{className:"deploy-status-orange"},I.createElement(U.Z,{style:{fontSize:12,color:"#FFB310",marginRight:6},type:"exclamation-circle",theme:"filled"}),"卸载中");break;case"undeploy fail":n=I.createElement("span",{className:"deploy-status-red"},I.createElement(U.Z,{style:{fontSize:12,color:"#FF5F5C",marginRight:6},type:"close-circle",theme:"filled"}),"卸载失败")}return I.createElement("span",null,n)}},{title:"部署时间",key:"deploy_time",dataIndex:"deploy_time",sorter:!0},{title:"部署人",dataIndex:"username",key:"username",render:function(e,t){return e||"--"}},{title:"查看",dataIndex:"visit",render:function(e,t){return I.createElement(I.Fragment,null,r?I.createElement("a",{onClick:function(){return a.setState({selectedRecord:t})}},"配置"):"--")}},{title:"操作",width:200,dataIndex:"action",render:function(e,t){var r,u,d,p=a.props.clusterId,m=!1,f="部署";(null!=t&&t.smooth_upgrade_product||null!=t&&t.isChildren)&&(f="");var h=a.initUrl(t);switch(t.status){case"deploying":m=!1,f="查看进度",h+="&query_str="+t.deploy_uuid+"&cluster_id="+p;break;case"deployed":case"deploy fail":case"undeploy fail":if(null!=t&&t.smooth_upgrade_product||null!=t&&t.isChildren)break;f="重新部署",m=!0,h+="&redeploy=".concat(a.props.clusterId),Ae.Z.setNaviKey("menu_deploy_center","sub_menu_cluster_list");break;case"undeploying":f="查看进度",m=!1}return I.createElement("span",null,t.can_upgrade&&I.createElement(I.Fragment,null,I.createElement("a",{onClick:W()(r=a.handleProductUpgrade).call(r,(0,i.Z)(a),t)},"升级"),I.createElement(te.Z,{type:"vertical"})),(null==t?void 0:t.isShowNull)&&I.createElement("span",{style:{color:"#3F87FF"}},"--"),(null==t?void 0:t.can_rollback)&&I.createElement(I.Fragment,null,I.createElement("a",{onClick:W()(u=a.handleProductRollback).call(u,(0,i.Z)(a),t)},"回滚"),I.createElement(te.Z,{type:"vertical"})),"undeploying"!==t.status?I.createElement("a",{onClick:function(){return a.handleLink(h,f)}},f):null,"undeploying"===t.status&&I.createElement(I.Fragment,null,I.createElement("a",{onClick:function(){s&&c?a.setState({progressModalType:"unDeploy",unDeployRecord:t,isShowUnDeploy:!0},(function(){a.props.unDeployActions.getUndeploy({deploy_uuid:t.deploy_uuid,autoRefresh:!0})})):a.errorMsg()}},f),I.createElement(te.Z,{type:"vertical"}),I.createElement("a",{onClick:W()(d=a.stopUndeploy).call(d,(0,i.Z)(a),t,o)},"停止卸载")),m&&l&&(!t.smooth_upgrade_product||!(null!=t&&t.isChildren))&&I.createElement(ne.Z,{placement:"left",title:I.createElement("div",{style:{width:240}},"卸载后该安装包下的服务将全部删除，请确认组件及所在集群信息，谨慎操作！",I.createElement("p",null,"集群：",null==n?void 0:n.name),I.createElement("p",null,"组件：",null==t?void 0:t.product_name)),okText:"卸载",cancelText:"取消",onCancel:function(){a.closeUnDeployModal()},onConfirm:function(){a.setState({progressModalType:"unDeploy",unDeployRecord:t,isShowUnDeploy:!0},(function(){a.props.unDeployActions.startUnDeployService({product_name:t.product_name,product_version:t.product_version,clusterId:a.props.clusterId,namespace:t.product_type?t.namespace:void 0},a.getDataList)}))}},I.createElement("span",null,I.createElement(te.Z,{type:"vertical"}),I.createElement("a",null,"卸载"))),m&&!l&&(!(null!=t&&t.smooth_upgrade_product)||!(null!=t&&t.isChildren))&&I.createElement("span",{onClick:function(){a.errorMsg()}},I.createElement(te.Z,{type:"vertical"}),I.createElement("a",null,"卸载")))}}];return a.props.shouldNameSpaceShow||$()(u).call(u,2,1),u})),(0,m.Z)((0,i.Z)(a),"onExpand",(function(e,t){var n=a.state.expandedKeys;if(e){var r;a.setState({expandedKeys:h()(r=[]).call(r,(0,A.Z)(n),[t.key])})}else{var o=null==n?void 0:Q()(n).call(n,(function(e){return e!==t.key}));a.setState({expandedKeys:o})}})),(0,m.Z)((0,i.Z)(a),"render",(function(){var e=a.state,t=e.componentData,n=e.loading,r=e.searchParam,o=e.currentPage,l=e.progressModalType,s=e.isShowUnDeploy,c=e.unDeployRecord,i=e.selectedRecord,u=e.upgradeModalVisible,d=e.modalType,p=e.versionLists,m=e.record,f=e.expandedKeys,h=a.props.deployProp,g={size:"small",pageSize:r.limit,total:t.count,current:o,showTotal:function(e){return I.createElement("span",null,"共",I.createElement("span",{style:{color:"#3F87FF"}},e),"条数据，每页显示",r.limit,"条")}};return I.createElement(I.Fragment,null,I.createElement(ae.Z,{onExpand:a.onExpand,expandedRowKeys:f,className:"dt-table-fixed-base",style:{height:"calc(100vh - 260px)"},columns:a.getTableColumns(),dataSource:t.list,scroll:{y:!0},pagination:g,loading:n,onChange:a.handleTableChange}),s&&I.createElement(he,{visible:s,progressType:l,deployReacord:c,getDataList:a.getDataList,onClose:a.closeUnDeployModal}),I.createElement(ge.Z,{componentData:i,onClose:function(){return a.setState({selectedRecord:void 0})}}),u&&I.createElement(Ve,{isFirstSmooth:h.isFirstSmooth,visible:u,type:d,options:p,clusterId:a.props.clusterId,record:m,onOk:a.handleOk,changeUpgradeType:a.changeUpgradeType,onCancel:a.handleUpgradeModalCancel}))})),a}return(0,c.Z)(n,[{key:"componentDidMount",value:function(){this.getDataList()}}],[{key:"getDerivedStateFromProps",value:function(e,t){var n=t.searchParam,a=n.parentProductName,r=n.clusterId,o=n.productVersion,l=n.productName;return e.clusterId!==r||e.parentProductName!==a||e.productVersion!==o||e.productName!==l?{currentPage:1,searchParam:k()({},t.searchParam,{clusterId:e.clusterId,parentProductName:e.parentProductName,productVersion:e.productVersion,productName:e.productName,start:0})}:null}}]),n}(I.Component))||Oe;var He=n(28568);function Ge(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,p.Z)(e);if(t){var r=(0,p.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,d.Z)(this,n)}}const qe=function(e){(0,u.Z)(n,e);var t=Ge(n);function n(){var e,a;(0,s.Z)(this,n);for(var r=arguments.length,o=new Array(r),l=0;l<r;l++)o[l]=arguments[l];return a=t.call.apply(t,h()(e=[this]).call(e,o)),(0,m.Z)((0,i.Z)(a),"initColumns",(function(){return[{title:"执行时间",dataIndex:"update_time"},{title:"服务名称",dataIndex:"service_name"},{title:"服务版本号",dataIndex:"service_version"},{title:"主机IP",dataIndex:"ip"},{title:"组件版本号",dataIndex:"product_version"},{title:"启动及初始化",dataIndex:"progressbar",render:function(e,t){var n=100===t.progress&&""===t.status_message;return I.createElement(ue.Z,{percent:t.progress,status:n?"success":"exception"})}},{title:"启动状态",dataIndex:"status",filters:[{text:"installing",value:"installing"},{text:"installed",value:"installed"},{text:"install fail",value:"install fail"},{text:"uninstalling",value:"uninstalling"},{text:"uninstalled",value:"uninstalled"},{text:"uninstall fail",value:"uninstall fail"},{text:"running",value:"running"},{text:"run fail",value:"run fail"},{text:"health-checked",value:"health-checked"},{text:"health-check fail",value:"health-check fail"},{text:"health-check cancelled",value:"health-check cancelled"},{text:"stopped",value:"stopped"},{text:"stopping",value:"stopping"},{text:"stop fail",value:"stop fail"}],render:function(e,t){var n={};return n=100===t.progress&&""===t.status_message?{color:"#12BC6A"}:{color:"#FF5F5C"},I.createElement("div",null,I.createElement("span",{style:n},e),I.createElement(ee.Z,{title:t.status_message},t.status_message?I.createElement(U.Z,{style:{marginLeft:3},type:"info-circle"}):null))}}]})),a}return(0,c.Z)(n,[{key:"render",value:function(){var e=this,t=this.initColumns(),n=this.props,a=n.dataList,r=n.showModal,o=n.shotPagination,l={size:"small",current:o.current,total:o.count,pageSize:o.limit};return I.createElement(X.Z,{footer:null,width:950,destroyOnClose:!0,visible:r,title:"部署快照",onOk:function(){return e.props.closeModal()},onCancel:function(){return e.props.closeModal()}},I.createElement(ae.Z,{rowKey:"id",size:"middle",className:"dt-pagination-lower",columns:t,dataSource:a,onChange:this.props.handleTableChange,pagination:l}))}}]),n}(I.Component);var We;function Ye(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,p.Z)(e);if(t){var r=(0,p.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,d.Z)(this,n)}}const $e=(0,F.$j)((function(e){return{authorityList:e.UserCenterStore.authorityList}}),void 0)(We=function(e){(0,u.Z)(n,e);var t=Ye(n);function n(){var e,a;(0,s.Z)(this,n);for(var r=arguments.length,o=new Array(r),l=0;l<r;l++)o[l]=arguments[l];return a=t.call.apply(t,h()(e=[this]).call(e,o)),(0,m.Z)((0,i.Z)(a),"state",{shotRecord:"",shotData:[],shotPagination:{limit:10,start:0,count:0,current:1,status:""},deployData:{list:[],count:0},loading:!1,searchParam:{clusterId:void 0,productName:void 0,parentProductName:void 0,productVersion:void 0,deploy_status:"","sort-by":"create_time","sort-dir":"desc",limit:10,start:0},selectedRecord:null,selectedConfigModalRecord:null,selectedService:null,modalStatus:"",showModal:!1,visibleDeployLog:!1,modalContent:null,serviceGroup:null,currentPage:1}),(0,m.Z)((0,i.Z)(a),"getProductHistory",(function(e){var t=(0,i.Z)(a),n=k()({},a.state.searchParam);n.parentProductName&&(a.setState({loading:!0}),n.start=n.start*n.limit,n.productName&&(n.productName=n.productName.join(",")),n.deploy_status&&(n.deploy_status=n.deploy_status.join(",")),O.t6.getProductUpdateRecords(n).then((function(e){0===(e=e.data).code&&t.setState({deployData:e.data}),a.setState({loading:!1})})))})),(0,m.Z)((0,i.Z)(a),"loadServiceGroup",(function(e){O.BZ.getServiceGroup(e).then((function(e){0===e.data.code&&a.setState({serviceGroup:(0,V.get)(e,"data.data.groups",{})})}))})),(0,m.Z)((0,i.Z)(a),"getDeployLog",(function(e){O.aJ.searchDeployLog(e).then((function(e){0===e.data.code&&a.setState({modalContent:(0,V.get)(e,"data.data.result","")})}))})),(0,m.Z)((0,i.Z)(a),"handleShotTableChange",(function(e,t,n){var r=a.state.shotRecord,o=k()(a.state.shotPagination,{start:(e.current-1)*a.state.shotPagination.limit,current:e.current,status:t.status?t.status.join(",").toString():""});a.setState({shotPagination:o},(function(){a.handleViewDeployShot(r)}))})),(0,m.Z)((0,i.Z)(a),"handleDeployHistoryTableChange",(function(e,t,n){var r,o=k()(a.state.searchParam);(t.status&&(o.deploy_status=t.status),o.start=e.current-1,t.product_type)&&(o.product_type=D()(r=t.product_type).call(r,(function(e){return+e})).join(","));if(n){var l=n.field,s=n.order;s&&(o["sort-dir"]="descend"===s?"desc":"asc"),l&&(o["sort-by"]=l)}a.setState({searchParam:o,currentPage:e.current},a.getProductHistory)})),(0,m.Z)((0,i.Z)(a),"handleViewDeployShot",(function(e){a.setState({modalStatus:e.status});var t=a.state.shotPagination;O.t6.getDeployShot({uuid:e.deploy_uuid,limit:t.limit,start:t.start,status:t.status}).then((function(e){0===(e=e.data).code?a.setState({showModal:!0,shotData:e.data.list,shotPagination:k()(a.state.shotPagination,{count:e.data.count})}):R.Z.error(e.msg)}))})),(0,m.Z)((0,i.Z)(a),"onShowConfigInfo",(function(e){a.setState({selectedConfigModalRecord:e})})),(0,m.Z)((0,i.Z)(a),"onShowDeployLog",(function(e){e&&e.product_name&&a.setState({selectedRecord:e,visibleDeployLog:!0},(function(){a.loadServiceGroup({product_name:e.product_name}),a.getDeployLog({serviceName:"",deployId:e.deploy_uuid,productName:e.product_name,productVersion:e.product_version})}))})),(0,m.Z)((0,i.Z)(a),"onSelectedLogService",(function(e){var t=a.state.selectedRecord;a.setState({selectedService:e}),a.getDeployLog({deployId:t.deploy_uuid,serviceName:e||"",productName:t.product_name,productVersion:t.product_version})})),(0,m.Z)((0,i.Z)(a),"onCloseModal",(function(){a.setState({visibleDeployLog:!1,selectedRecord:null,selectedService:null,modalContent:null})})),(0,m.Z)((0,i.Z)(a),"initTableColumns",(function(){var e,t=a.props.authorityList.installed_app_view,n=(0,V.cloneDeep)(le.MD),r=D()(n).call(n,(function(e){return"undeployed"===e.value&&(e.text="卸载成功"),e})),o=[{title:"组件名称",dataIndex:"product_name_display",key:"product_name_display",render:function(e,t){return e||t.product_name}},{title:"组件版本号",dataIndex:"product_version",key:"product_version",sorter:!0,render:function(e,t){return I.createElement("span",null,e,1===t.is_current_version&&I.createElement(U.Z,{style:{marginLeft:3},type:"star"}))}},{title:"命名空间",dataIndex:"namespace",key:"namespace",render:function(e){return e||"--"}},{title:"安装包类型",dataIndex:"product_type",key:"product_type",filters:[{text:"传统包",value:"0"},{text:"Kubernetes包",value:"1"}],render:function(e){return I.createElement("span",null,e?"Kubernetes包":"传统包")}},{title:"部署人",dataIndex:"username",key:"username"},{title:"部署时间",dataIndex:"create_time",key:"create_time",sorter:!0},{title:"状态",dataIndex:"status",key:"status",filters:h()(e=[]).call(e,(0,A.Z)(r),[{text:"卸载成功",value:"undeployed"}]),render:function(e){var t="";switch(e){case"undeployed":t=I.createElement("span",{className:"deploy-status-green"},I.createElement(U.Z,{style:{fontSize:12,color:"#12BC6A",marginRight:6},type:"check-circle",theme:"filled"}),"卸载成功");break;case"deploying":t=I.createElement("span",{className:"deploy-status-orange"},I.createElement(U.Z,{style:{fontSize:12,color:"#FFB310",marginRight:6},type:"exclamation-circle",theme:"filled"}),"部署中");break;case"deployed":t=I.createElement("span",{className:"deploy-status-green"},I.createElement(U.Z,{style:{fontSize:12,color:"#12BC6A",marginRight:6},type:"check-circle",theme:"filled"}),"部署成功");break;case"deploy fail":t=I.createElement("span",{className:"deploy-status-red"},I.createElement(U.Z,{style:{fontSize:12,color:"#FF5F5C",marginRight:6},type:"close-circle",theme:"filled"}),"部署失败");break;case"undeploying":t=I.createElement("span",{className:"deploy-status-orange"},I.createElement(U.Z,{style:{fontSize:12,color:"#FFB310",marginRight:6},type:"exclamation-circle",theme:"filled"}),"卸载中");break;case"undeploy fail":t=I.createElement("span",{className:"deploy-status-red"},I.createElement(U.Z,{style:{fontSize:12,color:"#FF5F5C",marginRight:6},type:"close-circle",theme:"filled"}),"卸载失败")}return I.createElement("span",null,t)}},{title:"部署快照",dataIndex:"action",render:function(e,n){return I.createElement(I.Fragment,null,t?I.createElement(U.Z,{type:"camera",style:{cursor:"pointer",color:"#3f87ff"},title:"查看部署快照",onClick:function(){a.setState({shotRecord:n},(function(){a.handleViewDeployShot(n)}))}}):"--")}},{title:"查看",dataIndex:"visit",render:function(e,n){var r,o;return I.createElement(I.Fragment,null,t?I.createElement(I.Fragment,null,I.createElement("a",{onClick:W()(r=a.onShowConfigInfo).call(r,(0,i.Z)(a),n)},"配置"),I.createElement(te.Z,{type:"vertical"}),I.createElement("a",{onClick:W()(o=a.onShowDeployLog).call(o,(0,i.Z)(a),n)},"部署日志")):"--")}}];return a.props.shouldNameSpaceShow||$()(o).call(o,2,1),o})),(0,m.Z)((0,i.Z)(a),"render",(function(){var e,t=a.state,n=t.deployData,r=t.loading,o=t.visibleDeployLog,l={size:"small",pageSize:10,current:t.currentPage,total:n.count,showTotal:function(e){return I.createElement("span",null,"共",I.createElement("span",{style:{color:"#3F87FF"}},e),"条数据，每页显示",a.state.shotPagination.limit,"条")}};return I.createElement(I.Fragment,null,I.createElement(ae.Z,{rowKey:"id",className:"dt-table-fixed-base",style:{height:"calc(100vh - 260px)"},pagination:l,columns:a.initTableColumns(),loading:r,onChange:a.handleDeployHistoryTableChange,dataSource:n.list,scroll:{y:!0}}),I.createElement(qe,{status:a.state.modalStatus,dataList:a.state.shotData,showModal:a.state.showModal,closeModal:function(){a.setState({showModal:!1,shotPagination:k()(a.state.shotPagination,{start:0,current:1,status:""})})},shotPagination:a.state.shotPagination,handleTableChange:W()(e=a.handleShotTableChange).call(e,(0,i.Z)(a))}),I.createElement(He.Z,{key:"deployModal",title:"部署日志",visible:o,content:a.state.modalContent,serviceData:a.state.serviceGroup,onCancel:a.onCloseModal,onSelectedService:a.onSelectedLogService}),I.createElement(ge.Z,{componentData:a.state.selectedConfigModalRecord,onClose:function(){return a.setState({selectedConfigModalRecord:void 0})}}))})),a}return(0,c.Z)(n,[{key:"componentDidMount",value:function(){this.getProductHistory()}}],[{key:"getDerivedStateFromProps",value:function(e,t){var n=t.searchParam,a=n.parentProductName,r=n.clusterId,o=n.productVersion,l=n.productName;return e.clusterId!==r||e.parentProductName!==a||e.productVersion!==o||e.productName!==l?{currentPage:1,searchParam:k()({},t.searchParam,{clusterId:e.clusterId,parentProductName:e.parentProductName,productVersion:e.productVersion,productName:e.productName,start:0})}:null}}]),n}(I.Component))||We;var Je=n(3649),Qe=n.n(Je);function Xe(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,p.Z)(e);if(t){var r=(0,p.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,d.Z)(this,n)}}const et=function(e){(0,u.Z)(n,e);var t=Xe(n);function n(){var e,a;(0,s.Z)(this,n);for(var r=arguments.length,o=new Array(r),l=0;l<r;l++)o[l]=arguments[l];return a=t.call.apply(t,h()(e=[this]).call(e,o)),(0,m.Z)((0,i.Z)(a),"initColumns",(function(){return[{title:"执行时间",dataIndex:"update_time"},{title:"服务名称",dataIndex:"service_name"},{title:"服务版本号",dataIndex:"service_version"},{title:"主机IP",dataIndex:"ip"},{title:"组件版本号",dataIndex:"product_version"},{title:"更新进度",dataIndex:"progressbar",render:function(e,t){var n=(100===t.progress||50===t.progress)&&""===t.status_message;return I.createElement(ue.Z,{percent:t.progress,status:n?"success":"exception"})}},{title:"更新状态",dataIndex:"status",filters:[{text:"success",value:"success"},{text:"fail",value:"fail"},{text:"update",value:"update"}],render:function(e,t){var n={};return n=(100===t.progress||50===t.progress)&&""===t.status_message?{color:"#12BC6A"}:{color:"#FF5F5C"},I.createElement("div",null,I.createElement("span",{style:n},e),I.createElement(ee.Z,{title:t.status_message},t.status_message?I.createElement(U.Z,{style:{marginLeft:3},type:"info-circle"}):null))}}]})),a}return(0,c.Z)(n,[{key:"render",value:function(){var e=this,t=this.initColumns(),n=this.props,a=n.dataList,r=n.showModal,o=n.shotPagination,l=n.title,s={size:"small",current:o.current,total:o.count,pageSize:o.limit};return I.createElement(X.Z,{footer:null,width:950,destroyOnClose:!0,visible:r,title:l,onOk:function(){return e.props.closeModal()},onCancel:function(){return e.props.closeModal()}},I.createElement(ae.Z,{rowKey:"id",size:"middle",className:"dt-pagination-lower",columns:t,dataSource:a,onChange:this.props.handleTableChange,pagination:s}))}}]),n}(I.Component);var tt;function nt(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,p.Z)(e);if(t){var r=(0,p.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,d.Z)(this,n)}}const at=(0,F.$j)((function(e){return{authorityList:e.UserCenterStore.authorityList}}),void 0)(tt=function(e){(0,u.Z)(n,e);var t=nt(n);function n(){var e,a;(0,s.Z)(this,n);for(var r=arguments.length,o=new Array(r),l=0;l<r;l++)o[l]=arguments[l];return a=t.call.apply(t,h()(e=[this]).call(e,o)),(0,m.Z)((0,i.Z)(a),"state",{shotRecord:"",shotData:[],shotPagination:{limit:10,start:0,count:0,current:1,status:""},deployData:{list:[],count:0},loading:!1,searchParam:{clusterId:void 0,productName:void 0,parentProductName:void 0,productVersion:void 0,update_status:"","sort-by":"create_time","sort-dir":"desc",limit:10,start:0},selectedRecord:null,selectedConfigModalRecord:null,selectedService:null,modalStatus:"",showModal:!1,visibleDeployLog:!1,modalContent:null,serviceGroup:null,currentPage:1,title:""}),(0,m.Z)((0,i.Z)(a),"getProductHistory",(function(e){var t=(0,i.Z)(a),n=k()({},a.state.searchParam);n.parentProductName&&(a.setState({loading:!0}),n.start=n.start*n.limit,n.productName&&(n.productName=n.productName.join(",")),n.update_status&&(n.update_status=n.update_status.join(",")),O.t6.getProductUpdate(n).then((function(e){0===(e=e.data).code&&t.setState({deployData:e.data}),a.setState({loading:!1})})))})),(0,m.Z)((0,i.Z)(a),"loadServiceGroup",(function(e){O.BZ.getServiceGroup(e).then((function(e){0===e.data.code&&a.setState({serviceGroup:(0,V.get)(e,"data.data.groups",{})})}))})),(0,m.Z)((0,i.Z)(a),"getDeployLog",(function(e){O.aJ.searchDeployLog(e).then((function(e){0===e.data.code&&a.setState({modalContent:(0,V.get)(e,"data.data.result","")})}))})),(0,m.Z)((0,i.Z)(a),"handleShotTableChange",(function(e,t,n){var r=a.state,o=r.shotRecord,l=r.title,s=k()(a.state.shotPagination,{start:(e.current-1)*a.state.shotPagination.limit,current:e.current,status:t.status?t.status.join(",").toString():""});a.setState({shotPagination:s},(function(){a.handleViewDeployShot(o,l)}))})),(0,m.Z)((0,i.Z)(a),"handleDeployHistoryTableChange",(function(e,t,n){var r,o=k()(a.state.searchParam);(t.status&&(o.update_status=t.status),o.start=e.current-1,t.product_type)&&(o.product_type=D()(r=t.product_type).call(r,(function(e){return+e})).join(","));if(n){var l=n.field,s=n.order;s&&(o["sort-dir"]="descend"===s?"desc":"asc"),l&&(o["sort-by"]=l)}a.setState({searchParam:o,currentPage:e.current},a.getProductHistory)})),(0,m.Z)((0,i.Z)(a),"handleViewDeployShot",(function(e,t){a.setState({modalStatus:e.status});var n=a.state.shotPagination;O.t6.getPatchUpdateShot({uuid:e.update_uuid,limit:n.limit,start:n.start,status:n.status}).then((function(e){0===(e=e.data).code?a.setState({showModal:!0,title:t,shotData:e.data.list,shotPagination:k()(a.state.shotPagination,{count:e.data.count})}):R.Z.error(e.msg)}))})),(0,m.Z)((0,i.Z)(a),"onShowConfigInfo",(function(e){a.setState({selectedConfigModalRecord:e})})),(0,m.Z)((0,i.Z)(a),"onShowDeployLog",(function(e){e&&e.product_name&&a.setState({selectedRecord:e,visibleDeployLog:!0},(function(){a.loadServiceGroup({product_name:e.product_name}),a.getDeployLog({serviceName:"",deployId:e.deploy_uuid,productName:e.product_name,productVersion:e.product_version})}))})),(0,m.Z)((0,i.Z)(a),"onSelectedLogService",(function(e){var t=a.state.selectedRecord;a.setState({selectedService:e}),a.getDeployLog({deployId:t.deploy_uuid,serviceName:e||"",productName:t.product_name,productVersion:t.product_version})})),(0,m.Z)((0,i.Z)(a),"onCloseModal",(function(){a.setState({visibleDeployLog:!1,selectedRecord:null,selectedService:null,modalContent:null})})),(0,m.Z)((0,i.Z)(a),"initTableColumns",(function(){var e=a.props.authorityList.installed_app_view,t=(0,V.cloneDeep)(le.XN),n=[{title:"补丁包名称",dataIndex:"package_name",key:"package_name",render:function(e,t){return e||t.package_name}},{title:"组件名称",dataIndex:"product_name_display",key:"product_name_display",render:function(e,t){return e||t.product_name}},{title:"组件版本号",dataIndex:"product_version",key:"product_version",sorter:!0,render:function(e,t){return I.createElement("span",null,e,1===t.is_current_version&&I.createElement(U.Z,{style:{marginLeft:3},type:"star"}))}},{title:"命名空间",dataIndex:"namespace",key:"namespace",render:function(e){return e||"--"}},{title:"目标目录",dataIndex:"update_dir",key:"update_dir",render:function(e,t){return I.createElement(ee.Z,{title:e},e.length>12?Qe()(e).call(e,0,10)+"...":e)}},{title:"备份目录",dataIndex:"backup_dir",key:"backup_dir",render:function(e,t){return I.createElement(ee.Z,{title:e},e.length>12?Qe()(e).call(e,0,10)+"...":e)}},{title:"安装包类型",dataIndex:"product_type",key:"product_type",filters:[{text:"传统包",value:"0"},{text:"Kubernetes包",value:"1"}],render:function(e){return I.createElement("span",null,e?"Kubernetes包":"传统包")}},{title:"更新状态",dataIndex:"status",key:"status",filters:(0,A.Z)(t),render:function(e){var t="";switch(e){case"success":t=I.createElement("span",{className:"deploy-status-green"},I.createElement(U.Z,{style:{fontSize:12,color:"#12BC6A",marginRight:6},type:"check-circle",theme:"filled"}),"更新成功");break;case"update":t=I.createElement("span",{className:"deploy-status-orange"},I.createElement(U.Z,{style:{fontSize:12,color:"#FFB310",marginRight:6},type:"exclamation-circle",theme:"filled"}),"更新中");break;case"fail":t=I.createElement("span",{className:"deploy-status-green"},I.createElement(U.Z,{style:{fontSize:12,color:"#FF5F5C",marginRight:6},type:"close-circle",theme:"filled"}),"更新失败")}return I.createElement("span",null,t)}},{title:"更新时间",dataIndex:"create_time",key:"create_time",sorter:!0},{title:"更新人",dataIndex:"username",key:"username"},{title:"查看",dataIndex:"action",width:50,render:function(t,n){return I.createElement(I.Fragment,null,e?I.createElement(U.Z,{type:"camera",style:{cursor:"pointer",color:"#3f87ff"},title:"更新快照片",onClick:function(){a.setState({shotRecord:n},(function(){a.handleViewDeployShot(n,"更新快照")}))}}):"--")}},{title:"操作",width:80,dataIndex:"visit",render:function(e,t){return I.createElement(I.Fragment,null,"update"==t.status?I.createElement(I.Fragment,null,I.createElement("a",{onClick:function(){return a.handleViewDeployShot(t,"查看进度")}},"查看进度")):(t.status,I.createElement(I.Fragment,null,I.createElement("a",null,"--"))))}}];return a.props.shouldNameSpaceShow||$()(n).call(n,3,1),n})),(0,m.Z)((0,i.Z)(a),"reUpdate",(function(e){var t=a.props.authorityList;if(Ae.Z.noAuthorityToDO(t,"patches_update"))return!1;a.props.changeDefaultValue(e)})),(0,m.Z)((0,i.Z)(a),"render",(function(){var e,t=a.state,n=t.deployData,r=t.loading,o={size:"small",pageSize:10,current:t.currentPage,total:n.count,showTotal:function(e){return I.createElement("span",null,"共",I.createElement("span",{style:{color:"#3F87FF"}},e),"条数据，每页显示",a.state.shotPagination.limit,"条")}};return I.createElement(I.Fragment,null,I.createElement(ae.Z,{rowKey:"id",className:"dt-table-fixed-base",style:{height:"calc(100vh - 260px)"},pagination:o,columns:a.initTableColumns(),loading:r,onChange:a.handleDeployHistoryTableChange,dataSource:n.list,scroll:{y:!0}}),I.createElement(et,{status:a.state.modalStatus,dataList:a.state.shotData,showModal:a.state.showModal,closeModal:function(){a.setState({showModal:!1,shotPagination:k()(a.state.shotPagination,{start:0,current:1,status:""})})},shotPagination:a.state.shotPagination,handleTableChange:W()(e=a.handleShotTableChange).call(e,(0,i.Z)(a)),title:a.state.title}))})),a}return(0,c.Z)(n,[{key:"componentDidMount",value:function(){this.getProductHistory()}}],[{key:"getDerivedStateFromProps",value:function(e,t){var n=t.searchParam,a=n.parentProductName,r=n.clusterId,o=n.productVersion,l=n.productName;return e.clusterId!==r||e.parentProductName!==a||e.productVersion!==o||e.productName!==l?{currentPage:1,searchParam:k()({},t.searchParam,{clusterId:e.clusterId,parentProductName:e.parentProductName,productVersion:e.productVersion,productName:e.productName,start:0})}:null}}]),n}(I.Component))||tt;var rt=Le.Z.Item,ot=T.Z.Option;const lt=Le.Z.create()((function(e){var t=e.visible,n=e.defaultValue,a=e.data,r=e.onCancel,o=e.form,s=o.getFieldDecorator,c=o.setFieldsValue,i=o.validateFields,u=I.useState(null==n?void 0:n.clusterId),d=(0,Ne.Z)(u,2),p=d[0],m=d[1],f=I.useState([]),g=(0,Ne.Z)(f,2),v=g[0],y=g[1];return I.useEffect((function(){var e,t=(null===(e=(C()(a).call(a,(function(e){return e.clusterId===p}))||{}).subdomain)||void 0===e?void 0:e.products)||[],r=(null==n?void 0:n.parentProductName)||"DTinsight",o=C()(t).call(t,(function(e){return e===r}))||t[0];y(t),c({parentProductName:null==o?void 0:o.productName})}),[p]),I.createElement(X.Z,{title:"下载产品部署内容",visible:t,footer:[I.createElement(B.Z,{key:"cancel",onClick:r},"取消"),I.createElement(B.Z,{key:"download",type:"primary",onClick:function(){i((function(e,t){if(!e){var n,a=t.clusterId,o=t.parentProductName,l=document.createElement("a");l.style.display="none",l.href=h()(n="/api/v2/cluster/productsInfo?clusterId=".concat(a,"&parentProductName=")).call(n,o),l.download=o+"_"+a,document.body.appendChild(l),l.click(),document.body.removeChild(l),r()}}))}},"下载")],onCancel:r},I.createElement(Le.Z,null,I.createElement(rt,(0,l.Z)({},Fe.Y,{label:"集群"}),s("clusterId",{initialValue:null==n?void 0:n.clusterId,rules:[{required:!0,message:"请选择集群"}]})(I.createElement(T.Z,{placeholder:"请选择集群",onChange:function(e){m(e)}},P()(a)&&D()(a).call(a,(function(e){return I.createElement(ot,{key:e.clusterId,value:e.clusterId},e.clusterName)}))))),I.createElement(rt,(0,l.Z)({},Fe.Y,{label:"产品"}),s("parentProductName",{rules:[{required:!0,message:"请选择产品"}]})(I.createElement(T.Z,{placeholder:"请选择产品"},P()(v)&&D()(v).call(v,(function(e,t){return I.createElement(ot,{key:e+t,value:e},e)})))))))}));var st=n(81643),ct=n.n(st),it=n(85733),ut=n(87558);function dt(e,t){var n=E()(e);if(ye()){var a=ye()(e);t&&(a=Q()(a).call(a,(function(t){return _e()(e,t).enumerable}))),n.push.apply(n,a)}return n}function pt(e){for(var t=1;t<arguments.length;t++){var n,a,r=null!=arguments[t]?arguments[t]:{};t%2?Z()(n=dt(Object(r),!0)).call(n,(function(t){(0,m.Z)(e,t,r[t])})):Se()?be()(e,Se()(r)):Z()(a=dt(Object(r))).call(a,(function(t){xe()(e,t,_e()(r,t))}))}return e}function mt(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,p.Z)(e);if(t){var r=(0,p.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,d.Z)(this,n)}}var ft=it.Z.TreeNode,ht=Le.Z.Item,gt=T.Z.Option,vt=n(19360),yt=function(e){(0,u.Z)(n,e);var t=mt(n);function n(){var e,a;(0,s.Z)(this,n);for(var r=arguments.length,o=new Array(r),l=0;l<r;l++)o[l]=arguments[l];return a=t.call.apply(t,h()(e=[this]).call(e,o)),(0,m.Z)((0,i.Z)(a),"state",{componentList:[],fileList:[],category:[],btnLoading:!1}),(0,m.Z)((0,i.Z)(a),"handleComponentChange",(function(e){var t=a.state.componentList;a.props.form.resetFields(["updateTarget"]),Z()(t).call(t,(function(t){t.id===e&&a.getCatalog(e)}))})),(0,m.Z)((0,i.Z)(a),"getCatalog",(function(e){var t=k()({},{product_id:e});O.t6.getPatchPath(t).then((function(e){if(0===(e=e.data).code){var t=e.data.path;a.setState({category:t})}else R.Z.error(e.msg)}))})),(0,m.Z)((0,i.Z)(a),"renderTreeNode",(function(e){return P()(e)&&D()(e).call(e,(function(e,t){return e.children&&e.children.length?I.createElement(ft,{value:e.path,disabled:!0,title:e.name,key:"".concat(Math.random()+t)},a.renderTreeNode(e.children)):I.createElement(ft,{value:e.path,title:e.name,key:"".concat(10*Math.random()+t)})}))})),(0,m.Z)((0,i.Z)(a),"normFile",(function(e){var t;if(P()(e))return e;var n=e&&Qe()(t=e.fileList).call(t,-1);return a.setState({fileList:n}),n})),(0,m.Z)((0,i.Z)(a),"handleUpdate",(function(){var e=a.props.form.validateFields,t=a.state.componentList,n=a.props,r=n.defaultValue,o=n.resetKey;e(function(){var e=(0,K.Z)(z().mark((function e(n,l){var s,c,i,u,d,p,m,f,h,g;return z().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!l.fileList[0].originFileObj){e.next=4;break}if(a.checkFile(l.fileList[0].originFileObj)){e.next=4;break}return e.abrupt("return");case 4:if(n){e.next=31;break}if(Z()(t).call(t,(function(e){var t,n;e.id===l.id&&(s=e.product.ParentProductName,c=e.product_name,i=e.product_version,u=e.product_type,d=(null===(t=l.fileList[0])||void 0===t||null===(n=t.originFileObj)||void 0===n?void 0:n.name)||r.package_name)})),a.checkFileType(d,l.updateTarget)){e.next=10;break}return R.Z.error("补丁包类型必须和更新目标后缀保持一致！"),e.abrupt("return");case 10:return a.setState({btnLoading:!0}),p={parentProductName:s,product_name:c,version:i,path:l.updateTarget,product_type:u,package_name:d},m=pt(pt({},p),{},{package:l.fileList[0].originFileObj}),e.next=15,O.t6.updatePatchPath(m);case 15:if(!(f=e.sent)||0!==f.data.code){e.next=27;break}return h=f.data.data,a.clearFields(),a.setState({btnLoading:!1}),o(),e.next=23,O.t6.updatePatchStatus(pt(pt({},p),{},{uuid:h}));case 23:(g=e.sent)&&0===g.data.code?o():R.Z.error(g.data.msg),e.next=29;break;case 27:a.setState({btnLoading:!1}),R.Z.error(f.data.msg);case 29:e.next=33;break;case 31:R.Z.error(n),a.setState({btnLoading:!1});case 33:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}())})),(0,m.Z)((0,i.Z)(a),"checkFileType",(function(e,t){return e.split(".").pop()==t.split(".").pop()})),(0,m.Z)((0,i.Z)(a),"beforeUpload",(function(e){return a.checkFile(e),!1})),(0,m.Z)((0,i.Z)(a),"checkFile",(function(e){return!!e&&(!(e.size>1073741824)||(R.Z.error("上传文件大小不能超过1G！"),!1))})),(0,m.Z)((0,i.Z)(a),"clearFields",(function(){var e=a.props,t=e.onCancel;e.form.resetFields(),a.setState({category:[],btnLoading:!1}),t()})),a}return(0,c.Z)(n,[{key:"componentDidUpdate",value:function(e,t){var n=this.props,a=n.defaultValue,r=n.form,o=n.data;o&&!(0,V.isEqual)(o,e.data)&&this.setState({componentList:(0,V.cloneDeep)(o)}),a&&!(0,V.isEqual)(a,e.defaultValue)&&(r.setFieldsValue({id:a.product_id}),this.getCatalog(a.product_id))}},{key:"render",value:function(){var e=this.props.form.getFieldDecorator,t=this.props,n=t.visible,a=t.defaultValue,r=this.state,o=r.componentList,s=r.category,c=r.btnLoading,i=null!=a&&a.package_name?[{uid:-1,name:a.package_name}]:[],u=!(null==a||!a.package_name);return I.createElement(X.Z,{title:"补丁包更新",className:"patch-modal",visible:n,footer:[I.createElement(B.Z,{key:"cancel",onClick:this.clearFields},"取消"),I.createElement(B.Z,{key:"download",type:"primary",onClick:this.handleUpdate,loading:c},"更新")],onCancel:this.clearFields},I.createElement("div",{className:"update-tips"},I.createElement(U.Z,{theme:"filled",type:"exclamation-circle",style:{color:"#3F87FF",marginLeft:20,marginRight:8}}),I.createElement("div",{className:"update-content"},"补丁包更新用于紧急更新，无需制作标准安装包，可对已部署组件进行快速更新")),I.createElement(Le.Z,null,I.createElement(ht,(0,l.Z)({},Fe.Y,{label:"选择组件"}),e("id",{validateTrigger:"onBlur",rules:[{required:!0,message:"请选择组件"}]})(I.createElement(T.Z,{placeholder:"请选择组件",onChange:this.handleComponentChange,disabled:u,showSearch:!0,filterOption:function(e,t){var n,a=t.props.children+"";return ct()(n=a.toLocaleLowerCase()).call(n,e.toLocaleLowerCase())>=0}},P()(o)&&D()(o).call(o,(function(e){return I.createElement(gt,{key:"".concat(e.id),value:e.id},e.product_name,"（","".concat(e.product_version),"）")})))))),I.createElement(Le.Z,null,I.createElement(ht,(0,l.Z)({},Fe.Y,{label:"更新目标"}),e("updateTarget",{rules:[{required:!0,message:"请选择路径"}]})(I.createElement(it.Z,{style:{width:"100%"},dropdownStyle:{maxHeight:400,overflow:"auto"},placeholder:"请先选择更新组件",treeNodeFilterProp:"title",showSearch:!0},this.renderTreeNode(s))))),I.createElement(Le.Z,null,I.createElement(ht,(0,l.Z)({},Fe.Y,{label:"上传补丁包"}),I.createElement("div",{className:"dropbox",style:{height:114}},e("fileList",{rules:[{required:!0,message:"请选择上传补丁包!"}],valuePropName:"fileList",getValueFromEvent:this.normFile,initialValue:i})(I.createElement(ut.Z.Dragger,{beforeUpload:this.beforeUpload},I.createElement("div",{className:"update-icon"},I.createElement("img",{src:vt,height:"36px",width:"36px"})),I.createElement("div",null,"点击或将文件拖拽到此处上传")))))))}}]),n}(I.Component);const Zt=Le.Z.create()(yt);var _t,Et=n(36808);function St(e){var t=function(){if("undefined"==typeof Reflect||!o())return!1;if(o().sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(o()(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,a=(0,p.Z)(e);if(t){var r=(0,p.Z)(this).constructor;n=o()(a,arguments,r)}else n=a.apply(this,arguments);return(0,d.Z)(this,n)}}var Ct=T.Z.Option,bt=M.Z.Search;const kt=(0,F.$j)((function(e){return{authorityList:e.UserCenterStore.authorityList,HeaderStore:e.HeaderStore}}))(_t=function(e){(0,u.Z)(n,e);var t=St(n);function n(){var e,a;(0,s.Z)(this,n);for(var r=arguments.length,o=new Array(r),l=0;l<r;l++)o[l]=arguments[l];return a=t.call.apply(t,h()(e=[this]).call(e,o)),(0,m.Z)((0,i.Z)(a),"state",{clusterList:[],productList:[],componentList:[],loading:!1,searchParam:{productName:void 0,clusterId:void 0,parentProductName:void 0,productVersion:void 0},downModalVisible:!1,updateModalVisible:!1,defaultValue:void 0,clusterType:"",deployType:"",uploadPack:v()(),bodyWidth:document.body.clientWidth}),(0,m.Z)((0,i.Z)(a),"transferList",(function(e,t){var n,a=[],r=e.subdomain||{};0===e.mode?a=r.products||[]:Z()(n=E()(r)).call(n,(function(e){var t;Z()(t=r[e]).call(t,(function(e){return a.push(e)}))}));return{productList:(0,V.uniq)(a),productName:function(e){var n=!1,a=!1;return Z()(e).call(e,(function(e){e===t&&(n=!0),"DTinsight"===e&&(a=!0)})),n?t:a?"DTinsight":e[0]}(a)}})),(0,m.Z)((0,i.Z)(a),"getParentClustersList",(function(e,t){O.t6.getClusterProductList().then((function(n){if(0===(n=n.data).code)if(n.data&&n.data.length>0){var r,o=e&&C()(r=n.data).call(r,(function(t){return t.clusterId===e}))||n.data[0]||{},l=a.transferList(o,t),s=l.productList,c=l.productName;a.setState({clusterType:o.clusterType,clusterList:n.data,productList:s,searchParam:{clusterId:e||o.clusterId,parentProductName:c,productName:void 0,productVersion:void 0}},(function(){a.getProductComponents({clusterId:e||o.clusterId,parentProductName:c})}))}else a.resetPages();else R.Z.error(n.msg)}))})),(0,m.Z)((0,i.Z)(a),"resetPages",(function(){a.setState({clusterList:[],productList:[],componentList:[],loading:!1,searchParam:{productName:void 0,clusterId:void 0,parentProductName:void 0,productVersion:void 0}})})),(0,m.Z)((0,i.Z)(a),"getProductComponents",(function(e){var t=k()({},a.state.searchParam,e);t.mode=a.currentCluster.mode,O.BZ.getProductName({clusterId:null==e?void 0:e.clusterId,mode:0,parentProductName:null==e?void 0:e.parentProductName}).then((function(e){if(0===(e=e.data).code){var n,r=e.data.list;n=(0,V.uniqBy)(r,"product_name"),a.setState({componentList:n,searchParam:t})}else R.Z.error(e.msg)}))})),(0,m.Z)((0,i.Z)(a),"handleClusterChange",(function(e){var t=a.state.clusterList,n=C()(t).call(t,(function(t){return t.clusterId===e}))||{},r=a.transferList(n),o=r.productList,l=r.productName;a.setState({searchParam:k()({},a.state.searchParam,{clusterId:e,parentProductName:l,productName:void 0,productVersion:void 0,componentList:[]}),productList:o,clusterType:n.clusterType},(function(){a.getProductComponents()}))})),(0,m.Z)((0,i.Z)(a),"handleSelectChange",(function(e){var t=k()({},a.state.searchParam,{parentProductName:e,productName:void 0,productVersion:void 0,componentList:[]});a.setState({searchParam:t},(function(){a.getProductComponents()}))})),(0,m.Z)((0,i.Z)(a),"handleComponentSearch",(function(e){var t=k()({},a.state.searchParam,{productVersion:e});a.setState({searchParam:t})})),(0,m.Z)((0,i.Z)(a),"onComponentChange",(function(e){a.setState({searchParam:k()({},a.state.searchParam,{productName:e,deploy_status:""})})})),(0,m.Z)((0,i.Z)(a),"handleDownModalShow",(function(){var e=a.props.authorityList;if(Ae.Z.noAuthorityToDO(e,"package_download"))return!1;a.setState({downModalVisible:!a.state.downModalVisible})})),(0,m.Z)((0,i.Z)(a),"closeModal",(function(){a.setState({defaultValue:void 0,updateModalVisible:!1})})),(0,m.Z)((0,i.Z)(a),"openModal",(function(){var e=a.props.authorityList;if(Ae.Z.noAuthorityToDO(e,"patches_update"))return!1;a.setState({updateModalVisible:!0})})),(0,m.Z)((0,i.Z)(a),"changeDefaultValue",(function(e){a.setState({defaultValue:e},(function(){return a.openModal()}))})),(0,m.Z)((0,i.Z)(a),"resetKey",(function(){a.setState({uploadPack:v()()})})),a}return(0,c.Z)(n,[{key:"componentDidMount",value:function(){var e=this.props,t=e.location,n=e.HeaderStore.cur_parent_cluster,a=JSON.parse(sessionStorage.getItem("service_object"))||{},r=(null==n?void 0:n.id)>0?null==n?void 0:n.id:+Et.get("em_current_cluster_id");this.getParentClustersList(r,a.parentProductName);var o=null==t?void 0:t.pathname.split("/"),l=null!=o&&o.length?o[(null==o?void 0:o.length)-1]:"";l&&this.setState({deployType:l})}},{key:"currentCluster",get:function(){var e,t=this.state,n=t.clusterList,a=t.searchParam.clusterId;return Z()(n).call(n,(function(t){t.clusterId===a&&(e=t)})),e||{}}},{key:"shouldNameSpaceShow",get:function(){return 1===this.currentCluster.mode}},{key:"render",value:function(){var e,t,n,a,r=this.props.HeaderStore.cur_parent_cluster,o=this.state,s=o.componentList,c=o.searchParam,i=o.productList,u=o.clusterList,d=o.downModalVisible,p=o.updateModalVisible,m=o.defaultValue,f=(o.clusterType,o.uploadPack),g=o.deployType,v=o.bodyWidth,y=h()(e=h()(t=h()(n=h()(a="".concat(c.clusterId,"-")).call(a,c.parentProductName,"-")).call(n,c.productName,"-")).call(t,c.productVersion,"-")).call(e,f);return I.createElement("div",{className:"content-container"},I.createElement("div",{className:"mb-12 clearfix"},I.createElement("div",{style:{marginBottom:"".concat(v<=1440?"10px":"0px"),display:"inline-block"}},I.createElement("span",{className:"mr-20"},"集群：",I.createElement(T.Z,{className:"dt-form-shadow-bg",style:{width:180},size:"default",placeholder:"选择集群",disabled:!0,value:N()(u).call(u,c.clusterId)?c.clusterId:r.name,onChange:this.handleClusterChange},P()(u)&&D()(u).call(u,(function(e,t){return I.createElement(Ct,{"data-testid":"cluster-option-".concat(e.clusterName),key:"".concat(t),value:e.clusterId},I.createElement(U.Z,{type:"appstore-o",style:{marginRight:"6px"}}),e.clusterName)})))),I.createElement("span",{className:"mr-20"},"产品：",I.createElement(T.Z,{className:"dt-form-shadow-bg",style:{width:180,fontSize:12},size:"default",placeholder:"选择产品",value:c.parentProductName,onChange:this.handleSelectChange},P()(i)&&D()(i).call(i,(function(e,t){return I.createElement(Ct,{key:"".concat(t),value:e},I.createElement(U.Z,{type:"appstore-o",style:{marginRight:"6px"}}),e)})))),I.createElement("span",{className:"mr-20"},"组件名称：",I.createElement(T.Z,{className:"dt-form-shadow-bg",mode:"multiple",size:"default",placeholder:"选择组件",value:this.state.searchParam.productName,style:{width:180},onChange:this.onComponentChange},P()(s)&&D()(s).call(s,(function(e){return I.createElement(Ct,{key:e.product_name},e.product_name)})))),I.createElement("span",{className:"mr-20"},I.createElement(bt,{className:"dt-form-shadow-bg",style:{width:264},placeholder:"按组件版本号搜索",onSearch:this.handleComponentSearch}))),"hosts"===(null==r?void 0:r.type)&&I.createElement(B.Z,{className:"fl-r",type:"primary",style:{marginLeft:"20px"},onClick:this.openModal},"上传补丁包"),I.createElement(B.Z,{className:"fl-r",type:"primary",icon:"download",onClick:this.handleDownModalShow},"下载产品部署内容")),"deployed"===g&&I.createElement(ze,(0,l.Z)({key:"component-list"+y},this.state.searchParam,this.props,{shouldNameSpaceShow:this.shouldNameSpaceShow,mode:this.currentCluster.mode,clusterList:u,getParentClustersList:this.getParentClustersList})),"history"===g&&I.createElement($e,(0,l.Z)({shouldNameSpaceShow:this.shouldNameSpaceShow,key:"history"+y},this.state.searchParam)),"patchHistory"===g&&!("kubernetes"===(null==r?void 0:r.type)&&0===(null==r?void 0:r.mode))&&I.createElement(at,(0,l.Z)({key:"patches-update-history"+y},this.state.searchParam,{changeDefaultValue:this.changeDefaultValue,shouldNameSpaceShow:this.shouldNameSpaceShow})),d&&I.createElement(lt,{visible:d,defaultValue:{clusterId:c.clusterId?Number(c.clusterId):void 0,parentProductName:c.parentProductName},data:u,onCancel:this.handleDownModalShow}),I.createElement(Zt,{visible:p,onCancel:this.closeModal,data:s,defaultValue:m,resetKey:this.resetKey}))}}]),n}(I.Component))||_t},64143:(e,t,n)=>{n.d(t,{Z:()=>y});var a=n(77766),r=n.n(a),o=n(78914),l=n.n(o),s=n(81643),c=n.n(s),i=n(2991),u=n.n(i),d=n(86902),p=n.n(d),m=n(31238),f=n.n(m),h=n(45360),g=n(36808),v=n(18274);const y={pageWidth:function(){return Math.max(document.documentElement.clientWidth,window.innerWidth||0)},pageHeight:function(){return Math.max(document.documentElement.clientHeight,window.innerHeight||0)},getParameterByName:function(e,t){t||(t=window.location.href),e=e.replace(/[[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null},getBase64:function(e,t){var n=new FileReader;n.addEventListener("load",(function(){return t(n.result)})),n.readAsDataURL(e)},percent:function(e,t){return e&&e!==1/0?(e>1&&(e=1),t=t||2,t=Math.pow(10,t),Math.round(e*t*100)/t+"%"):"0%"},getCssText:function(e){var t="";for(var n in e)t+=n+":"+e[n]+";";return t},formateDateTime:function(e){var t,n,a,o,l;if(!e)return"";var s=new Date(e),c=s.getFullYear(),i=s.getMonth()+1+"",u=s.getDate()+"",d=s.getHours()+"",p=s.getMinutes()+"",m=s.getSeconds()+"";return 1===i.toString().length&&(i="0".concat(i)),1===u.toString().length&&(u="0".concat(u)),1===d.toString().length&&(d="0".concat(d)),1===p.toString().length&&(p="0".concat(p)),1===m.toString().length&&(m="0".concat(m)),r()(t=r()(n=r()(a=r()(o=r()(l="".concat(c,"-")).call(l,i,"-")).call(o,u," ")).call(a,d,":")).call(n,p,":")).call(t,m)},formateDate:function(e){var t,n;if(!e)return"";var a=new Date(e),o=a.getFullYear(),l=a.getMonth()+1+"",s=a.getDate()+"";return 1===l.toString().length&&(l="0".concat(l)),1===s.toString().length&&(s="0".concat(s)),r()(t=r()(n="".concat(o,"-")).call(n,l,"-")).call(t,s)},trim:function(e){return"string"==typeof e?e.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""):e},messageFilter:function(e,t,n,a){1001===e.status.code&&(a||h.Z.success("成功"),t&&t())},getTableParam:function(e){var t={};return l()(e).call(e,(function(e,n){var a=e.split("-");t[a[1]]=a[2]})),t},setAlertControl:function(e){var t={},n=e.alert_control;return"1"===n?t.close=1:(t.close=0,e["alert_num_"+n]&&(t.times_after_close=e["alert_num_"+n]),e["recover_num_"+n]&&(t.close_after_long_time_reset_amount=e["recover_num_"+n],t.close_after_long_time_reset_unit=e["recover_unit_"+n])),t},getAlertControl:function(e){var t={alert_control:""};return 0===e.close&&(0!==e.times_after_close?(t.alert_control="2",t["alert_num_"+t.alert_control]=e.times_after_close):t.alert_control="3",""!==e.close_after_long_time_reset_amount&&("2"===t.alert_control&&(t.alert_control="4"),t["alert_num_"+t.alert_control]=e.times_after_close,t["recover_num_"+t.alert_control]=e.close_after_long_time_reset_amount,t["recover_unit_"+t.alert_control]=e.close_after_long_time_reset_unit)),t},filterOption:function(e,t){var n;return-1!==c()(n=t.props.children).call(n,e)},getParamsFromUrl:function(e){var t={},n=[],a="",r="",o=e.substring(c()(e).call(e,"?")+1,e.length).split("&");for(var l in o)a=(n=o[l].split("="))[0],r=n[1],t[a]=r;return t},jsonToQuery:function(e){var t;return e?function(e){for(var t=[],n=0;n<e.length;n++)e[n]&&t.push(e[n]);return t}(u()(t=p()(e)).call(t,(function(t){return void 0===e[t]?"":encodeURIComponent(t)+"="+encodeURIComponent(e[t])}))).join("&"):""},checkNullObj:function(e){return 0===p()(e).length},serviceCallback:function(e,t,n){0===e.data.code?(h.Z.success(t),n&&n()):h.Z.error(e.data.msg)},noAuthorityToDO:function(e,t){return!e[t]&&(h.Z.error("权限不足，请联系管理员!"),!0)},get k8sNamespace(){return g.get(v.E9.NAMESPACE)},setNaviKey:function(e,t){sessionStorage.setItem("firstLevelNav",e),sessionStorage.setItem("siderLevelNav",t)},formatGBUnit:function(e){return c()(e).call(e,"MB")>-1?f()(e.replace("MB",""))/1024:c()(e).call(e,"KB")>-1?f()(e.replace("KB",""))/1024/1024:c()(e).call(e,"GB")>-1?f()(e.replace("GB","")):c()(e).call(e,"TB")>-1?1024*f()(e.replace("TB","")):0}}}}]);